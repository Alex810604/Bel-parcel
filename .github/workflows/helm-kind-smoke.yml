name: helm-kind-smoke

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  smoke-operator-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          kubectl_version: v1.29.2
      - name: Install helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.3
      - name: Add curl pod
        run: kubectl run curl --image=curlimages/curl:8.5.0 --restart=Never --command -- sleep 3600
      - name: Deploy reference-db
        run: |
          helm upgrade --install refdb charts/reference-db --values charts/reference-db/values.yaml --set image.repository=postgres --set image.tag=16-alpine --set service.port=5432
          kubectl rollout status statefulset/refdb-reference-db --timeout=120s
      - name: Deploy operator-api
        run: |
          helm upgrade --install operator charts/operator-api \
            --values charts/operator-api/values.yaml \
            --set image.repository=ghcr.io/${{ github.repository_owner }}/bel-parcel/operator-api \
            --set image.tag=latest \
            --set secrets.operatorDsn=postgres://postgres:postgres@refdb-reference-db:5432/postgres?sslmode=disable \
            --set refmtls.enabled=\"false\" \
            --set kafka.brokers[0]=kafka:9092
          kubectl rollout status deployment/operator-operator-api --timeout=120s
      - name: Smoke healthz
        run: |
          kubectl exec curl -- curl -sS operator-operator-api:8090/healthz
