name: Helm Deploy
on:
  workflow_dispatch:
    inputs:
      namespace:
        description: Kubernetes namespace
        required: true
        default: bel-parcel
      charts:
        description: Space-separated chart names to deploy
        required: true
        default: "reference-db reference-service operator-api order-service routing-service batching-service tracking-service mobile-gateway reassignment-service"
permissions:
  contents: read
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.2
      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG_B64 }}
        run: |
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_B64" | base64 -d > "$HOME/.kube/config"
          kubectl version --client
          kubectl get ns
      - name: Deploy charts
        env:
          NAMESPACE: ${{ inputs.namespace }}
          CHARTS: ${{ inputs.charts }}
        run: |
          kubectl get ns "$NAMESPACE" >/dev/null 2>&1 || kubectl create ns "$NAMESPACE"
          for c in $CHARTS; do
            helm upgrade --install "$c" "./charts/$c" -n "$NAMESPACE"
          done
