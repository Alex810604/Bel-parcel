>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\batching-service\Chart.yaml
apiVersion: v2
name: batching-service
description: Helm chart for batching-service
type: application
version: 0.1.0
appVersion: "0.1.0"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\batching-service\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-batching-service
  labels:
    app: batching-service
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: batching-service
  template:
    metadata:
      labels:
        app: batching-service
    spec:
      containers:
      - name: batching-service
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8083
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_DSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-batching-service-secrets
              key: db_dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_GROUPID
          value: "{{ .Values.kafka.groupId }}"
        - name: KAFKA_CONSUMETOPICS
          value: "{{ .Values.kafka.consumeTopics | join \",\" }}"
        - name: KAFKA_PRODUCETOPIC
          value: "{{ .Values.kafka.produceTopic }}"
        - name: KAFKA_TIMEOUT
          value: "{{ .Values.kafka.timeout }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8083
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8083
          initialDelaySeconds: 5
        resources:
{{ toYaml .Values.resources | indent 10 }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ["batching-service"]
            topologyKey: "kubernetes.io/hostname"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\batching-service\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-batching-service-secrets
type: Opaque
stringData:
  db_dsn: "{{ .Values.secrets.dbDsn }}"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\batching-service\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-batching-service
  labels:
    app: batching-service
spec:
  type: ClusterIP
  selector:
    app: batching-service
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8083
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\batching-service\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/batching-service
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8083
kafka:
  brokers:
    - localhost:9092
  groupId: batching-service
  consumeTopics:
    - orders.created
  produceTopic: batches.formed
  timeout: 5s
otlp:
  endpoint: ""
secrets:
  dbDsn: postgres://user:pass@postgres:5432/batch_db?sslmode=disable
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\carrier-app\Chart.yaml
apiVersion: v2
name: carrier-app
description: Helm chart for carrier-app
type: application
version: 0.1.0
appVersion: "0.1.0"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\carrier-app\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-carrier-app
  labels:
    app: carrier-app
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: carrier-app
  template:
    metadata:
      labels:
        app: carrier-app
    spec:
      containers:
      - name: carrier-app
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8084
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_DSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-carrier-app-secrets
              key: db_dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_PICKEDUPTOPIC
          value: "{{ .Values.kafka.pickedUpTopic }}"
        - name: KAFKA_DELIVEREDTOPIC
          value: "{{ .Values.kafka.deliveredTopic }}"
        - name: KAFKA_TIMEOUT
          value: "{{ .Values.kafka.timeout }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8084
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8084
          initialDelaySeconds: 5
        resources:
{{ toYaml .Values.resources | indent 10 }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ["carrier-app"]
            topologyKey: "kubernetes.io/hostname"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\carrier-app\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-carrier-app-secrets
type: Opaque
stringData:
  db_dsn: "{{ .Values.secrets.dbDsn }}"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\carrier-app\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-carrier-app
  labels:
    app: carrier-app
spec:
  type: ClusterIP
  selector:
    app: carrier-app
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8084
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\carrier-app\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/carrier-app
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8084
kafka:
  brokers:
    - localhost:9092
  pickedUpTopic: events.batch_picked_up
  deliveredTopic: events.batch_delivered_to_pvp
  timeout: 5s
otlp:
  endpoint: ""
secrets:
  dbDsn: postgres://user:pass@postgres:5432/carrier_db?sslmode=disable
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\notification-service\Chart.yaml
apiVersion: v2
name: notification-service
description: Helm chart for notification-service
type: application
version: 0.1.0
appVersion: "0.1.0"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\notification-service\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-notification-service
  labels:
    app: notification-service
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: notification-service
  template:
    metadata:
      labels:
        app: notification-service
    spec:
      containers:
      - name: notification-service
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8086
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_BATCHDSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-notification-service-secrets
              key: batch_dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_GROUPID
          value: "{{ .Values.kafka.groupId }}"
        - name: KAFKA_CONSUMETOPIC
          value: "{{ .Values.kafka.consumeTopic }}"
        - name: KAFKA_TIMEOUT
          value: "{{ .Values.kafka.timeout }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        - name: TWILIO_ACCOUNT_SID
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-notification-service-secrets
              key: twilio_account_sid
        - name: TWILIO_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-notification-service-secrets
              key: twilio_auth_token
        - name: SENDGRID_API_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-notification-service-secrets
              key: sendgrid_api_key
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8086
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8086
          initialDelaySeconds: 5
        resources:
{{ toYaml .Values.resources | indent 10 }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ["notification-service"]
            topologyKey: "kubernetes.io/hostname"

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\notification-service\templates\networkpolicy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-notification-service
spec:
  podSelector:
    matchLabels:
      app: notification-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector: {}
  egress:
  - to:
    - podSelector: {}
    - namespaceSelector: {}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\notification-service\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-notification-service-secrets
type: Opaque
stringData:
  batch_dsn: "{{ .Values.secrets.batchDsn }}"
  twilio_account_sid: "{{ .Values.secrets.twilio.accountSID }}"
  twilio_auth_token: "{{ .Values.secrets.twilio.authToken }}"
  sendgrid_api_key: "{{ .Values.secrets.sendgrid.apiKey }}"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\notification-service\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-notification-service
  labels:
    app: notification-service
spec:
  type: ClusterIP
  selector:
    app: notification-service
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8086
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\notification-service\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/notification-service
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8086
kafka:
  brokers:
    - localhost:9092
  groupId: notification-service
  consumeTopic: events.batch_received_by_pvp
  timeout: 5s
otlp:
  endpoint: ""
secrets:
  batchDsn: postgres://user:pass@postgres:5432/batch_db?sslmode=disable
  twilio:
    accountSID: ""
    authToken: ""
  sendgrid:
    apiKey: ""
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\operator-api\Chart.yaml
apiVersion: v2
name: operator-api
description: Helm chart for operator-api
type: application
version: 0.1.0
appVersion: "0.1.0"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\operator-api\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-operator-api
  labels:
    app: operator-api
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: operator-api
  template:
    metadata:
      labels:
        app: operator-api
    spec:
      containers:
      - name: operator-api
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8090
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_TRIPDSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-operator-api-secrets
              key: trip_dsn
        - name: DB_BATCHDSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-operator-api-secrets
              key: batch_dsn
        - name: DB_REFERENCEDSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-operator-api-secrets
              key: reference_dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_COMMANDTOPIC
          value: "{{ .Values.kafka.commandTopic }}"
        - name: KAFKA_TIMEOUT
          value: "{{ .Values.kafka.timeout }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        - name: AUTH_HS256SECRET
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-operator-api-secrets
              key: auth_hs256secret
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8090
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8090
          initialDelaySeconds: 5
        resources:
{{ toYaml .Values.resources | indent 10 }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ["operator-api"]
            topologyKey: "kubernetes.io/hostname"

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\operator-api\templates\ingress.yaml
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}-operator-api
  annotations:
    {{- if and .Values.ingress.mtls.enabled .Values.ingress.mtls.secretName }}
    nginx.ingress.kubernetes.io/auth-tls-secret: "{{ .Release.Namespace }}/{{ .Values.ingress.mtls.secretName }}"
    nginx.ingress.kubernetes.io/auth-tls-verify-client: "on"
    nginx.ingress.kubernetes.io/auth-tls-verify-depth: "1"
    nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream: "true"
    {{- end }}
spec:
  rules:
  - host: {{ .Values.ingress.host }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ .Release.Name }}-operator-api
            port:
              number: {{ .Values.service.port }}
  {{- if .Values.ingress.tlsSecretName }}
  tls:
  - hosts:
    - {{ .Values.ingress.host }}
    secretName: {{ .Values.ingress.tlsSecretName }}
  {{- end }}
{{- end }}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\operator-api\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-operator-api-secrets
type: Opaque
stringData:
  trip_dsn: "{{ .Values.secrets.tripDsn }}"
  batch_dsn: "{{ .Values.secrets.batchDsn }}"
  reference_dsn: "{{ .Values.secrets.referenceDsn }}"
  auth_hs256secret: "{{ .Values.secrets.authHs256Secret }}"

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\operator-api\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-operator-api
  labels:
    app: operator-api
spec:
  type: ClusterIP
  selector:
    app: operator-api
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8090
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\operator-api\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/operator-api
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8090
kafka:
  brokers:
    - localhost:9092
  commandTopic: commands.trip.reassign
  timeout: 5s
otlp:
  endpoint: ""
ingress:
  enabled: true
  host: operator.example.com
  tlsSecretName: ""
  mtls:
    enabled: false
    secretName: ""
secrets:
  tripDsn: postgres://user:pass@postgres:5432/trip_db?sslmode=disable
  batchDsn: postgres://user:pass@postgres:5432/batch_db?sslmode=disable
  referenceDsn: postgres://user:pass@postgres:5432/reference_db?sslmode=disable
  authHs256Secret: ""
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\order-service\Chart.yaml
apiVersion: v2
name: order-service
version: 0.1.0
appVersion: 0.1.0


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\order-service\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-order-service
  labels:
    app: order-service
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
    spec:
      containers:
      - name: order-service
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8080
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_DSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-order-service-secrets
              key: db_dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_TOPIC
          value: "{{ .Values.kafka.topic }}"
        - name: KAFKA_GROUPID
          value: "{{ .Values.kafka.groupId }}"
        - name: KAFKA_CONSUMERTOPICS
          value: "{{ .Values.kafka.consumerTopics | join \",\" }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8080
          initialDelaySeconds: 5
        resources:
{{ toYaml .Values.resources | indent 10 }}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\order-service\templates\ingress.yaml
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}-order-service
spec:
  rules:
  - host: {{ .Values.ingress.host }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ .Release.Name }}-order-service
            port:
              number: {{ .Values.service.port }}
{{- end }}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\order-service\templates\networkpolicy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-order-service
spec:
  podSelector:
    matchLabels:
      app: order-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    - namespaceSelector: {}
  egress:
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 9092


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\order-service\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-order-service-secrets
type: Opaque
stringData:
  db_dsn: {{ .Values.secrets.dbDsn | quote }}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\order-service\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-order-service
  labels:
    app: order-service
spec:
  type: ClusterIP
  selector:
    app: order-service
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8080
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\order-service\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/order-service
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8080
ingress:
  enabled: true
  host: order.example.com
kafka:
  brokers:
    - localhost:9092
  topic: orders.created
  groupId: order-service
  consumerTopics:
    - batches.formed
    - events.batch_picked_up
    - events.batch_delivered_to_pvp
    - events.batch_received_by_pvp
otlp:
  endpoint: ""
secrets:
  dbDsn: postgres://user:pass@postgres:5432/order_db?sslmode=disable
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\pickup-point-service\Chart.yaml
apiVersion: v2
name: pickup-point-service
description: Helm chart for pickup-point-service
type: application
version: 0.1.0
appVersion: "0.1.0"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\pickup-point-service\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-pickup-point-service
  labels:
    app: pickup-point-service
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: pickup-point-service
  template:
    metadata:
      labels:
        app: pickup-point-service
    spec:
      containers:
      - name: pickup-point-service
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8085
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_DSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-pickup-point-service-secrets
              key: db_dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_TOPIC
          value: "{{ .Values.kafka.topic }}"
        - name: KAFKA_TIMEOUT
          value: "{{ .Values.kafka.timeout }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8085
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8085
          initialDelaySeconds: 5
        resources:
{{ toYaml .Values.resources | indent 10 }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ["pickup-point-service"]
            topologyKey: "kubernetes.io/hostname"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\pickup-point-service\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-pickup-point-service-secrets
type: Opaque
stringData:
  db_dsn: "{{ .Values.secrets.dbDsn }}"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\pickup-point-service\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-pickup-point-service
  labels:
    app: pickup-point-service
spec:
  type: ClusterIP
  selector:
    app: pickup-point-service
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8085
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\pickup-point-service\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/pickup-point-service
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8085
kafka:
  brokers:
    - localhost:9092
  topic: events.batch_received_by_pvp
  timeout: 5s
otlp:
  endpoint: ""
secrets:
  dbDsn: postgres://user:pass@postgres:5432/pvp_db?sslmode=disable
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\routing-service\Chart.yaml
apiVersion: v2
name: routing-service
version: 0.1.0
appVersion: 0.1.0

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\routing-service\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-routing-service
  labels:
    app: routing-service
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: routing-service
  template:
    metadata:
      labels:
        app: routing-service
    spec:
      containers:
      - name: routing-service
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8081
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_TRIPDSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-routing-service-secrets
              key: trip_dsn
        - name: DB_REFDSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-routing-service-secrets
              key: ref_dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_TIMEOUT
          value: "{{ .Values.kafka.timeout }}"
        - name: KAFKA_GROUPID
          value: "{{ .Values.kafka.groupId }}"
        - name: KAFKA_CONSUMETOPICS
          value: "{{ .Values.kafka.consumeTopics | join \",\" }}"
        - name: KAFKA_PRODUCETOPIC
          value: "{{ .Values.kafka.produceTopic }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
        resources:
{{ toYaml .Values.resources | indent 10 }}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\routing-service\templates\ingress.yaml
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}-routing-service
spec:
  rules:
  - host: {{ .Values.ingress.host }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ .Release.Name }}-routing-service
            port:
              number: {{ .Values.service.port }}
{{- end }}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\routing-service\templates\networkpolicy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-routing-service
spec:
  podSelector:
    matchLabels:
      app: routing-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    - namespaceSelector: {}
  egress:
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 9092


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\routing-service\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-routing-service-secrets
type: Opaque
stringData:
  trip_dsn: {{ .Values.secrets.tripDsn | quote }}
  ref_dsn: {{ .Values.secrets.refDsn | quote }}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\routing-service\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-routing-service
  labels:
    app: routing-service
spec:
  type: ClusterIP
  selector:
    app: routing-service
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8081
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\routing-service\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/routing-service
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8081
ingress:
  enabled: true
  host: routing.example.com
kafka:
  brokers:
    - localhost:9092
  timeout: 5s
  groupId: routing-service
  consumeTopics:
    - batches.formed
  produceTopic: trips.assigned
otlp:
  endpoint: ""
secrets:
  tripDsn: postgres://user:pass@postgres:5432/trip_db?sslmode=disable
  refDsn: postgres://user:pass@postgres:5432/reference_db?sslmode=disable
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\tracking-service\Chart.yaml
apiVersion: v2
name: tracking-service
description: Helm chart for tracking-service
type: application
version: 0.1.0
appVersion: "0.1.0"


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\tracking-service\templates\deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-tracking-service
  labels:
    app: tracking-service
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: tracking-service
  template:
    metadata:
      labels:
        app: tracking-service
    spec:
      containers:
      - name: tracking-service
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - containerPort: 8087
        env:
        - name: SERVER_PORT
          value: "{{ .Values.service.port }}"
        - name: DB_DSN
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-tracking-service-secrets
              key: dsn
        - name: KAFKA_BROKERS
          value: "{{ .Values.kafka.brokers | join \",\" }}"
        - name: KAFKA_GROUPID
          value: "{{ .Values.kafka.groupId }}"
        - name: KAFKA_TOPIC
          value: "{{ .Values.kafka.topic }}"
        - name: KAFKA_TIMEOUT
          value: "{{ .Values.kafka.timeout }}"
        - name: OTLP_ENDPOINT
          value: "{{ .Values.otlp.endpoint }}"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8087
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8087
          initialDelaySeconds: 5
        resources:
{{ toYaml .Values.resources | indent 10 }}
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ["tracking-service"]
            topologyKey: "kubernetes.io/hostname"

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\tracking-service\templates\ingress.yaml
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}-tracking-service
spec:
  rules:
  - host: {{ .Values.ingress.host }}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ .Release.Name }}-tracking-service
            port:
              number: {{ .Values.service.port }}
  {{- if .Values.ingress.tlsSecretName }}
  tls:
  - hosts:
    - {{ .Values.ingress.host }}
    secretName: {{ .Values.ingress.tlsSecretName }}
  {{- end }}
{{- end }}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\tracking-service\templates\networkpolicy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ .Release.Name }}-tracking-service
spec:
  podSelector:
    matchLabels:
      app: tracking-service
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: operator-api
    ports:
    - protocol: TCP
      port: {{ .Values.service.port }}
  egress:
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 9092

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\tracking-service\templates\secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-tracking-service-secrets
type: Opaque
stringData:
  dsn: "{{ .Values.secrets.dsn }}"

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\tracking-service\templates\service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-tracking-service
  labels:
    app: tracking-service
spec:
  type: ClusterIP
  selector:
    app: tracking-service
  ports:
  - port: {{ .Values.service.port }}
    targetPort: 8087
    protocol: TCP
    name: http


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\charts\tracking-service\values.yaml
replicaCount: 2
image:
  repository: registry.example.com/tracking-service
  tag: v0.1.0
  pullPolicy: IfNotPresent
service:
  port: 8087
kafka:
  brokers:
    - localhost:9092
  groupId: tracking-service
  topic: events.carrier_location
  timeout: 5s
otlp:
  endpoint: ""
secrets:
  dsn: postgres://user:pass@postgres:5432/trip_db?sslmode=disable
resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "256Mi"
    cpu: "200m"
ingress:
  enabled: false
  host: tracking.local
  tlsSecretName: ""
tracking:
  image: bel-parcel/tracking-service:latest
  port: 8087
  env:
    KAFKA_TOPIC: "events.carrier_location"

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\docs\explanatory-note.md
Title: РџРѕСЏСЃРЅРёС‚РµР»СЊРЅР°СЏ Р·Р°РїРёСЃРєР° РїРѕ РїСЂРѕРµРєС‚Сѓ BelParcel

Table of Contents
- 0. РЎСѓС‚СЊ РїСЂРѕРµРєС‚Р° РїСЂРѕСЃС‚С‹РјРё СЃР»РѕРІР°РјРё
- 1. РћР±С‰Р°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° РїСЂРѕРµРєС‚Р°
- 2. Р”РµС‚Р°Р»СЊРЅРѕРµ РѕРїРёСЃР°РЅРёРµ СЂР°Р·РґРµР»РѕРІ
- 3. РџРѕР»РЅРѕРµ РѕРїРёСЃР°РЅРёРµ СЂР°Р±РѕС‚С‹ СЃРёСЃС‚РµРјС‹
- 4. РўСЂРµР±РѕРІР°РЅРёСЏ Рє РѕРєСЂСѓР¶РµРЅРёСЋ (environment)
- 5. FAQ (Frequently Asked Questions)
- 6. РџСЂРёР»РѕР¶РµРЅРёСЏ: РґРёР°РіСЂР°РјРјС‹ Рё СЃС…РµРјС‹
 - 7. Р’Р°СЂРёР°РЅС‚С‹ СЂРµС€РµРЅРёР№ РїСЂРё РїРѕР»РѕРјРєРµ РјР°С€РёРЅС‹
 - 8. РџРµСЂРµРіСЂСѓР·РєР° С‚РѕРІР°СЂР°: РєР°Рє СЌС‚Рѕ РґРµР»Р°С‚СЊ Рё Р°РІС‚РѕРјР°С‚РёР·РёСЂРѕРІР°С‚СЊ
 - 9. РџРѕС€Р°РіРѕРІС‹Рµ РёРЅСЃС‚СЂСѓРєС†РёРё РґР»СЏ РєР°Р¶РґРѕРіРѕ СЃРµСЂРІРёСЃР°
 - 10. Р Р°Р±РѕС‚Р° СЃ РїР°СЂРѕР»СЏРјРё
 - 11. РЎРёСЃС‚РµРјР° РґРѕСЃС‚СѓРїР°
 - 12. РРЅС‚РµРіСЂР°С†РёРё
 - 13. РўРµС…РЅРёС‡РµСЃРєРѕРµ СЂСѓРєРѕРІРѕРґСЃС‚РІРѕ (РєРѕСЂРѕС‚РєРѕ Рё РїРѕ РґРµР»Сѓ)

0. РЎСѓС‚СЊ РїСЂРѕРµРєС‚Р° РїСЂРѕСЃС‚С‹РјРё СЃР»РѕРІР°РјРё
- Р§С‚Рѕ СЌС‚Рѕ
  - BelParcel вЂ” СЃРёСЃС‚РµРјР°, РєРѕС‚РѕСЂР°СЏ РѕСЂРіР°РЅРёР·СѓРµС‚ РґРѕСЃС‚Р°РІРєСѓ РїРѕСЃС‹Р»РѕРє СЃРѕ СЃРєР»Р°РґР° РґРѕ РїСѓРЅРєС‚Р° РІС‹РґР°С‡Рё. РћРЅР° РїРѕРјРѕРіР°РµС‚ РѕРїРµСЂР°С‚РѕСЂР°Рј, РїРµСЂРµРІРѕР·С‡РёРєР°Рј Рё СЃРѕС‚СЂСѓРґРЅРёРєР°Рј РїСѓРЅРєС‚РѕРІ СЂР°Р±РѕС‚Р°С‚СЊ СЃРѕРіР»Р°СЃРѕРІР°РЅРЅРѕ, С‡С‚РѕР±С‹ РїРѕСЃС‹Р»РєРё РїСЂРёС…РѕРґРёР»Рё РІРѕРІСЂРµРјСЏ.
- РљР°РєРёРµ РІРѕРїСЂРѕСЃС‹ Р·Р°РєСЂС‹РІР°РµС‚
  - РљР°Рє Р±С‹СЃС‚СЂРѕ СЃРѕР±СЂР°С‚СЊ РїРѕСЃС‹Р»РєРё РІ СѓРґРѕР±РЅС‹Рµ РґР»СЏ РїРµСЂРµРІРѕР·РєРё РїР°СЂС‚РёРё.
  - РљР°Рє РЅР°Р·РЅР°С‡РёС‚СЊ РїРѕРґС…РѕРґСЏС‰РµРіРѕ РїРµСЂРµРІРѕР·С‡РёРєР° РЅР° СЂРµР№СЃ Рё РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё Р·Р°РјРµРЅРёС‚СЊ РµРіРѕ.
  - РљР°Рє РІРёРґРµС‚СЊ Р·Р°РґРµСЂР¶РєРё Рё РІРѕРІСЂРµРјСЏ РЅР° РЅРёС… СЂРµР°РіРёСЂРѕРІР°С‚СЊ.
  - РљР°Рє СѓРїРѕСЂСЏРґРѕС‡РµРЅРЅРѕ РїСЂРёРЅРёРјР°С‚СЊ РїР°СЂС‚РёРё РІ РїСѓРЅРєС‚Рµ РІС‹РґР°С‡Рё.
  - РљР°Рє РІРµСЃС‚Рё СѓС‡С‘С‚ РґРµР№СЃС‚РІРёР№ Рё РёР·РјРµРЅРµРЅРёР№ Р±РµР· РїСѓС‚Р°РЅРёС†С‹.
- РљР°Рє СЌС‚Рѕ СЂР°Р±РѕС‚Р°РµС‚ РІРЅСѓС‚СЂРё
  - Р•СЃС‚СЊ РЅРµСЃРєРѕР»СЊРєРѕ РѕС‚РґРµР»СЊРЅС‹С… СЃР»СѓР¶Р±. РљР°Р¶РґР°СЏ Р·Р°РЅРёРјР°РµС‚СЃСЏ СЃРІРѕРµР№ С‡Р°СЃС‚СЊСЋ: РѕРґРЅР° РѕС‚РІРµС‡Р°РµС‚ Р·Р° Р·Р°РєР°Р·С‹, РґСЂСѓРіР°СЏ СЃРѕР±РёСЂР°РµС‚ РїР°СЂС‚РёРё, С‚СЂРµС‚СЊСЏ РїРѕРјРѕРіР°РµС‚ РЅР°Р·РЅР°С‡Р°С‚СЊ Рё РјРµРЅСЏС‚СЊ РїРµСЂРµРІРѕР·С‡РёРєР°, РµС‰С‘ РѕРґРЅР° С„РёРєСЃРёСЂСѓРµС‚ РїСЂРёС‘Рј РїР°СЂС‚РёР№ РІ РїСѓРЅРєС‚Рµ РІС‹РґР°С‡Рё.
  - РЎР»СѓР¶Р±С‹ РѕР±РјРµРЅРёРІР°СЋС‚СЃСЏ СЃРѕРѕР±С‰РµРЅРёСЏРјРё: РєРѕРіРґР° РїСЂРѕРёСЃС…РѕРґРёС‚ РІР°Р¶РЅРѕРµ СЃРѕР±С‹С‚РёРµ (СЃРѕР·РґР°РЅ Р·Р°РєР°Р·, СЃС„РѕСЂРјРёСЂРѕРІР°РЅР° РїР°СЂС‚РёСЏ, РїР°СЂС‚РёСЏ РїСЂРёРЅСЏС‚Р°), РѕР± СЌС‚РѕРј СѓР·РЅР°СЋС‚ РґСЂСѓРіРёРµ С‡Р°СЃС‚Рё СЃРёСЃС‚РµРјС‹ Рё РІС‹РїРѕР»РЅСЏСЋС‚ СЃРІРѕРё Р·Р°РґР°С‡Рё.
  - Р”Р°РЅРЅС‹Рµ С…СЂР°РЅСЏС‚СЃСЏ РІ Р±Р°Р·Рµ. РЎР»СѓР¶Р±С‹ С‡РёС‚Р°СЋС‚ Рё Р·Р°РїРёСЃС‹РІР°СЋС‚ СЂРѕРІРЅРѕ С‚Рѕ, С‡С‚Рѕ РёРј РЅСѓР¶РЅРѕ, РЅРµ РјРµС€Р°СЏ РґСЂСѓРі РґСЂСѓРіСѓ.
  - Р”Р»СЏ РѕРїРµСЂР°С‚РѕСЂР° РµСЃС‚СЊ РѕС‚РґРµР»СЊРЅС‹Р№ СѓРґРѕР±РЅС‹Р№ РёРЅС‚РµСЂС„РµР№СЃ: РѕРЅ РІРёРґРёС‚ СЂРµР№СЃС‹, РґРµС‚Р°Р»Рё, Р·Р°РґРµСЂР¶РєРё, СЃРїСЂР°РІРѕС‡РЅРёРєРё Рё РјРѕР¶РµС‚ РїРµСЂРµРЅР°Р·РЅР°С‡РёС‚СЊ РїРµСЂРµРІРѕР·С‡РёРєР°.
  - РЎРёСЃС‚РµРјР° РЅР°Р±Р»СЋРґР°РµС‚ Р·Р° СЃРѕР±РѕР№: Р·Р°РїРёСЃС‹РІР°РµС‚ СЂР°Р±РѕС‚Сѓ, РїРѕРєР°Р·С‹РІР°РµС‚ РіСЂР°С„РёРєРё Рё РїСЂРµРґСѓРїСЂРµР¶РґР°РµС‚, РµСЃР»Рё С†РµР»Рё РїРѕ СЃРєРѕСЂРѕСЃС‚Рё Рё РґРѕСЃС‚СѓРїРЅРѕСЃС‚Рё РЅР°С‡РёРЅР°СЋС‚ РЅРµ РІС‹РїРѕР»РЅСЏС‚СЊСЃСЏ.

1. РћР±С‰Р°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° РїСЂРѕРµРєС‚Р°
- РРµСЂР°СЂС…РёСЏ РјРѕРґСѓР»РµР№ Рё РІР·Р°РёРјРѕСЃРІСЏР·Рё
  - services: РјРёРєСЂРѕСЃРµСЂРІРёСЃС‹ РЅР° Go (РіРѕ)
    - operator-api: API РґР»СЏ РѕРїРµСЂР°С‚РѕСЂРѕРІ [operator-api/main.go](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/cmd/operator-api/main.go)
    - order-service: СѓРїСЂР°РІР»РµРЅРёРµ Р·Р°РєР°Р·Р°РјРё [order-service/main.go](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/order-service/cmd/order-service/main.go)
    - batching-service: С„РѕСЂРјРёСЂРѕРІР°РЅРёРµ РїР°СЂС‚РёР№ [batching-service](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/batching-service)
    - routing-service: РјР°СЂС€СЂСѓС‚РёР·Р°С†РёСЏ [routing-service](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/routing-service)
    - reassignment-service: РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёСЏ РїРµСЂРµРІРѕР·С‡РёРєР° [reassignment-service](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/reassignment-service)
    - pickup-point-service: РѕРїРµСЂР°С†РёРё РџР’Р— [pickup-point-service/main.go](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/pickup-point-service/cmd/pickup-point-service/main.go)
  - web: С„СЂРѕРЅС‚РµРЅРґ SPA (СЌСЃ-РїРё-СЌР№) РЅР° React (СЂРёСЌРєС‚) [operator-panel](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/web/operator-panel)
  - charts: Helm (С…РµР»Рј) С‡Р°СЂС‚С‹ РґР»СЏ РґРµРїР»РѕСЏ [charts/operator-api](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/charts/operator-api)
- РџСЂРёРЅС†РёРїС‹ РѕСЂРіР°РЅРёР·Р°С†РёРё РєРѕРґРѕРІРѕР№ Р±Р°Р·С‹ (codebase)
  - РЎС‚СЂСѓРєС‚СѓСЂР° РґРёСЂРµРєС‚РѕСЂРёР№: РєР°Р¶РґРѕРµ РїСЂРёР»РѕР¶РµРЅРёРµ РІ РѕС‚РґРµР»СЊРЅРѕР№ РїР°РїРєРµ, cmd/internal СЂР°Р·Р±РёРµРЅРёРµ РґР»СЏ Go (РіРѕ)
  - РРјРїРѕСЂС‚С‹ Рё РёРјРµРЅРѕРІР°РЅРёРµ: lower-case РјРѕРґСѓР»СЊРЅС‹Рµ РїСѓС‚Рё, Р±РµР· РїРѕРґС‡РµСЂРєРёРІР°РЅРёР№; handler/service/infra
  - РЎРёСЃС‚РµРјР° РєРѕРЅС‚СЂРѕР»СЏ РІРµСЂСЃРёР№ (version control): Git (РіРёС‚), РІРµС‚РІР»РµРЅРёРµ РїРѕ feature/hotfix, pull-request (РїСѓР»-СЂРµРєРІРµСЃС‚)
- Р”РёР°РіСЂР°РјРјР° РєРѕРјРїРѕРЅРµРЅС‚РѕРІ (UML Component Diagram)
  - Р”РёР°РіСЂР°РјРјР° РёР»Р»СЋСЃС‚СЂРёСЂСѓРµС‚ РѕР±РјРµРЅ С‡РµСЂРµР· Kafka (РєР°С„РєР°) Рё РґРѕСЃС‚СѓРї Рє PostgreSQL (РїРѕСЃС‚РіСЂРµСЃ)
  - РљРѕРјРїРѕРЅРµРЅС‚С‹: Services, Kafka, PostgreSQL, Grafana (РіСЂР°С„Р°РЅР°), Prometheus (РїСЂРѕРјРµС‚РµСѓСЃ), Jaeger (СЏРµРіРµСЂ), Loki (Р»РѕРєРё), Kubernetes (РєСѓР±РµСЂРЅРµС‚РёСЃ)
  - Mermaid:
    ```mermaid
    graph LR
      subgraph Services
        A[operator-api]
        B[order-service]
        C[batching-service]
        D[routing-service]
        E[reassignment-service]
        F[pickup-point-service]
      end
      K[(Kafka)]
      P[(PostgreSQL)]
      G[Grafana]
      M[Prometheus]
      J[Jaeger]
      L[Loki]
      A--commands-->K
      B--events-->K
      C--events-->K
      D--events-->K
      E--events-->K
      F--events-->K
      A--read-->P
      B--read/write-->P
      C--read/write-->P
      F--read/write-->P
      M-->G
      Services-->J
      Services-->L
    ```

2. Р”РµС‚Р°Р»СЊРЅРѕРµ РѕРїРёСЃР°РЅРёРµ СЂР°Р·РґРµР»РѕРІ
- РќР°Р·РЅР°С‡РµРЅРёРµ РјРѕРґСѓР»РµР№
  - operator-api: UI-РѕСЂРёРµРЅС‚РёСЂРѕРІР°РЅРЅС‹Р№ API РґР»СЏ РѕРїРµСЂР°С‚РѕСЂР°, РїСЂРѕСЃРјРѕС‚СЂ СЂРµР№СЃРѕРІ, РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ РїРµСЂРµРІРѕР·С‡РёРєР°, Р·Р°РґРµСЂР¶РєРё, СЃРїСЂР°РІРѕС‡РЅРёРєРё
  - order-service: РіРµРЅРµСЂР°С†РёСЏ Рё Р¶РёР·РЅРµРЅРЅС‹Р№ С†РёРєР» Р·Р°РєР°Р·РѕРІ
  - batching-service: РіСЂСѓРїРїРёСЂРѕРІРєР° Р·Р°РєР°Р·РѕРІ РІ РїР°СЂС‚РёРё
  - routing-service: СЂР°СЃС‡С‘С‚ РјР°СЂС€СЂСѓС‚РѕРІ Рё СЂРµР№СЃРѕРІ
  - reassignment-service: РѕР±СЂР°Р±РѕС‚РєР° РєРѕРјР°РЅРґ РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёСЏ
  - pickup-point-service: РїСЂРёС‘Рј РїР°СЂС‚РёР№ РІ РџР’Р—, С„РёРєСЃР°С†РёСЏ СЃС‚Р°С‚СѓСЃР°
- РўРµС…РЅРѕР»РѕРіРёС‡РµСЃРєРёР№ СЃС‚РµРє (tech stack)
  - РЇР·С‹РєРё: Go (РіРѕ) 1.24.0; TypeScript (С‚Р°Р№РїСЃРєСЂРёРїС‚) 5.6.3
  - Р‘РёР±Р»РёРѕС‚РµРєРё: pgx/v5 (РїРёРі-РёРєСЃ), kafka-go (РєР°С„РєР°-РіРѕ), viper (РІР°Р№РїРµСЂ), OpenTelemetry (РѕСѓРїРµРЅС‚РµР»РµРјРµС‚СЂРё) v1.39.0, Prometheus client (РїСЂРѕРјРµС‚РµСѓСЃ РєР»РёРµРЅС‚) v1.23.2, JWT (РґР¶РµР№-РґР°Р±Р»-СЋ-С‚Рё) v5.3.0, MUI (СЌРј-СЋ-Р°Р№) 5.15.14, React (СЂРёСЌРєС‚) 18.2, Vite (РІР°Р№С‚) 5.0.12
  - Р’РЅРµС€РЅРёРµ СЃРµСЂРІРёСЃС‹: Apache Kafka (Р°РїР°С‡ РєР°С„РєР°), PostgreSQL (РїРѕСЃС‚РіСЂРµСЃ), Grafana (РіСЂР°С„Р°РЅР°), Prometheus (РїСЂРѕРјРµС‚РµСѓСЃ), Jaeger (СЏРµРіРµСЂ), Loki (Р»РѕРєРё), Kubernetes (РєСѓР±РµСЂРЅРµС‚РёСЃ), Helm (С…РµР»Рј)
- РЎС…РµРјС‹ РІР·Р°РёРјРѕРґРµР№СЃС‚РІРёСЏ (sequence diagrams)
  - РџРѕС‚РѕРє: Р—Р°РєР°Р· в†’ РџР°СЂС‚РёСЏ в†’ Р РµР№СЃ в†’ Р”РѕСЃС‚Р°РІРєР°:
    ```mermaid
    sequenceDiagram
      participant User as РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ
      participant Order as order-service
      participant Batch as batching-service
      participant Route as routing-service
      participant Carrier as carrier-app
      participant PVP as pickup-point-service
      User->>Order: РЎРѕР·РґР°С‚СЊ Р·Р°РєР°Р·
      Order-->>Kafka: events.order_created
      Kafka-->>Batch: consume order_created
      Batch-->>Kafka: events.batch_formed
      Kafka-->>Route: consume batch_formed
      Route-->>Carrier: РќР°Р·РЅР°С‡РёС‚СЊ РїРµСЂРµРІРѕР·С‡РёРєР°
      Carrier-->>PVP: Р”РѕСЃС‚Р°РІРёС‚СЊ РїР°СЂС‚РёСЋ
      PVP-->>Kafka: events.batch_received_by_pvp
    ```
  - РџРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ РїРµСЂРµРІРѕР·С‡РёРєР°:
    ```mermaid
    sequenceDiagram
      participant Operator as operator-api
      participant Kafka as Kafka
      participant Reassign as reassignment-service
      Operator->>Kafka: commands.trip.reassign
      Kafka-->>Reassign: consume reassign
      Reassign->>Carrier: РќР°Р·РЅР°С‡РёС‚СЊ РЅРѕРІРѕРіРѕ РїРµСЂРµРІРѕР·С‡РёРєР°
    ```
- РљР»СЋС‡РµРІС‹Рµ Р°Р»РіРѕСЂРёС‚РјС‹
  - Р¤РѕСЂРјРёСЂРѕРІР°РЅРёРµ РїР°СЂС‚РёР№: РіСЂСѓРїРїРёСЂРѕРІРєР° РїРѕ (СЃРєР»Р°Рґ, РџР’Р—), СЂР°Р·РјРµСЂ/РІСЂРµРјСЏ С„Р»Р°С€РёРЅРіР°
    - РџСЃРµРІРґРѕРєРѕРґ:
      ```
      // РЎРѕР±С‹С‚РёРµ Р·Р°РєР°Р·РѕРІ -> РіСЂСѓРїРїРёСЂРѕРІРєР° РІ РєР°СЂС‚Сѓ РїРѕ РєР»СЋС‡Сѓ (warehouseID, pvpID)
      // Р•СЃР»Рё СЂР°Р·РјРµСЂ >= maxSize РёР»Рё flushInterval РёСЃС‚С‘Рє -> СЃС„РѕСЂРјРёСЂРѕРІР°С‚СЊ РїР°СЂС‚РёСЋ
      ```
  - РџРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ: РїСѓР±Р»РёРєР°С†РёСЏ envelope (СЌРЅРІРµР»РѕСѓРї) РІ Kafka (РєР°С„РєР°) СЃ event_id, correlation_id
  - РњРѕРЅРёС‚РѕСЂРёРЅРі Р·Р°РґРµСЂР¶РµРє: РІС‹Р±РѕСЂРєР° РёР· trips РїРѕ NOW()-assigned_at > threshold
- РћСЃРѕР±РµРЅРЅРѕСЃС‚Рё СЂРµР°Р»РёР·Р°С†РёРё
  - РџР°С‚С‚РµСЂРЅС‹: middleware (РјРёРґР»РІСЌР№СЂ) РґР»СЏ JWT (РґР¶РµР№-РґР°Р±Р»-СЋ-С‚Рё), producer (РїСЂРѕРґСЊСЋСЃРµСЂ) РґР»СЏ Kafka, graceful shutdown (РіСЂРµР№СЃС„СѓР» С€Р°С‚РґР°СѓРЅ), structured logging (СЃС‚СЂСѓРєС‚СѓСЂРёСЂРѕРІР°РЅРЅС‹Р№ Р»РѕРіРіРёРЅРі)
  - РќРµСЃС‚Р°РЅРґР°СЂС‚РЅС‹Рµ СЂРµС€РµРЅРёСЏ: РґРІРѕР№РЅР°СЏ Р·Р°С‰РёС‚Р° РїСѓР±Р»РёРєР°С†РёР№ С‡РµСЂРµР· С‚Р°Р±Р»РёС†Сѓ published_events (РїР°Р±Р»РёС€Рґ_РёРІРµРЅС‚СЃ) РѕС‚ РґСѓР±Р»РёСЂРѕРІР°РЅРёСЏ

3. РџРѕР»РЅРѕРµ РѕРїРёСЃР°РЅРёРµ СЂР°Р±РѕС‚С‹ СЃРёСЃС‚РµРјС‹
- РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ
  - Р—Р°РіСЂСѓР·РєР° РєРѕРЅС„РёРіСѓСЂР°С†РёРё С‡РµСЂРµР· viper (РІР°Р№РїРµСЂ) [config.go](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/internal/config/config.go)
  - РРЅРёС†РёР°Р»РёР·Р°С†РёСЏ OTLP (Рѕ-С‚Рё-СЌР»-РїРё) Рё С‚СЂРµР№СЃРµСЂР° [operator-api](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/cmd/operator-api/main.go#L222-L247)
  - РќР°СЃС‚СЂРѕР№РєР° РїСѓР»Р° Р‘Р” (РїРѕСЃС‚РіСЂРµСЃ), РїСЂРѕРґСЊСЋСЃРµСЂР° Kafka (РєР°С„РєР°), СЃРµСЂРІРёСЃ-СЃР»РѕСЏ
- Р—Р°РїСѓСЃРє HTTP (СЌР№С‡-С‚Рё-С‚Рё-РїРё)
  - Р РµРіРёСЃС‚СЂР°С†РёСЏ С…РµРЅРґР»РµСЂРѕРІ, healthz/readyz, /metrics (РїСЂРѕРјРµС‚РµСѓСЃ)
  - JWT (РґР¶РµР№-РґР°Р±Р»-СЋ-С‚Рё) Рё RBAC (СЌСЂ-Р±Рё-СЌР№-СЃРё) РѕР±С‘СЂС‚РєР° RequireRoles [auth.go](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/internal/auth/auth.go)
- Workflow (РІРѕСЂРєС„Р»РѕСѓ)
  - РџСЂРѕСЃРјРѕС‚СЂ СЂРµР№СЃРѕРІ, РґРµС‚Р°Р»РёР·Р°С†РёСЏ, РјРѕРЅРёС‚РѕСЂРёРЅРі Р·Р°РґРµСЂР¶РµРє, РїРѕРёСЃРєРё СЃРїСЂР°РІРѕС‡РЅРёРєРѕРІ
  - РџРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ С‚СЂРµР±СѓРµС‚ СЂРѕР»Рё moderator/admin (РјРѕРґРµСЂР°С‚РѕСЂ/Р°РґРјРёРЅ), РѕРїРµСЂР°С‚РѕСЂ Р±РµСЂС‘С‚СЃСЏ РёР· subject (СЃР°Р±РґР¶РµРєС‚) С‚РѕРєРµРЅР°
- Error handling (СЌСЂСЂРѕСЂ С…СЌРЅРґР»РёРЅРі)
  - Р’Р°Р»РёРґРЅС‹Рµ РєРѕРґС‹: 200, 202; РѕС€РёР±РєРё: 400 (РІР°Р»РёРґР°С†РёСЏ), 401/403 (Р°РІС‚РѕСЂРёР·Р°С†РёСЏ), 404 (РЅРµ РЅР°Р№РґРµРЅРѕ), 500 (РІРЅСѓС‚СЂРµРЅРЅРёРµ)
  - Р›РѕРіРёСЂРѕРІР°РЅРёРµ СЃС‚СЂСѓРєС‚СѓСЂРёСЂРѕРІР°РЅРѕ; РѕС€РёР±РєРё РїРµСЂРµС…РІР°С‚С‹РІР°СЋС‚СЃСЏ РІ С…РµРЅРґР»РµСЂР°С…
- Graceful shutdown (РіСЂРµР№СЃС„СѓР» С€Р°С‚РґР°СѓРЅ)
  - РЎРёРіРЅР°Р»С‹ SIGTERM/SIGINT; shutdown СЃ С‚Р°Р№РјР°СѓС‚РѕРј 5s

4. РўСЂРµР±РѕРІР°РЅРёСЏ Рє РѕРєСЂСѓР¶РµРЅРёСЋ (environment)
- РњРёРЅРёРјР°Р»СЊРЅС‹Рµ/СЂРµРєРѕРјРµРЅРґСѓРµРјС‹Рµ
  - РћРЎ: Linux (Р»РёРЅСѓРєСЃ)/Windows (РІРёРЅРґРѕР·) 64-bit
  - CPU: 2/4 СЏРґСЂР° РјРёРЅРёРјСѓРј; СЂРµРєРѕРјРµРЅРґРѕРІР°РЅРѕ 8+ РґР»СЏ РїСЂРѕРґР°РєС€РЅ
  - RAM: РјРёРЅРёРјСѓРј 2 Р“Р‘; СЂРµРєРѕРјРµРЅРґРѕРІР°РЅРѕ 8вЂ“16 Р“Р‘
  - Р”РёСЃРє: РјРёРЅРёРјСѓРј 5 Р“Р‘; СЂРµРєРѕРјРµРЅРґРѕРІР°РЅРѕ 50+ Р“Р‘ (Kafka/PostgreSQL)
- Р—Р°РІРёСЃРёРјРѕСЃС‚Рё (dependencies)
  - Go (РіРѕ) 1.24.0; Node.js (РЅРѕСѓРґ-РґР¶СЃ) 18+
  - PostgreSQL (РїРѕСЃС‚РіСЂРµСЃ) 14+; Kafka (РєР°С„РєР°) 3.x
  - Prometheus (РїСЂРѕРјРµС‚РµСѓСЃ) 2.49+; Grafana (РіСЂР°С„Р°РЅР°) 10+
  - Jaeger (СЏРµРіРµСЂ), Loki (Р»РѕРєРё), Kubernetes (РєСѓР±РµСЂРЅРµС‚РёСЃ) 1.27+
  - Helm (С…РµР»Рј) 3.x
- РќР°СЃС‚СЂРѕР№РєР° РѕРєСЂСѓР¶РµРЅРёСЏ
  - Dev (РґРµРІ): Р·Р°РїСѓСЃРє Р»РѕРєР°Р»СЊРЅРѕ, РїРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ С‡РµСЂРµР· .env; Vite (РІР°Р№С‚) РґР»СЏ SPA
  - Prod (РїСЂРѕРґР°РєС€РЅ): РґРµРїР»РѕР№ Helm (С…РµР»Рј) С‡Р°СЂС‚РѕРІ, Ingress (РёРЅРіСЂРµСЃСЃ) TLS/mTLS, СЃРµРєСЂРµС‚С‹ Р‘Р” Рё auth
  - РџСЂРёРјРµСЂС‹ Р·РЅР°С‡РµРЅРёР№: [values.yaml](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/charts/operator-api/values.yaml)

5. FAQ (Frequently Asked Questions)
- РЈСЃС‚Р°РЅРѕРІРєР° (installation)
  - РЎР±РѕСЂРєР°: go build ./..., npm install && npm run build
  - Р”РµРїР»РѕР№: helm install -f values.yaml
- РќР°СЃС‚СЂРѕР№РєР° (configuration)
  - JWT (РґР¶РµР№-РґР°Р±Р»-СЋ-С‚Рё): AUTH_HS256SECRET, AUTH_ISSUER, AUTH_AUDIENCE
  - Ingress (РёРЅРіСЂРµСЃСЃ): tlsSecretName, mtls.secretName
- РСЃРїРѕР»СЊР·РѕРІР°РЅРёРµ
  - SPA (СЌСЃ-РїРё-СЌР№): РїРѕР»РѕР¶РёС‚СЊ access_token РІ localStorage, РЅР°РІРёРіР°С†РёСЏ РїРѕ СЂР°Р·РґРµР»Р°Рј
- Troubleshooting (С‚СЂР°Р±Р»С€СѓС‚РёРЅРі)
  - 401/403: РїСЂРѕРІРµСЂРёС‚СЊ С‚РѕРєРµРЅ, СЂРѕР»Рё
  - 500: РїСЂРѕРІРµСЂРёС‚СЊ Р‘Р”/РєР°С„РєР°, Р»РѕРіРё Рё РјРµС‚СЂРёРєРё
  - РњРµС‚СЂРёРєРё: /metrics РґРѕСЃС‚СѓРїРµРЅ РґР»СЏ Prometheus
- Р РµРєРѕРјРµРЅРґР°С†РёРё
  - РџРµСЂРµРєР»СЋС‡Р°С‚СЊ СЂРµР¶РёРј СЃС‚Р°Р±РёР»РёР·Р°С†РёРё РїСЂРё РёСЃС‡РµСЂРїР°РЅРёРё error budget (СЌСЂСЂРѕСЂ Р±Р°РґР¶РµС‚)
  - РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ Pyrra (РїРёСЂСЂР°) РґР»СЏ СѓРїСЂР°РІР»РµРЅРёСЏ SLO Рё burn rate-Р°Р»РµСЂС‚Р°РјРё

6. РџСЂРёР»РѕР¶РµРЅРёСЏ: РґРёР°РіСЂР°РјРјС‹ Рё СЃС…РµРјС‹
- ERD (РµСЂ-РґРё): РѕСЃРЅРѕРІРЅС‹Рµ С‚Р°Р±Р»РёС†С‹
  ```mermaid
  classDiagram
    class trips {
      id: string
      origin_warehouse_id: string
      pickup_point_id: string
      carrier_id: string
      assigned_at: timestamp
      status: string
    }
    class trip_batches {
      trip_id: string
      batch_id: string
    }
    class batch_orders {
      batch_id: string
      order_id: string
    }
    class published_events {
      event_type: string
      correlation_id: string
      occurred_at: timestamp
    }
    trips --> trip_batches
    trip_batches --> batch_orders
  ```
- РџСЂРёРјРµСЂС‹ РєРѕРґР° (code samples) СЃ РєРѕРјРјРµРЅС‚Р°СЂРёСЏРјРё
  - РњРµС‚СЂРёРєРё HTTP (СЌР№С‡-С‚Рё-С‚Рё-РїРё) РІ operator-api:
    ```go
    // Р РµРіРёСЃС‚СЂР°С†РёСЏ РіРёСЃС‚РѕРіСЂР°РјРјС‹ Рё СЃС‡С‘С‚С‡РёРєР° Prometheus
    // РњР°СЂРєРёСЂСѓРµРј РјРµС‚РѕРґ, РјР°СЂС€СЂСѓС‚ Рё РєРѕРґ РѕС‚РІРµС‚Р°; СЃРѕС…СЂР°РЅСЏРµРј РґР»РёС‚РµР»СЊРЅРѕСЃС‚СЊ Рё РєРѕР»РёС‡РµСЃС‚РІРѕ
    ```
  - РњРµС‚СЂРёРєР° вЂњdelivery-timeвЂќ (РґРµР»РёРІРµСЂРё-С‚Р°Р№Рј) вЂ” РїСЂРёРјРµСЂ:
    ```go
    // РќР° Р·Р°РІРµСЂС€РµРЅРёРё РїР°СЂС‚РёРё: РІС‹С‡РёСЃР»СЏРµРј РґР»РёС‚РµР»СЊРЅРѕСЃС‚СЊ Рё РѕС‚РјРµС‡Р°РµРј on_time/late
    // deliveryDuration.WithLabelValues("on_time"|"late").Observe(seconds)
    ```
- SLO (СЌСЃ-СЌР»-Рѕ) С‡РµСЂРµР· Pyrra (РїРёСЂСЂР°)
  - delivery-time-slo.yaml Рё api-latency-slo.yaml: РѕР±СЉРµРєС‚С‹ ServiceLevelObjective
  - Р“РµРЅРµСЂР°С†РёСЏ recording rules Рё 4 Multi Burn Rate Alerts

РџСЂРёРјРµС‡Р°РЅРёРµ РїРѕ Р°Р»РµСЂС‚РёРЅРіСѓ Telegram (С‚РµР»РµРіСЂР°Рј): РёРЅС‚РµРіСЂР°С†РёСЏ Alertmanager (Р°Р»РµСЂС‚РјРµРЅРµРґР¶РµСЂ) СЃ Telegram РїРѕРєР° РЅРµ РЅР°СЃС‚СЂРѕРµРЅР°; С‚СЂРµР±СѓРµС‚СЃСЏ РґРѕР±Р°РІРёС‚СЊ receiver (СЂРµСЃРёРІРµСЂ) Рё route (СЂРѕСѓС‚) РІ РєРѕРЅС„РёРіСѓСЂР°С†РёСЋ Alertmanager, Р° С‚Р°РєР¶Рµ СЃРµРєСЂРµС‚С‹ РґР»СЏ Р±РѕС‚Р°.

7. Р’Р°СЂРёР°РЅС‚С‹ СЂРµС€РµРЅРёР№ РїСЂРё РїРѕР»РѕРјРєРµ РјР°С€РёРЅС‹
- Р¦РµР»СЊ
  - РЎРЅРёР·РёС‚СЊ СЃСЂС‹РІ РґРѕСЃС‚Р°РІРєРё РёР·вЂ‘Р·Р° РЅРµРїРѕР»Р°РґРѕРє С‚СЂР°РЅСЃРїРѕСЂС‚Р°: Р±С‹СЃС‚СЂРѕ Р·Р°РјРµРЅРёС‚СЊ РїРµСЂРµРІРѕР·С‡РёРєР°, РїСЂРµРґСѓРїСЂРµРґРёС‚СЊ СѓС‡Р°СЃС‚РЅРёРєРѕРІ Рё РѕС‚СЃР»РµРґРёС‚СЊ РїРѕСЃР»РµРґСЃС‚РІРёСЏ.
- Р‘Р°Р·РѕРІС‹Рµ РїСЂРёРЅС†РёРїС‹
  - Р›СѓС‡С€Рµ Р·Р°СЂР°РЅРµРµ РёРјРµС‚СЊ Р·Р°РїР°СЃРЅРѕР№ РІР°СЂРёР°РЅС‚, С‡РµРј СЂРµР°РіРёСЂРѕРІР°С‚СЊ, РєРѕРіРґР° СѓР¶Рµ РїРѕР·РґРЅРѕ.
  - Р§РµРј РјРµРЅСЊС€Рµ СЂСѓС‡РЅС‹С… РґРµР№СЃС‚РІРёР№, С‚РµРј Р±С‹СЃС‚СЂРµРµ СЃРёСЃС‚РµРјР° РІРѕСЃСЃС‚Р°РЅР°РІР»РёРІР°РµС‚СЃСЏ.
- Р’Р°СЂРёР°РЅС‚ Рђ: РЎР»СѓР¶Р±Р° Р°РІР°СЂРёР№РЅРѕРіРѕ СЂРµР°РіРёСЂРѕРІР°РЅРёСЏ
  - Р§С‚Рѕ РґРµР»Р°РµС‚: РїРѕР»СѓС‡Р°РµС‚ СЃРѕРѕР±С‰РµРЅРёРµ Рѕ РїРѕР»РѕРјРєРµ, Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РїС‹С‚Р°РµС‚СЃСЏ РЅР°Р№С‚Рё Р·Р°РјРµРЅСѓ Рё Р·Р°РїСѓСЃРєР°РµС‚ РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ СЂРµР№СЃР°.
  - РљР°Рє РІС‹Р±РёСЂР°РµС‚ Р·Р°РјРµРЅСѓ: СѓС‡РёС‚С‹РІР°РµС‚ Р±Р»РёР·РѕСЃС‚СЊ, СЃРІРѕР±РѕРґРЅРѕСЃС‚СЊ РјР°С€РёРЅС‹, РІРјРµСЃС‚РёРјРѕСЃС‚СЊ, РІСЂРµРјСЏ РІ РїСѓС‚Рё, С‚СЂРµР±РѕРІР°РЅРёСЏ РїСѓРЅРєС‚Р° РІС‹РґР°С‡Рё.
  - Р•СЃР»Рё Р·Р°РјРµРЅС‹ РЅРµС‚: СЃСЂР°Р·Сѓ СЃРѕРѕР±С‰Р°РµС‚ РѕРїРµСЂР°С‚РѕСЂСѓ Рё РїСЂРµРґР»Р°РіР°РµС‚ РІР°СЂРёР°РЅС‚С‹ вЂ” СЂР°Р·РґРµР»РёС‚СЊ РїР°СЂС‚РёСЋ, РїРµСЂРµРЅРµСЃС‚Рё СЃСЂРѕРєРё, РїРѕРґРєР»СЋС‡РёС‚СЊ РїР°СЂС‚РЅС‘СЂР°.
- Р’Р°СЂРёР°РЅС‚ Р‘: РЎР»СѓР¶Р±Р° СЃРѕСЃС‚РѕСЏРЅРёСЏ С‚СЂР°РЅСЃРїРѕСЂС‚Р°
  - Р§С‚Рѕ РґРµР»Р°РµС‚: СЃРѕР±РёСЂР°РµС‚ СЃРІРµРґРµРЅРёСЏ Рѕ С‚РµС…СЃРѕСЃС‚РѕСЏРЅРёРё, РїР»Р°РЅРѕРІРѕРј РѕР±СЃР»СѓР¶РёРІР°РЅРёРё Рё С‚РµРєСѓС‰РёС… РїСЂРѕР±Р»РµРјР°С… РїРѕ РјР°С€РёРЅР°Рј.
  - РџРѕР»СЊР·Р°: РїСЂРµРґСѓРїСЂРµР¶РґР°РµС‚ Р·Р°СЂР°РЅРµРµ Рѕ СЂРёСЃРєР°С… РїРѕ СЂРµР№СЃР°Рј, РїСЂРµРґР»Р°РіР°РµС‚ РїРµСЂРµСЃС‚СЂРѕРёС‚СЊ РїР»Р°РЅ РґРѕ СЂРµР°Р»СЊРЅРѕР№ РїРѕР»РѕРјРєРё.
- Р’Р°СЂРёР°РЅС‚ Р’: РЎР»СѓР¶Р±Р° СЂРµР·РµСЂРІРЅС‹С… РїРµСЂРµРІРѕР·С‡РёРєРѕРІ
  - Р§С‚Рѕ РґРµР»Р°РµС‚: РґР»СЏ РІР°Р¶РЅС‹С… РЅР°РїСЂР°РІР»РµРЅРёР№ Р·Р°СЂР°РЅРµРµ РґРµСЂР¶РёС‚ СЃРїРёСЃРѕРє РіРѕС‚РѕРІС‹С… РїРѕРґРјРµРЅРЅС‹С… РїРµСЂРµРІРѕР·С‡РёРєРѕРІ Рё РёС… СѓСЃР»РѕРІРёСЏ.
  - РџРѕР»СЊР·Р°: РїСЂРё РёРЅС†РёРґРµРЅС‚Рµ РЅРµ С‚СЂР°С‚РёРј РІСЂРµРјСЏ РЅР° РїРѕРёСЃРє вЂ” РµСЃС‚СЊ РіРѕС‚РѕРІС‹Рµ РєРѕРЅС‚Р°РєС‚С‹ Рё РїСЂР°РІРёР»Р°.
- Р’Р°СЂРёР°РЅС‚ Р“: РЎР»СѓР¶Р±Р° РїРµСЂРµСЂР°СЃРїСЂРµРґРµР»РµРЅРёСЏ РїР°СЂС‚РёР№
  - Р§С‚Рѕ РґРµР»Р°РµС‚: РµСЃР»Рё СЂРµР№СЃ СЃРѕСЂРІР°РЅ, СЂР°Р·РґРµР»СЏРµС‚ Р±РѕР»СЊС€СѓСЋ РїР°СЂС‚РёСЋ РЅР° РЅРµСЃРєРѕР»СЊРєРѕ С‡Р°СЃС‚РµР№ Рё СЂР°СЃРїСЂРµРґРµР»СЏРµС‚ РїРѕ РґРѕСЃС‚СѓРїРЅС‹Рј РјР°С€РёРЅР°Рј.
  - РџРѕР»СЊР·Р°: С‡Р°СЃС‚СЊ РіСЂСѓР·РѕРІ РІСЃС‘ СЂР°РІРЅРѕ СѓСЃРїРµРµС‚ РІРѕРІСЂРµРјСЏ, РґР°Р¶Рµ РµСЃР»Рё С†РµР»РёРєРѕРј РІС‹РІРµР·С‚Рё РЅРµ РїРѕР»СѓС‡Р°РµС‚СЃСЏ.
- Р’Р°СЂРёР°РЅС‚ Р”: РЎР»СѓР¶Р±Р° СѓРІРµРґРѕРјР»РµРЅРёР№
  - Р§С‚Рѕ РґРµР»Р°РµС‚: РїСЂРё РїРѕР»РѕРјРєРµ СЂР°СЃСЃС‹Р»Р°РµС‚ СЃРѕРѕР±С‰РµРЅРёСЏ РѕРїРµСЂР°С‚РѕСЂСѓ, РїРµСЂРµРІРѕР·С‡РёРєСѓ, РїСѓРЅРєС‚Сѓ РІС‹РґР°С‡Рё, РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё вЂ” РїРѕР»СѓС‡Р°С‚РµР»СЏРј.
  - РљР°РЅР°Р»С‹: С‚РµР»РµС„РѕРЅ, СЃРѕРѕР±С‰РµРЅРёСЏ, РјРµСЃСЃРµРЅРґР¶РµСЂ; С„РѕСЂРјР°С‚ вЂ” С‡С‘С‚РєРѕ Рё РїРѕРЅСЏС‚РЅРѕ: С‡С‚Рѕ СЃР»СѓС‡РёР»РѕСЃСЊ, С‡С‚Рѕ РґРµР»Р°РµРј, РєРѕРіРґР° Р¶РґР°С‚СЊ.
- РњРёРЅРёРјР°Р»СЊРЅС‹Р№ С€Р°Рі Р±РµР· РЅРѕРІРѕРіРѕ СЃРµСЂРІРёСЃР°
  - Р”РѕР±Р°РІРёС‚СЊ РїСЂР°РІРёР»Рѕ: РїСЂРё СЃРѕР±С‹С‚РёРё вЂњРїРѕР»РѕРјРєР°вЂќ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё СЃС„РѕСЂРјРёСЂРѕРІР°С‚СЊ РєРѕРјР°РЅРґСѓ РЅР° РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ Рё РѕС‚СЂР°Р·РёС‚СЊ СЌС‚Рѕ РІ РёРЅС‚РµСЂС„РµР№СЃРµ РѕРїРµСЂР°С‚РѕСЂР°.
  - Р’РєР»СЋС‡РёС‚СЊ СѓРІРµРґРѕРјР»РµРЅРёСЏ РґР»СЏ РѕС‚РІРµС‚СЃС‚РІРµРЅРЅС‹С… Р»СЋРґРµР№, С‡С‚РѕР±С‹ СЂРµС€РµРЅРёРµ РїСЂРёРЅРёРјР°Р»РѕСЃСЊ Р±С‹СЃС‚СЂРµРµ.
  - РќР°СЃС‚СЂРѕРёС‚СЊ РѕС‚РґРµР»СЊРЅС‹Р№ РѕС‚С‡С‘С‚ РїРѕ С‚Р°РєРёРј РёРЅС†РёРґРµРЅС‚Р°Рј: СЃРєРѕР»СЊРєРѕ Р±С‹Р»Рѕ, РєР°Рє Р±С‹СЃС‚СЂРѕ СЂРµС€Р°Р»Рё, РєР°Рє СЌС‚Рѕ РІР»РёСЏР»Рѕ РЅР° СЃСЂРѕРєРё.
 
8. РџРµСЂРµРіСЂСѓР·РєР° С‚РѕРІР°СЂР°: РєР°Рє СЌС‚Рѕ РґРµР»Р°С‚СЊ Рё Р°РІС‚РѕРјР°С‚РёР·РёСЂРѕРІР°С‚СЊ
- РљРѕРіРґР° РЅСѓР¶РЅР° РїРµСЂРµРіСЂСѓР·РєР°
  - РњР°С€РёРЅР° СЃР»РѕРјР°Р»Р°СЃСЊ, СЂРµР№СЃ СЃРѕСЂРІР°РЅ, РЅРѕ СЂСЏРґРѕРј РµСЃС‚СЊ РґСЂСѓРіР°СЏ РјР°С€РёРЅР°.
  - РњР°С€РёРЅР° РїРµСЂРµРіСЂСѓР¶РµРЅР°, С‚СЂРµР±СѓРµС‚СЃСЏ С‡Р°СЃС‚СЊ РіСЂСѓР·Р° РїРµСЂРµРІРµР·С‚Рё РґСЂСѓРіРѕР№ РјР°С€РёРЅРѕР№.
  - РќСѓР¶РЅРѕ СѓСЃРєРѕСЂРёС‚СЊ РґРѕСЃС‚Р°РІРєСѓ: СЂР°Р·РґРµР»РёС‚СЊ Р±РѕР»СЊС€СѓСЋ РїР°СЂС‚РёСЋ РЅР° РЅРµСЃРєРѕР»СЊРєРѕ СЂРµР№СЃРѕРІ.
- РљР°Рє РґРµР»Р°С‚СЊ РїРµСЂРµРіСЂСѓР·РєСѓ РїРѕ С€Р°РіР°Рј
  - РџРѕРґРіРѕС‚РѕРІРєР°: РІС‹Р±СЂР°С‚СЊ РјРµСЃС‚Рѕ, РіРґРµ РјРѕР¶РЅРѕ Р±РµР·РѕРїР°СЃРЅРѕ РїРµСЂРµРіСЂСѓР·РёС‚СЊ (СЃРєР»Р°Рґ, РїСЂРѕРјРµР¶СѓС‚РѕС‡РЅР°СЏ С‚РѕС‡РєР°).
  - РЈС‡С‘С‚: РїРµСЂРµСЃС‡РёС‚Р°С‚СЊ РєРѕСЂРѕР±РєРё, СЃРІРµСЂРёС‚СЊ РїРѕ СЃРїРёСЃРєСѓ, РёСЃРєР»СЋС‡РёС‚СЊ РїРµСЂРµСЃРѕСЂС‚ Рё РЅРµРґРѕСЃС‚Р°С‡Сѓ.
  - РЎРєР°РЅС‹: РѕС‚СЃРєР°РЅРёСЂРѕРІР°С‚СЊ С€С‚СЂРёС…РєРѕРґС‹ РєРѕСЂРѕР±РѕРє, С‡С‚РѕР±С‹ С‚РѕС‡РЅРѕ Р·РЅР°С‚СЊ, С‡С‚Рѕ РїРµСЂРµР»РѕР¶РёР»Рё.
  - РћС„РѕСЂРјР»РµРЅРёРµ: СЃРѕР·РґР°С‚СЊ РЅРѕРІС‹Р№ СЂРµР№СЃ РёР»Рё РґРѕР±Р°РІРёС‚СЊ Рє СЃСѓС‰РµСЃС‚РІСѓСЋС‰РµРјСѓ; Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ, С‡С‚Рѕ РёРјРµРЅРЅРѕ Рё РєСѓРґР° РїРµСЂРµРјРµСЃС‚РёР»Рё.
  - РџСЂРѕРІРµСЂРєРё: РІРјРµСЃС‚РёРјРѕСЃС‚СЊ, РІРµСЃ, РіР°Р±Р°СЂРёС‚С‹, РґРѕРїСѓСЃС‚РёРјРѕСЃС‚СЊ РјР°СЂС€СЂСѓС‚Р° РґР»СЏ РЅРѕРІРѕР№ РјР°С€РёРЅС‹.
  - РЈРІРµРґРѕРјР»РµРЅРёСЏ: СЃРѕРѕР±С‰РёС‚СЊ РїСѓРЅРєС‚Сѓ РІС‹РґР°С‡Рё Рё РѕРїРµСЂР°С‚РѕСЂСѓ РЅРѕРІС‹Р№ РїР»Р°РЅ (РІСЂРµРјСЏ, СЃРѕСЃС‚Р°РІ).
  - РћС‚РїСЂР°РІРєР°: Р·Р°РіСЂСѓР·РёС‚СЊ, Р·Р°РєСЂРµРїРёС‚СЊ, РїСЂРѕРІРµСЂРёС‚СЊ РґРѕРєСѓРјРµРЅС‚С‹ Рё РїРѕРµС…Р°С‚СЊ.
- Р§С‚Рѕ РЅР°РґРѕ С„РёРєСЃРёСЂРѕРІР°С‚СЊ РІ СЃРёСЃС‚РµРјРµ
  - РЎРѕР±С‹С‚РёРµ В«РїРµСЂРµРіСЂСѓР·РєР°В»: РєС‚Рѕ РёРЅРёС†РёРёСЂРѕРІР°Р», РіРґРµ, РєРѕРіРґР°, СЃРєРѕР»СЊРєРѕ РєРѕСЂРѕР±РѕРє.
  - РџРµСЂРµРјРµС‰РµРЅРёРµ РµРґРёРЅРёС†: РёР· РєР°РєРѕРіРѕ СЂРµР№СЃР° РІ РєР°РєРѕР№, СЃРїРёСЃРѕРє РєРѕСЂРѕР±РѕРє.
  - РћР±РЅРѕРІР»С‘РЅРЅС‹Рµ СЃСЂРѕРєРё: РєРѕРіРґР° РѕР¶РёРґР°С‚СЊ РїСЂРёР±С‹С‚РёРµ РєР°Р¶РґРѕР№ С‡Р°СЃС‚Рё РіСЂСѓР·Р°.
  - РћС‚РІРµС‚СЃС‚РІРµРЅРЅС‹Рµ: РєС‚Рѕ РїСЂРёРЅСЏР» СЂРµС€РµРЅРёРµ Рё РєС‚Рѕ РІС‹РїРѕР»РЅСЏР».
- РљР°Рє Р°РІС‚РѕРјР°С‚РёР·РёСЂРѕРІР°С‚СЊ
  - РЎРѕР·РґР°С‚СЊ РѕС‚РґРµР»СЊРЅС‹Р№ СЂР°Р·РґРµР» РІ РёРЅС‚РµСЂС„РµР№СЃРµ РѕРїРµСЂР°С‚РѕСЂР° В«РџРµСЂРµРіСЂСѓР·РєР°В»:
    - Р’С‹Р±РѕСЂ РёСЃС…РѕРґРЅРѕРіРѕ СЂРµР№СЃР° Рё РјР°С€РёРЅС‹вЂ‘РїСЂРёС‘РјРЅРёРєР°.
    - РћС‚Р±РѕСЂ РєРѕСЂРѕР±РѕРє РїРѕ СЃРєР°РЅР°Рј/СЃРїРёСЃРєСѓ.
    - РђРІС‚РѕРјР°С‚РёС‡РµСЃРєРёРµ РїСЂРѕРІРµСЂРєРё РІРјРµСЃС‚РёРјРѕСЃС‚Рё/РІРµСЃР° Рё РІСЂРµРјРµРЅРё РІ РїСѓС‚Рё.
    - РљРЅРѕРїРєР° В«РѕС„РѕСЂРјРёС‚СЊ РїРµСЂРµРіСЂСѓР·РєСѓВ»: С„РѕСЂРјРёСЂСѓРµС‚ РЅРѕРІС‹Р№ СЂРµР№СЃ/РѕР±РЅРѕРІР»СЏРµС‚ СЃС‚Р°СЂС‹Р№, РјРµРЅСЏРµС‚ РїСЂРёРІСЏР·РєСѓ РєРѕСЂРѕР±РѕРє.
  - РЎРѕР±С‹С‚РёСЏ:
    - В«РїРµСЂРµРіСЂСѓР·РєР°_РёРЅРёС†РёРёСЂРѕРІР°РЅР°В» вЂ” РЅР°С‡Р°Р»Рё РїСЂРѕС†РµСЃСЃ, РїСЂРѕРјРµР¶СѓС‚РѕС‡РЅС‹Рµ РґР°РЅРЅС‹Рµ.
    - В«РїРµСЂРµРіСЂСѓР·РєР°_Р·Р°РІРµСЂС€РµРЅР°В» вЂ” РІСЃРµ РєРѕСЂРѕР±РєРё РїРµСЂРµР»РѕР¶РµРЅС‹ Рё СѓС‡С‚РµРЅС‹.
    - В«РєРѕСЂРѕР±РєР°_РїРµСЂРµРјРµС‰РµРЅР°В» вЂ” РєР°Р¶РґР°СЏ РµРґРёРЅРёС†Р° РїРµСЂРµРјРµС‰РµРЅРёСЏ.
  - РџСЂР°РІРёР»Р°:
    - Р•СЃР»Рё РїРµСЂРµРіСЂСѓР·РєР° С‡Р°СЃС‚РёС‡РЅР°СЏ вЂ” СЂР°Р·РґРµР»РёС‚СЊ РїР°СЂС‚РёСЋ: С‡Р°СЃС‚СЊ СѓРµР·Р¶Р°РµС‚ СЃСЂР°Р·Сѓ, РѕСЃС‚Р°Р»СЊРЅРѕРµ РїРѕР·Р¶Рµ.
    - Р•СЃР»Рё РїРµСЂРµРіСЂСѓР·РєР° РїРѕР»РЅР°СЏ вЂ” Р·Р°РјРµРЅРёС‚СЊ РјР°С€РёРЅСѓ Рё РѕР±РЅРѕРІРёС‚СЊ СЂРµР№СЃ С†РµР»РёРєРѕРј.
  - РЈРІРµРґРѕРјР»РµРЅРёСЏ:
    - РћРїРµСЂР°С‚РѕСЂ, РїСѓРЅРєС‚ РІС‹РґР°С‡Рё, РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё вЂ” РїРѕР»СѓС‡Р°С‚РµР»Рё (РЅРѕРІС‹Рµ СЃСЂРѕРєРё).
  - РћС‚С‡С‘С‚:
    - РЎРєРѕР»СЊРєРѕ РїРµСЂРµРіСЂСѓР·РѕРє Р±С‹Р»Рѕ, СЃСЂРµРґРЅРµРµ РІСЂРµРјСЏ, РІР»РёСЏРЅРёРµ РЅР° СЃСЂРѕРєРё, С‚РёРїС‹ РїСЂРёС‡РёРЅ.
  - РРЅС‚РµРіСЂР°С†РёСЏ СЃРѕ СЃРєР°РЅРµСЂР°РјРё:
    - РЎРєР°РЅРёСЂРѕРІР°С‚СЊ РєРѕСЂРѕР±РєРё РїСЂРё РІС‹РµРјРєРµ Рё РїСЂРё СѓРєР»Р°РґРєРµ РІ РЅРѕРІСѓСЋ РјР°С€РёРЅСѓ, РёСЃРєР»СЋС‡Р°СЏ РѕС€РёР±РєРё.

9. РџРѕС€Р°РіРѕРІС‹Рµ РёРЅСЃС‚СЂСѓРєС†РёРё РґР»СЏ РєР°Р¶РґРѕРіРѕ СЃРµСЂРІРёСЃР°
- operator-api (СЃР»СѓР¶Р±Р° РґР»СЏ РѕРїРµСЂР°С‚РѕСЂР°)
  - РќР°Р·РЅР°С‡РµРЅРёРµ: РїРѕРєР°Р·Р°С‚СЊ СЂРµР№СЃС‹, РґРµС‚Р°Р»Рё, Р·Р°РґРµСЂР¶РєРё, СЃРїСЂР°РІРѕС‡РЅРёРєРё; РѕС‚РїСЂР°РІРёС‚СЊ РєРѕРјР°РЅРґСѓ РЅР° СЃРјРµРЅСѓ РїРµСЂРµРІРѕР·С‡РёРєР°.
  - РћСЃРЅРѕРІРЅС‹Рµ С„СѓРЅРєС†РёРё: С‡С‚РµРЅРёРµ РёР· Р±Р°Р·С‹ (СЂРµР№СЃС‹, СЃРїСЂР°РІРѕС‡РЅРёРєРё), РїСѓР±Р»РёРєР°С†РёСЏ РєРѕРјР°РЅРґ, Р·Р°С‰РёС‚Р° JWT, РјРµС‚СЂРёРєРё /metrics.
  - Р РѕР»СЊ РІ СЃРёСЃС‚РµРјРµ: В«С„СЂРѕРЅС‚В» РґР»СЏ РѕРїРµСЂР°С‚РѕСЂР°, РµРґРёРЅСЃС‚РІРµРЅРЅР°СЏ С‚РѕС‡РєР° РІРјРµС€Р°С‚РµР»СЊСЃС‚РІР°.
  - РўРµС…РЅРѕР»РѕРіРёРё: Go 1.24+, pgx/v5, kafka-go, viper, JWT, Prometheus-РєР»РёРµРЅС‚.
  - Р’Р·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ: С‡РёС‚Р°РµС‚ РёР· Р‘Р” (trip, batch, reference); РїСѓР±Р»РёРєСѓРµС‚ РєРѕРјР°РЅРґСѓ РІ Kafka (commands.trip.reassign); РѕС‚РґР°РµС‚ JSON РґР»СЏ SPA.
  - РЁР°РіРё Р·Р°РїСѓСЃРєР°:
    - РќР°СЃС‚СЂРѕРёС‚СЊ РїРµСЂРµРјРµРЅРЅС‹Рµ РѕРєСЂСѓР¶РµРЅРёСЏ (РїРѕСЂС‚С‹, DSN, Kafka, JWT).
    - РЎРѕР±СЂР°С‚СЊ: go build ./...
    - Р—Р°РїСѓСЃС‚РёС‚СЊ: Р±РёРЅР°СЂРЅРёРє; РїСЂРѕРІРµСЂРёС‚СЊ /healthz, /readyz, /metrics.
  - РЁР°РіРё СЂР°Р±РѕС‚С‹:
    - GET /trips вЂ” СЃРїРёСЃРѕРє СЂРµР№СЃРѕРІ, С„РёР»СЊС‚СЂС‹.
    - GET /trips/{id} вЂ” РґРµС‚Р°Р»Рё.
    - GET /delays вЂ” СЂРµР№СЃС‹ СЃ Р·Р°РґРµСЂР¶РєРѕР№.
    - GET /references/{type}?q= вЂ” СЃРїСЂР°РІРѕС‡РЅРёРєРё.
    - POST /trips/{id}/reassign вЂ” РѕС‚РїСЂР°РІРєР° РєРѕРјР°РЅРґС‹ РЅР° СЃРјРµРЅСѓ РїРµСЂРµРІРѕР·С‡РёРєР°.
- order-service (Р·Р°РєР°Р·С‹)
  - РќР°Р·РЅР°С‡РµРЅРёРµ: РїСЂРёРЅСЏС‚СЊ Рё СѓС‡РёС‚С‹РІР°С‚СЊ Р·Р°РєР°Р·С‹, РїСѓР±Р»РёРєРѕРІР°С‚СЊ СЃРѕР±С‹С‚РёСЏ В«Р·Р°РєР°Р· СЃРѕР·РґР°РЅВ», СЃР»СѓС€Р°С‚СЊ СЃРѕР±С‹С‚РёСЏ РїР°СЂС‚РёРё/РґРѕСЃС‚Р°РІРєРё.
  - РћСЃРЅРѕРІРЅС‹Рµ С„СѓРЅРєС†РёРё: Р·Р°РїРёСЃСЊ Р·Р°РєР°Р·Р°, РїСѓР±Р»РёРєР°С†РёСЏ/РѕР±СЂР°Р±РѕС‚РєР° СЃРѕР±С‹С‚РёР№, РѕР±РЅРѕРІР»РµРЅРёРµ СЃС‚Р°С‚СѓСЃР°.
  - Р РѕР»СЊ: РёСЃС‚РѕС‡РЅРёРє РґР°РЅРЅС‹С… РґР»СЏ С„РѕСЂРјРёСЂРѕРІР°РЅРёСЏ РїР°СЂС‚РёР№.
  - РўРµС…РЅРѕР»РѕРіРёРё: Go, pgx/v5, kafka-go, viper, OpenTelemetry.
  - Р’Р·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ: РїРёС€РµС‚ РІ Р‘Р”, РїСѓР±Р»РёРєСѓРµС‚ В«orders.createdВ», СЃР»СѓС€Р°РµС‚ В«batches.formedВ» Рё СЃРѕР±С‹С‚РёСЏ РґРѕСЃС‚Р°РІРєРё.
  - РЁР°РіРё: РЅР°СЃС‚СЂРѕРёС‚СЊ DSN Рё Kafka; Р·Р°РїСѓСЃС‚РёС‚СЊ; РїСЂРѕРІРµСЂРёС‚СЊ РіРѕС‚РѕРІРЅРѕСЃС‚СЊ /readyz.
- batching-service (С„РѕСЂРјРёСЂРѕРІР°РЅРёРµ РїР°СЂС‚РёР№)
  - РќР°Р·РЅР°С‡РµРЅРёРµ: РѕР±СЉРµРґРёРЅСЏС‚СЊ Р·Р°РєР°Р·С‹ РІ РїР°СЂС‚РёРё РїРѕ СЃРєР»Р°РґСѓ/РџР’Р— СЃ РѕРіСЂР°РЅРёС‡РµРЅРёСЏРјРё СЂР°Р·РјРµСЂР°/РІСЂРµРјРµРЅРё.
  - РћСЃРЅРѕРІРЅС‹Рµ С„СѓРЅРєС†РёРё: РЅР°РєРѕРїР»РµРЅРёРµ, С„Р»Р°С€ РїРѕ СЂР°Р·РјРµСЂСѓ/РІСЂРµРјРµРЅРё, Р·Р°РїРёСЃСЊ РїР°СЂС‚РёРё, РїСѓР±Р»РёРєР°С†РёСЏ В«batches.formedВ».
  - Р РѕР»СЊ: РіРѕС‚РѕРІРёС‚ РіСЂСѓР· Рє РїРѕРіСЂСѓР·РєРµ РІ СЂРµР№СЃС‹.
  - РўРµС…РЅРѕР»РѕРіРёРё: Go, pgx/v5, kafka-go.
  - Р’Р·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ: СЃР»СѓС€Р°РµС‚ В«orders.createdВ»; РїРёС€РµС‚ РїР°СЂС‚РёРё; РїСѓР±Р»РёРєСѓРµС‚ В«batches.formedВ».
  - РЁР°РіРё: РЅР°СЃС‚СЂРѕРёС‚СЊ DSN/Kafka; Р·Р°РїСѓСЃС‚РёС‚СЊ; РЅР°Р±Р»СЋРґР°С‚СЊ РјРµС‚СЂРёРєРё.
- routing-service (РјР°СЂС€СЂСѓС‚С‹/СЂРµР№СЃС‹)
  - РќР°Р·РЅР°С‡РµРЅРёРµ: РЅР°Р·РЅР°С‡РёС‚СЊ РїРµСЂРµРІРѕР·С‡РёРєР°, СЃРѕР·РґР°С‚СЊ СЂРµР№СЃ, СЂР°СЃСЃС‡РёС‚С‹РІР°С‚СЊ РїСѓС‚СЊ.
  - РћСЃРЅРѕРІРЅС‹Рµ С„СѓРЅРєС†РёРё: РїРѕРґР±РѕСЂ РїРµСЂРµРІРѕР·С‡РёРєР°, СЃРѕР·РґР°РЅРёРµ СЂРµР№СЃР°, РѕР±РЅРѕРІР»РµРЅРёРµ СЃС‚Р°С‚СѓСЃР°.
  - Р РѕР»СЊ: РїРµСЂРµРІРѕРґРёС‚ РїР°СЂС‚РёРё РёР· В«РіРѕС‚РѕРІРѕВ» РІ В«РІ РїСѓС‚РёВ».
  - Р’Р·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ: СЃР»СѓС€Р°РµС‚ В«batches.formedВ»; РїРёС€РµС‚ СЂРµР№СЃ РІ Р‘Р”; РјРѕР¶РµС‚ РїСѓР±Р»РёРєРѕРІР°С‚СЊ СЃРѕР±С‹С‚РёСЏ РЅР°Р·РЅР°С‡РµРЅРёСЏ.
  - РЁР°РіРё: РЅР°СЃС‚СЂРѕРёС‚СЊ РґРѕСЃС‚СѓРї Рє СЃРїСЂР°РІРѕС‡РЅРёРєР°Рј Рё Р‘Р”; Р·Р°РїСѓСЃС‚РёС‚СЊ.
- reassignment-service (РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ РїРµСЂРµРІРѕР·С‡РёРєР°)
  - РќР°Р·РЅР°С‡РµРЅРёРµ: РѕР±СЂР°Р±РѕС‚Р°С‚СЊ РєРѕРјР°РЅРґСѓ СЃРјРµРЅС‹ РїРµСЂРµРІРѕР·С‡РёРєР° Рё РІРЅРµСЃС‚Рё РёР·РјРµРЅРµРЅРёСЏ.
  - РћСЃРЅРѕРІРЅС‹Рµ С„СѓРЅРєС†РёРё: СЃР»СѓС€Р°С‚СЊ commands.trip.reassign; РїРѕРґРѕР±СЂР°С‚СЊ РЅРѕРІРѕРіРѕ РїРµСЂРµРІРѕР·С‡РёРєР°; РѕР±РЅРѕРІРёС‚СЊ СЂРµР№СЃ; РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё СѓРІРµРґРѕРјРёС‚СЊ.
  - Р РѕР»СЊ: СЃРїР°СЃРµРЅРёРµ СЂРµР№СЃРѕРІ РїСЂРё РїСЂРѕР±Р»РµРјР°С….
  - Р’Р·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ: СЃР»СѓС€Р°РµС‚ Kafka; РїРёС€РµС‚ РІ Р‘Р”; РјРѕР¶РµС‚ РїСѓР±Р»РёРєРѕРІР°С‚СЊ СЃРѕР±С‹С‚РёСЏ В«РїРµСЂРµРІРѕР·С‡РёРє СЃРјРµРЅС‘РЅВ».
  - РЁР°РіРё: РЅР°СЃС‚СЂРѕРёС‚СЊ Kafka/Р‘Р”; Р·Р°РїСѓСЃС‚РёС‚СЊ РІРѕСЂРєРµСЂ; РЅР°Р±Р»СЋРґР°С‚СЊ Р»РѕРіРё Рё РјРµС‚СЂРёРєРё.
  - РџР°СЂР°РјРµС‚СЂС‹ РѕРєСЂСѓР¶РµРЅРёСЏ (РїСЂРёРјРµСЂ):
    - DB_TRIPDSN, DB_REFDSN
    - KAFKA_BROKERS, KAFKA_TIMEOUT
    - KAFKA_COMMANDTOPIC=commands.trip.reassign
  - РљРѕРЅСЃСЊСЋРјРµСЂ:
    - GroupID: reassignment-service
    - РўРѕРїРёРє Р±РµСЂС‘С‚СЃСЏ РёР· KAFKA_COMMANDTOPIC
    - РџСЂРё РїРѕР»СѓС‡РµРЅРёРё СЃРѕРѕР±С‰РµРЅРёСЏ РІС‹Р·С‹РІР°РµС‚ HandleManualReassign(trip_id, new_carrier_id, reason, operator_id)
  - Graceful shutdown:
    - РћС‚РјРµРЅР° РєРѕРЅС‚РµРєСЃС‚Р° РєРѕРЅСЃСЊСЋРјРµСЂР° Рё РІРѕСЂРєРµСЂР°, Р·Р°РєСЂС‹С‚РёРµ reader, РѕСЃС‚Р°РЅРѕРІРєР° HTTP
- pickup-point-service (РїСѓРЅРєС‚ РІС‹РґР°С‡Рё)
  - РќР°Р·РЅР°С‡РµРЅРёРµ: РїСЂРёРЅСЏС‚СЊ РїР°СЂС‚РёСЋ, СѓС‡РµСЃС‚СЊ С„Р°РєС‚ РґРѕСЃС‚Р°РІРєРё.
  - РћСЃРЅРѕРІРЅС‹Рµ С„СѓРЅРєС†РёРё: POST /batches/{id}/receive; Р·Р°РїРёСЃСЊ СЃРѕР±С‹С‚РёСЏ В«batch_received_by_pvpВ».
  - Р РѕР»СЊ: С„РёРєСЃРёСЂСѓРµС‚ Р·Р°РІРµСЂС€РµРЅРёРµ РїСѓС‚Рё РїР°СЂС‚РёРё.
  - Р’Р·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ: РїРёС€РµС‚ РІ Р‘Р”; РїСѓР±Р»РёРєСѓРµС‚ СЃРѕР±С‹С‚РёРµ РІ Kafka.
  - РЁР°РіРё: РЅР°СЃС‚СЂРѕРёС‚СЊ Р‘Р”/Kafka; Р·Р°РїСѓСЃС‚РёС‚СЊ; РїСЂРѕРІРµСЂРєР° /readyz.
- web/operator-panel (РїР°РЅРµР»СЊ РѕРїРµСЂР°С‚РѕСЂР°)
  - РќР°Р·РЅР°С‡РµРЅРёРµ: СѓРґРѕР±РЅС‹Р№ РёРЅС‚РµСЂС„РµР№СЃ РґР»СЏ РїСЂРѕСЃРјРѕС‚СЂР° Рё РґРµР№СЃС‚РІРёР№.
  - РћСЃРЅРѕРІРЅС‹Рµ С„СѓРЅРєС†РёРё: С‚Р°Р±Р»РёС†С‹ СЂРµР№СЃРѕРІ, С„РёР»СЊС‚СЂС‹, РґРµС‚Р°Р»Рё, Р·Р°РґРµСЂР¶РєРё, СЃРїСЂР°РІРѕС‡РЅРёРєРё; РѕС‚РїСЂР°РІРєР° РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёСЏ.
  - Р РѕР»СЊ: Р»РёС†Рѕ СЃРёСЃС‚РµРјС‹ РґР»СЏ РѕРїРµСЂР°С‚РѕСЂР°.
  - РўРµС…РЅРѕР»РѕРіРёРё: React, TypeScript, MUI, Vite.
  - Р’Р·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ: HTTP JSON СЃ operator-api; С…СЂР°РЅРёС‚ С‚РѕРєРµРЅ РІ Р±СЂР°СѓР·РµСЂРµ.
  - РЁР°РіРё: npm install; npm run build/dev; РЅР°СЃС‚СЂРѕРёС‚СЊ VITE_API_BASE_URL.

10. Р Р°Р±РѕС‚Р° СЃ РїР°СЂРѕР»СЏРјРё
- РљР°Рє РµСЃС‚СЊ СЃРµР№С‡Р°СЃ
  - РЎРёСЃС‚РµРјР° РёСЃРїРѕР»СЊР·СѓРµС‚ РІС…РѕРґ РїРѕ С‚РѕРєРµРЅСѓ (РїСЂРѕРїСѓСЃРє), Р° РЅРµ С…СЂР°РЅРёС‚ РїР°СЂРѕР»Рё РІРЅСѓС‚СЂРё. РўРѕРєРµРЅС‹ РґР°СЋС‚ РІРЅРµС€РЅРёР№ РїРѕСЃС‚Р°РІС‰РёРє РёР»Рё РІРЅСѓС‚СЂРµРЅРЅРёР№ РІС‹РїСѓСЃРєР°С‚РµР»СЊ (РІ СѓРїСЂРѕС‰С‘РЅРЅРѕРј СЂРµР¶РёРјРµ).
- Р’Р°СЂРёР°РЅС‚ Рђ: РІРЅРµС€РЅРёР№ РїРѕСЃС‚Р°РІС‰РёРє (РЅР°РїСЂРёРјРµСЂ, РіРѕС‚РѕРІР°СЏ СЃРёСЃС‚РµРјР° РІС…РѕРґР°)
  - РњС‹ РЅРµ РґРµСЂР¶РёРј РїР°СЂРѕР»Рё Сѓ СЃРµР±СЏ.
  - РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ РІС…РѕРґРёС‚ РІ СЃС‚РѕСЂРѕРЅРЅРёР№ СЃРµСЂРІРёСЃ; РѕРЅ РІС‹РґР°С‘С‚ С‚РѕРєРµРЅ.
  - РњС‹ РїСЂРѕРІРµСЂСЏРµРј РїРѕРґРїРёСЃСЊ Рё СЃСЂРѕРє РґРµР№СЃС‚РІРёСЏ С‚РѕРєРµРЅР° Рё С‡РёС‚Р°РµРј СЂРѕР»СЊ.
- Р’Р°СЂРёР°РЅС‚ Р‘: РІРЅСѓС‚СЂРµРЅРЅРёР№ РІС…РѕРґ (РµСЃР»Рё РїРѕС‚СЂРµР±СѓРµС‚СЃСЏ)
  - РҐСЂР°РЅРµРЅРёРµ: С‚РѕР»СЊРєРѕ В«СЃР»РµРґВ» РїР°СЂРѕР»СЏ (С…СЌС€), Р° РЅРµ СЃР°Рј РїР°СЂРѕР»СЊ.
  - РњРµС‚РѕРґ: СЃС‚РѕР№РєРёРµ С…СЌС€Рё (РЅР°РїСЂРёРјРµСЂ, bcrypt), СЃ В«СЃРѕР»СЊСЋВ» РґР»СЏ РєР°Р¶РґРѕРіРѕ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ; РґР»РёРЅР° РїР°СЂРѕР»СЏ РѕС‚ 12 СЃРёРјРІРѕР»РѕРІ.
  - РџСЂР°РІРёР»Р°: СЃР»РѕР¶РЅРѕСЃС‚СЊ (Р±СѓРєРІС‹/С†РёС„СЂС‹), Р·Р°РїСЂРµС‚ РїСЂРѕСЃС‚С‹С… СЃР»РѕРІ, СЃСЂРѕРє Р¶РёР·РЅРё РїР°СЂРѕР»СЏ, РёСЃС‚РѕСЂРёСЏ РїР°СЂРѕР»РµР№.
  - РЎРјРµРЅР°: СЃС‚Р°СЂС‹Р№ РїР°СЂРѕР»СЊ + РЅРѕРІС‹Р№; С…СЌС€ РѕР±РЅРѕРІР»СЏРµС‚СЃСЏ.
  - РЎР±СЂРѕСЃ РґРѕСЃС‚СѓРїР°: РєРѕРґ РѕРґРЅРѕСЂР°Р·РѕРІС‹Р№ СЃ РєРѕСЂРѕС‚РєРёРј СЃСЂРѕРєРѕРј, РѕС‚РїСЂР°РІРєР° РЅР° РїРѕС‡С‚Сѓ/С‚РµР»РµС„РѕРЅ; С…СЌС€РёСЂСѓРµРј РєРѕРґ; СЃС‚Р°РІРёРј РѕРіСЂР°РЅРёС‡РµРЅРёРµ РїРѕ РїРѕРїС‹С‚РєР°Рј.
  - РќРёРєРѕРіРґР° РЅРµ С…СЂР°РЅРёС‚СЊ РїР°СЂРѕР»Рё РІ РѕС‚РєСЂС‹С‚РѕРј РІРёРґРµ; РЅРµ РїРµСЂРµРґР°РІР°С‚СЊ РїР°СЂРѕР»Рё РїРѕ РЅРµР·Р°С‰РёС‰С‘РЅРЅС‹Рј РєР°РЅР°Р»Р°Рј.

11. РЎРёСЃС‚РµРјР° РґРѕСЃС‚СѓРїР°
- РЈСЂРѕРІРЅРё Рё СЂРѕР»Рё
  - РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ: РїСЂРѕСЃРјРѕС‚СЂ РґР°РЅРЅС‹С… (СЂРµР№СЃС‹, Р·Р°РґРµСЂР¶РєРё, СЃРїСЂР°РІРѕС‡РЅРёРєРё).
  - РњРѕРґРµСЂР°С‚РѕСЂ: РєР°Рє РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ + РѕРїРµСЂР°С†РёРё (РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ).
  - РђРґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂ: РІСЃС‘ РІС‹С€Рµ + СѓРїСЂР°РІР»РµРЅРёРµ РґРѕСЃС‚СѓРїРѕРј Рё РЅР°СЃС‚СЂРѕР№РєР°РјРё.
- Р’С…РѕРґ Рё СЂР°Р·СЂРµС€РµРЅРёСЏ
  - Р’С…РѕРґ РїРѕ С‚РѕРєРµРЅСѓ: РїСЂРѕРІРµСЂСЏРµРј РїРѕРґРїРёСЃСЊ, СЃСЂРѕРє, РёР·РґР°С‚РµР»СЏ; С‡РёС‚Р°РµРј СЂРѕР»СЊ.
  - РџСЂРѕРІРµСЂРєР° СЂРѕР»РµР№ РЅР° РєР°Р¶РґРѕРј Р·Р°РїСЂРѕСЃРµ: В«С‚РѕР»СЊРєРѕ РїСЂРѕСЃРјРѕС‚СЂВ» РёР»Рё В«СЂР°Р·СЂРµС€РµРЅС‹ РёР·РјРµРЅРµРЅРёСЏВ».
- Р’С‹РґР°С‡Р° Рё РѕС‚Р·С‹РІ РїСЂР°РІ
  - Р’С‹РґР°С‡Р°: Р°РґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂ РЅР°Р·РЅР°С‡Р°РµС‚ СЂРѕР»СЊ.
  - РћС‚Р·С‹РІ: СЃРјРµРЅР° СЂРѕР»Рё РёР»Рё РїСЂРµРєСЂР°С‰РµРЅРёРµ РґРѕСЃС‚СѓРїР°; РїСЂРёРЅСѓРґРёС‚РµР»СЊРЅС‹Р№ РѕС‚Р·С‹РІ С‚РѕРєРµРЅР° вЂ” СЃРјРµРЅР° РєР»СЋС‡Р° РїРѕРґРїРёСЃРё РёР»Рё Р·Р°РїСЂРµС‚ РєРѕРЅРєСЂРµС‚РЅРѕРіРѕ С‚РѕРєРµРЅР° (С‡С‘СЂРЅС‹Р№ СЃРїРёСЃРѕРє).
- Р›РѕРіРёСЂРѕРІР°РЅРёРµ РґРµР№СЃС‚РІРёР№
  - Р—Р°РїРёСЃС‹РІР°С‚СЊ: РєС‚Рѕ, РєРѕРіРґР°, С‡С‚Рѕ СЃРґРµР»Р°Р» (РѕРїРµСЂР°С‚РѕСЂ, РІСЂРµРјСЏ, РґРµР№СЃС‚РІРёРµ, СЂРµР·СѓР»СЊС‚Р°С‚).
  - РҐСЂР°РЅРёС‚СЊ Р»РѕРіРё РґРѕСЃС‚Р°С‚РѕС‡РЅС‹Р№ СЃСЂРѕРє; СЂР°Р·Р±РёСЂР°С‚СЊ СЃРїРѕСЂРЅС‹Рµ СЃР»СѓС‡Р°Рё.

12. РРЅС‚РµРіСЂР°С†РёРё
- РўРѕС‡РєРё РІС…РѕРґР° (РїСЂРёРјРµСЂ РґР»СЏ operator-api)
  - GET /trips вЂ” СЃРїРёСЃРѕРє СЂРµР№СЃРѕРІ (С„РёР»СЊС‚СЂС‹: СЃС‚Р°С‚СѓСЃ, РїСѓРЅРєС‚ РІС‹РґР°С‡Рё, РїРµСЂРµРІРѕР·С‡РёРє, РґР°С‚Р°).
  - GET /trips/{id} вЂ” РґРµС‚Р°Р»Рё (СЂРµР№СЃ, РїР°СЂС‚РёРё, Р·Р°РєР°Р·С‹).
  - GET /delays вЂ” СЂРµР№СЃС‹ СЃ Р·Р°РґРµСЂР¶РєРѕР№.
  - GET /references/{type}?q= вЂ” СЃРїСЂР°РІРѕС‡РЅРёРєРё (СЃРєР»Р°РґС‹, РџР’Р—, РїРµСЂРµРІРѕР·С‡РёРєРё).
  - POST /trips/{id}/reassign вЂ” РїРµСЂРµРЅР°Р·РЅР°С‡РёС‚СЊ РїРµСЂРµРІРѕР·С‡РёРєР° (РІ С‚РµР»Рµ: РЅРѕРІС‹Р№ РїРµСЂРµРІРѕР·С‡РёРє, РїСЂРёС‡РёРЅР°).
- Р¤РѕСЂРјР°С‚С‹ РґР°РЅРЅС‹С…
  - JSON РґР»СЏ Р·Р°РїСЂРѕСЃРѕРІ/РѕС‚РІРµС‚РѕРІ; РїСЂРѕСЃС‚С‹Рµ РїРѕР»СЏ: СЃС‚СЂРѕРєРё, С‡РёСЃР»Р°, РґР°С‚Р°/РІСЂРµРјСЏ.
  - РЎРѕР±С‹С‚РёСЏ РІ СЃРѕРѕР±С‰РµРЅРёСЏС…: В«С‡РµС…РѕР»В» СЃ РїРѕР»СЏРјРё (РёРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ СЃРѕР±С‹С‚РёСЏ, С‚РёРї, РІСЂРµРјСЏ, СЃРІСЏР·РєР° СЃ РѕР±СЉРµРєС‚РѕРј, РґР°РЅРЅС‹Рµ).
- РџСЂРѕС‚РѕРєРѕР»С‹ РІР·Р°РёРјРѕРґРµР№СЃС‚РІРёСЏ
  - РЎР»СѓР¶Р±С‹ РѕР±С‰Р°СЋС‚СЃСЏ С‡РµСЂРµР· РѕС‡РµСЂРµРґСЊ СЃРѕРѕР±С‰РµРЅРёР№: РїСѓР±Р»РёРєСѓСЋС‚ Рё СЃР»СѓС€Р°СЋС‚ СЃРѕР±С‹С‚РёСЏ/РєРѕРјР°РЅРґС‹.
  - РћР±РјРµРЅ СЃ РїР°РЅРµР»СЊСЋ РѕРїРµСЂР°С‚РѕСЂР° вЂ” РѕР±С‹С‡РЅС‹Рµ РІРµР±вЂ‘Р·Р°РїСЂРѕСЃС‹.
- РћС€РёР±РєРё Рё РёСЃРєР»СЋС‡РµРЅРёСЏ
  - РџР»РѕС…РёРµ РґР°РЅРЅС‹Рµ вЂ” РІРѕР·РІСЂР°С‰Р°РµРј В«РѕС€РёР±РєР° Р·Р°РїСЂРѕСЃР°В».
  - РќРµС‚ РґРѕСЃС‚СѓРїР° вЂ” В«РІС…РѕРґ РЅРµ РІС‹РїРѕР»РЅРµРЅВ» РёР»Рё В«РЅРµРґРѕСЃС‚Р°С‚РѕС‡РЅРѕ РїСЂР°РІВ».
  - РќРµ РЅР°Р№РґРµРЅРѕ вЂ” В«РЅРµС‚ С‚Р°РєРѕРіРѕВ».
  - Р’РЅСѓС‚СЂРµРЅРЅСЏСЏ РѕС€РёР±РєР° вЂ” В«РЅРµ РїРѕР»СѓС‡РёР»РѕСЃСЊ РІРЅСѓС‚СЂРёВ»; Р·Р°РїРёСЃС‹РІР°РµРј РІ Р¶СѓСЂРЅР°Р».

13. РўРµС…РЅРёС‡РµСЃРєРѕРµ СЂСѓРєРѕРІРѕРґСЃС‚РІРѕ (РєРѕСЂРѕС‚РєРѕ Рё РїРѕ РґРµР»Сѓ)
- РЎС‚СЂСѓРєС‚СѓСЂР° РїСЂРѕРµРєС‚Р°
  - services/ вЂ” РёСЃС…РѕРґРЅРёРєРё РјРёРєСЂРѕСЃРµСЂРІРёСЃРѕРІ (РєР°Р¶РґС‹Р№ СЃРµСЂРІРёСЃ: cmd/ вЂ” РІС…РѕРґ, internal/ вЂ” Р»РѕРіРёРєР°)
    - operator-api: [cmd](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/cmd/operator-api/main.go), [auth](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/internal/auth/auth.go), [service](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/internal/app/service.go), [config](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/operator-api/internal/config/config.go)
    - order-service: [cmd](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/order-service/cmd/order-service/main.go)
    - batching-service: [infra/kafka](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/batching-service/internal/infra/kafka/kafka.go)
    - routing-service: РёСЃС…РѕРґРЅРёРєРё РјР°СЂС€СЂСѓС‚РёР·Р°С†РёРё
    - reassignment-service: [worker](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/reassignment-service/internal/worker/worker.go)
    - pickup-point-service: [cmd](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/services/pickup-point-service/cmd/pickup-point-service/main.go)
  - web/operator-panel вЂ” SPA: [src/api.ts](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/web/operator-panel/src/api.ts), [pages](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/web/operator-panel/src/pages/Trips.tsx)
  - charts/ вЂ” Helm-С‡Р°СЂС‚С‹: [operator-api](file:///c:/Users/loban_h3g0vgo/GolandProjects/Bel-parcel/charts/operator-api)
- Р—Р°РїСѓСЃРє РїСЂРѕРµРєС‚Р° (Р»РѕРєР°Р»СЊРЅРѕ)
  - Р—Р°РІРёСЃРёРјРѕСЃС‚Рё
    - Go 1.24+, Node.js 18+, PostgreSQL 14+, Kafka 3.x
    - Prometheus, Grafana, Jaeger, Loki (РЅРµРѕР±СЏР·Р°С‚РµР»СЊРЅРѕ РґР»СЏ dev)
  - РќР°СЃС‚СЂРѕР№РєРё РѕРєСЂСѓР¶РµРЅРёСЏ (РїСЂРёРјРµСЂ РґР»СЏ operator-api)
    - SERVER_PORT=8090
    - DB_TRIPDSN=postgres://user:pass@localhost:5432/trip_db?sslmode=disable
    - DB_BATCHDSN=postgres://user:pass@localhost:5432/batch_db?sslmode=disable
    - DB_REFERENCEDSN=postgres://user:pass@localhost:5432/reference_db?sslmode=disable
    - KAFKA_BROKERS=localhost:9092
    - KAFKA_TIMEOUT=5s
    - KAFKA_COMMANDTOPIC=commands.trip.reassign
    - AUTH_HS256SECRET=<СЃРµРєСЂРµС‚>
    - AUTH_ISSUER= (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ)
    - AUTH_AUDIENCE= (РѕРїС†РёРѕРЅР°Р»СЊРЅРѕ)
  - РљРѕРјР°РЅРґС‹ Р·Р°РїСѓСЃРєР° (Windows PowerShell)
    - Operator API:
      ```powershell
      cd services/operator-api
      go mod tidy
      go run ./cmd/operator-api
      ```
    - Pickup Point Service:
      ```powershell
      cd services/pickup-point-service
      go run ./cmd/pickup-point-service
      ```
    - Order/Batching/Reassignment Р°РЅР°Р»РѕРіРёС‡РЅРѕ: РїРµСЂРµР№С‚Рё РІ РєР°С‚Р°Р»РѕРі Рё Р·Р°РїСѓСЃС‚РёС‚СЊ main.go
    - SPA:
      ```powershell
      cd web/operator-panel
      npm install
      $env:VITE_API_BASE_URL="http://localhost:8090"
      npm run dev
      ```
  - РўСЂРµР±РѕРІР°РЅРёСЏ:
    - PostgreSQL Рё Kafka РґРѕР»Р¶РЅС‹ Р±С‹С‚СЊ Р·Р°РїСѓС‰РµРЅС‹; DSN Рё Р±СЂРѕРєРµСЂС‹ вЂ” РґРѕСЃС‚СѓРїРЅС‹.
    - Р”Р»СЏ Р·Р°С‰РёС‰С‘РЅРЅС‹С… РјР°СЂС€СЂСѓС‚РѕРІ РЅСѓР¶РµРЅ РґРµР№СЃС‚РІРёС‚РµР»СЊРЅС‹Р№ JWT-С‚РѕРєРµРЅ СЃ СЂРѕР»СЊСЋ.
- Р—Р°РїСѓСЃРє РІ Kubernetes (Helm)
  - РџСЂРёРјРµСЂ: operator-api
    ```bash
    helm install operator-api charts/operator-api -f charts/operator-api/values.yaml
    ```
  - РћР±СЏР·Р°С‚РµР»СЊРЅС‹Рµ СЃРµРєСЂРµС‚С‹: DSNвЂ™С‹ Рё auth_hs256secret (СЃРј. templates/secret.yaml)
- Р¤СѓРЅРєС†РёРѕРЅР°Р» Рё РІР·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ (РєРѕРЅРєСЂРµС‚РЅРѕ)
  - operator-api
    - GET /trips вЂ” СЃРїРёСЃРѕРє СЂРµР№СЃРѕРІ, С„РёР»СЊС‚СЂС‹ РїРѕ СЃС‚Р°С‚СѓСЃСѓ/РџР’Р—/РїРµСЂРµРІРѕР·С‡РёРєСѓ/РґР°С‚Рµ.
    - GET /trips/{id} вЂ” РґРµС‚Р°Р»Рё СЂРµР№СЃР°: РїР°СЂС‚РёРё Рё Р·Р°РєР°Р·С‹.
    - GET /delays вЂ” СЂРµР№СЃС‹ СЃ Р·Р°РґРµСЂР¶РєРѕР№ РѕС‚РЅРѕСЃРёС‚РµР»СЊРЅРѕ РїРѕСЂРѕРіР°.
    - GET /references/{type}?q= вЂ” РїРѕРёСЃРє РїРѕ СЃРїСЂР°РІРѕС‡РЅРёРєР°Рј.
    - POST /trips/{id}/reassign вЂ” РєРѕРјР°РЅРґР° РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёСЏ РїРµСЂРµРІРѕР·С‡РёРєР°.
    - /metrics вЂ” РјРµС‚СЂРёРєРё РґР»СЏ РЅР°Р±Р»СЋРґРµРЅРёСЏ.
  - РЎРѕР±С‹С‚РёСЏ
    - commands.trip.reassign вЂ” РєРѕРјР°РЅРґР° РЅР° СЃРјРµРЅСѓ РїРµСЂРµРІРѕР·С‡РёРєР°; РєР»СЋС‡ вЂ” trip_id; РґР°РЅРЅС‹Рµ: РЅРѕРІС‹Р№ РїРµСЂРµРІРѕР·С‡РёРє, РїСЂРёС‡РёРЅР°, РѕРїРµСЂР°С‚РѕСЂ.
    - events.batch_received_by_pvp вЂ” РїСЂРёС‘Рј РїР°СЂС‚РёРё РІ РџР’Р—.
    - trip.reassigned вЂ” РїРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ РІС‹РїРѕР»РЅРµРЅРѕ; РєР»СЋС‡ вЂ” batch_id; РґР°РЅРЅС‹Рµ: trip_id, old_trip_id, batch_id, carrier_id, assigned_at, reason, operator_id, manual_action
- Р’С…РѕРґРЅС‹Рµ/РІС‹С…РѕРґРЅС‹Рµ РґР°РЅРЅС‹Рµ
  - Р’С…РѕРґ: HTTP-Р·Р°РїСЂРѕСЃС‹ РѕС‚ РїР°РЅРµР»Рё РѕРїРµСЂР°С‚РѕСЂР°; СЃРѕР±С‹С‚РёСЏ РёР· Kafka РґР»СЏ РІРѕСЂРєРµСЂРѕРІ.
  - Р’С‹С…РѕРґ: JSON-РѕС‚РІРµС‚С‹; РЅРѕРІС‹Рµ СЃРѕР±С‹С‚РёСЏ РІ Kafka; Р·Р°РїРёСЃРё РІ Р±Р°Р·Р°С….
- РџСЂРёРјРµСЂС‹ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ (СЂРµР°Р»СЊРЅС‹Рµ РєРµР№СЃС‹)
  - РџРµСЂРµРЅР°Р·РЅР°С‡РµРЅРёРµ РїРµСЂРµРІРѕР·С‡РёРєР°:
    ```bash
    curl -H "Authorization: Bearer <token>" \
      -H "Content-Type: application/json" \
      -X POST http://localhost:8090/trips/TRIP123/reassign \
      -d '{"new_carrier_id":"CARRIER42","reason":"РїРѕР»РѕРјРєР°"}'
    ```
  - РџСЂРѕСЃРјРѕС‚СЂ Р·Р°РґРµСЂР¶РµРє Р·Р° РїРѕСЃР»РµРґРЅРёРµ 2 С‡Р°СЃР°:
    ```bash
    curl -H "Authorization: Bearer <token>" \
      "http://localhost:8090/delays?hours=2"
    ```
  - РџРѕРёСЃРє РїСѓРЅРєС‚Р° РІС‹РґР°С‡Рё РїРѕ В«РњРёРЅСЃРєВ»:
    ```bash
    curl -H "Authorization: Bearer <token>" \
      "http://localhost:8090/references/pvz?q=РњРёРЅСЃРє"
    ```
- Р”РёР°РіСЂР°РјРјС‹
  - РљРѕРјРїРѕРЅРµРЅС‚С‹ Рё РїРѕСЃР»РµРґРѕРІР°С‚РµР»СЊРЅРѕСЃС‚Рё вЂ” СЃРј. СЂР°Р·РґРµР»С‹ 1 Рё 2 (Mermaid-РіСЂР°С„С‹ СѓР¶Рµ РІРєР»СЋС‡РµРЅС‹).

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\cmd\batching-service\main.go
package main

import (
	"context"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/batching-service/internal/config"
	"bel-parcel/services/batching-service/internal/infra/db"
	"bel-parcel/services/batching-service/internal/infra/kafka"
	"bel-parcel/services/batching-service/internal/batching"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}

	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()

	batchDB, err := db.NewPgxPool(cfg.DB.DSN)
	if err != nil {
		slog.Error("failed to connect to Batch DB", "error", err)
		os.Exit(1)
	}
	defer batchDB.Close()

	producer, err := kafka.NewProducer(cfg.Kafka.Brokers, cfg.Kafka.Timeout)
	if err != nil {
		slog.Error("failed to create Kafka producer", "error", err)
		os.Exit(1)
	}
	defer producer.Close()

	consumer := kafka.NewConsumer(cfg.Kafka.Brokers, cfg.Kafka.GroupID, cfg.Kafka.ConsumeTopics, cfg.Kafka.Timeout)
	defer consumer.Close()

	svc := batching.NewService(batchDB, producer, cfg.Kafka.ProduceTopic, cfg.Batching.MaxSize, cfg.Batching.FlushInterval).WithDLQ(cfg.Kafka.DLQTopic)

	cctx, ccancel := context.WithCancel(context.Background())
	defer ccancel()
	consumer.Start(cctx, func(topic string, key, value []byte) error {
		if err := svc.HandleEvent(cctx, topic, key, value); err != nil {
			svc.PublishDLQ(cctx, topic, key, value, err)
			return err
		}
		return nil
	})

	go func() {
		t := time.NewTicker(cfg.Batching.FlushInterval)
		defer t.Stop()
		for {
			select {
			case <-cctx.Done():
				return
			case <-t.C:
				svc.FlushExpired(context.Background())
			}
		}
	}()

	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := batchDB.Ping(r.Context()); err != nil {
			slog.Error("readiness check failed", "error", err)
			http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
	}

	go func() {
		slog.Info("starting batching-service", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh

	slog.Info("shutting down gracefully...")
	ccancel()

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	_ = srv.Shutdown(ctx)
	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}
	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}
	res, _ := resource.Merge(resource.Default(), resource.NewWithAttributes(
		semconv.SchemaURL,
		semconv.ServiceName("batching-service"),
	))
	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)
	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\go.mod
module bel-parcel/services/batching-service

go 1.24.0

require (
	github.com/google/uuid v1.6.0
	github.com/jackc/pgx/v5 v5.8.0
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.15.9 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\go.sum
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.15.9 h1:wKRjX6JRtDdrE9qwa4b/Cip7ACOshUI4smpCQanqjSY=
github.com/klauspost/compress v1.15.9/go.mod h1:PhcZ0MbTNciWF3rruxRgKxI5NkcHHrHUDtV4Yw2GlzU=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\internal\batching\service.go
package batching

import (
	"context"
	"encoding/json"
	"sync"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"bel-parcel/services/batching-service/internal/infra/kafka"
)

type Service struct {
	db            *pgxpool.Pool
	producer      *kafka.Producer
	outTopic      string
	dlqTopic      string
	maxSize       int
	flushInterval time.Duration
	mu            sync.Mutex
	groups        map[string]*group
}

type group struct {
	warehouseID string
	pvpID       string
	orderIDs    []string
	updatedAt   time.Time
}

func NewService(db *pgxpool.Pool, producer *kafka.Producer, outTopic string, maxSize int, flushInterval time.Duration) *Service {
	return &Service{
		db:            db,
		producer:      producer,
		outTopic:      outTopic,
		maxSize:       maxSize,
		flushInterval: flushInterval,
		groups:        make(map[string]*group),
	}
}

func (s *Service) WithDLQ(topic string) *Service {
	s.dlqTopic = topic
	return s
}

func (s *Service) HandleEvent(ctx context.Context, topic string, key, value []byte) error {
	if topic != "orders.created" {
		return nil
	}
	var envelope struct {
		EventID       string          `json:"event_id"`
		EventType     string          `json:"event_type"`
		OccurredAt    time.Time       `json:"occurred_at"`
		CorrelationID string          `json:"correlation_id"`
		Data          json.RawMessage `json:"data"`
	}
	if err := json.Unmarshal(value, &envelope); err != nil {
		return err
	}
	if ok, _ := s.markEventProcessed(ctx, envelope.EventID); !ok {
		return nil
	}
	var data struct {
		OrderID           string    `json:"order_id"`
		SellerWarehouseID string    `json:"seller_warehouse_id"`
		PickupPointID     string    `json:"pickup_point_id"`
		CreatedAt         time.Time `json:"created_at"`
	}
	if err := json.Unmarshal(envelope.Data, &data); err != nil {
		return err
	}
	s.addToGroup(ctx, data.SellerWarehouseID, data.PickupPointID, data.OrderID)
	return nil
}

func (s *Service) PublishDLQ(ctx context.Context, originalTopic string, key []byte, value []byte, err error) {
	if s.dlqTopic == "" {
		return
	}
	envelope := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "dlq",
		"occurred_at":    time.Now().UTC(),
		"correlation_id": string(key),
		"data": map[string]interface{}{
			"original_topic": originalTopic,
			"error":          err.Error(),
			"payload":        string(value),
		},
	}
	_ = s.producer.Publish(ctx, s.dlqTopic, string(key), envelope)
}

func (s *Service) addToGroup(ctx context.Context, warehouseID, pvpID, orderID string) {
	k := warehouseID + "|" + pvpID
	now := time.Now().UTC()
	s.mu.Lock()
	g, ok := s.groups[k]
	if !ok {
		g = &group{warehouseID: warehouseID, pvpID: pvpID, orderIDs: make([]string, 0, s.maxSize), updatedAt: now}
		s.groups[k] = g
	}
	g.orderIDs = append(g.orderIDs, orderID)
	g.updatedAt = now
	shouldFlush := len(g.orderIDs) >= s.maxSize
	s.mu.Unlock()
	if shouldFlush {
		_ = s.flushGroup(ctx, k)
	}
}

func (s *Service) FlushExpired(ctx context.Context) {
	now := time.Now().UTC()
	var keys []string
	s.mu.Lock()
	for k, g := range s.groups {
		if now.Sub(g.updatedAt) >= s.flushInterval && len(g.orderIDs) > 0 {
			keys = append(keys, k)
		}
	}
	s.mu.Unlock()
	for _, k := range keys {
		_ = s.flushGroup(ctx, k)
	}
}

func (s *Service) flushGroup(ctx context.Context, key string) error {
	now := time.Now().UTC()
	s.mu.Lock()
	g, ok := s.groups[key]
	if !ok || len(g.orderIDs) == 0 {
		s.mu.Unlock()
		return nil
	}
	orderIDs := append([]string(nil), g.orderIDs...)
	g.orderIDs = g.orderIDs[:0]
	s.mu.Unlock()
	batchID := uuid.NewString()
	envelope := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "batches.formed",
		"occurred_at":    now,
		"correlation_id": g.warehouseID + "/" + g.pvpID,
		"data": map[string]interface{}{
			"batch_id":            batchID,
			"seller_warehouse_id": g.warehouseID,
			"pickup_point_id":     g.pvpID,
			"order_ids":           orderIDs,
			"formed_at":           now,
		},
	}
	return s.producer.Publish(ctx, s.outTopic, batchID, envelope)
}

func (s *Service) markEventProcessed(ctx context.Context, eventID string) (bool, error) {
	var id string
	err := s.db.QueryRow(ctx, "INSERT INTO processed_events(event_id, occurred_at) VALUES ($1, NOW()) ON CONFLICT (event_id) DO NOTHING RETURNING event_id", eventID).Scan(&id)
	if err != nil {
		return false, err
	}
	return id != "", nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		DSN string
	}
	Kafka struct {
		Brokers       []string
		Timeout       time.Duration
		GroupID       string
		ConsumeTopics []string
		ProduceTopic  string
		DLQTopic      string
	}
	Batching struct {
		MaxSize       int
		FlushInterval time.Duration
	}
	OTLP struct {
		Endpoint string
	}
}

func Load() (*Config, error) {
	v := viper.New()

	v.SetDefault("server.port", "8083")
	v.SetDefault("db.dsn", "postgres://user:pass@localhost:5432/batch_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("kafka.groupid", "batching-service")
	v.SetDefault("kafka.consumetopics", []string{"orders.created"})
	v.SetDefault("kafka.producetopic", "batches.formed")
	v.SetDefault("kafka.dlqtopic", "dlq.batching")
	v.SetDefault("batching.maxsize", 10)
	v.SetDefault("batching.flushinterval", 1*time.Minute)
	v.SetDefault("otlp.endpoint", "")

	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}

	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}
	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	cfg, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}
	cfg.MaxConns = 10
	cfg.MinConns = 1
	cfg.MaxConnLifetime = time.Hour
	cfg.MaxConnIdleTime = 10 * time.Minute
	pool, err := pgxpool.NewWithConfig(context.Background(), cfg)
	if err != nil {
		return nil, err
	}
	return pool, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\internal\infra\kafka\consumer.go
package kafka

import (
	"context"
	"time"

	"github.com/segmentio/kafka-go"
)

type Consumer struct {
	readers []*kafka.Reader
}

func NewConsumer(brokers []string, groupID string, topics []string, timeout time.Duration) *Consumer {
	var readers []*kafka.Reader
	for _, t := range topics {
		r := kafka.NewReader(kafka.ReaderConfig{
			Brokers:        brokers,
			GroupID:        groupID,
			Topic:          t,
			MaxWait:        timeout,
			CommitInterval: time.Second,
		})
		readers = append(readers, r)
	}
	return &Consumer{readers: readers}
}

func (c *Consumer) Start(ctx context.Context, handler func(topic string, key, value []byte) error) {
	for _, r := range c.readers {
		go func(reader *kafka.Reader) {
			for {
				m, err := reader.FetchMessage(ctx)
				if err != nil {
					return
				}
				if handler != nil {
					_ = handler(reader.Config().Topic, m.Key, m.Value)
				}
				_ = reader.CommitMessages(ctx, m)
			}
		}(r)
	}
}

func (c *Consumer) Close() error {
	var err error
	for _, r := range c.readers {
		e := r.Close()
		if e != nil {
			err = e
		}
	}
	return err
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\batching-service\internal\infra\kafka\kafka.go
package kafka

import (
	"context"
	"encoding/json"
	"time"

	"github.com/segmentio/kafka-go"
)

type Producer struct {
	writer *kafka.Writer
}

func NewProducer(brokers []string, timeout time.Duration) (*Producer, error) {
	w := &kafka.Writer{
		Addr:         kafka.TCP(brokers...),
		WriteTimeout: timeout,
		Balancer:     &kafka.LeastBytes{},
		RequiredAcks: kafka.RequireAll,
		Async:        true,
	}
	return &Producer{writer: w}, nil
}

func (p *Producer) Publish(ctx context.Context, topic, key string, msg interface{}) error {
	value, err := json.Marshal(msg)
	if err != nil {
		return err
	}
	return p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topic,
		Key:   []byte(key),
		Value: value,
	})
}

func (p *Producer) Close() error {
	return p.writer.Close()
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\carrier-app\cmd\carrier-app\main.go
package main

import (
	"context"
	"encoding/json"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/carrier-app/internal/app"
	"bel-parcel/services/carrier-app/internal/config"
	"bel-parcel/services/carrier-app/internal/infra/db"
	"bel-parcel/services/carrier-app/internal/infra/kafka"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}

	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()

	dbPool, err := db.NewPgxPool(cfg.DB.DSN)
	if err != nil {
		slog.Error("failed to connect to DB", "error", err)
		os.Exit(1)
	}
	defer dbPool.Close()

	producer, err := kafka.NewProducer(cfg.Kafka.Brokers, cfg.Kafka.Timeout)
	if err != nil {
		slog.Error("failed to create Kafka producer", "error", err)
		os.Exit(1)
	}
	defer producer.Close()

	svc := app.NewCarrierService(dbPool, producer, cfg.Kafka.PickedUpTopic, cfg.Kafka.DeliveredTopic)

	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := dbPool.Ping(r.Context()); err != nil {
			slog.Error("readiness check failed", "error", err)
			http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})

	mux.HandleFunc("POST /trips/{trip_id}/pickup", func(w http.ResponseWriter, r *http.Request) {
		var body struct {
			CarrierID  string             `json:"carrier_id"`
			BatchID    string             `json:"batch_id"`
			PickedUpAt time.Time          `json:"picked_up_at"`
			Location   map[string]float64 `json:"location"`
		}
		if err := json.NewDecoder(r.Body).Decode(&body); err != nil {
			http.Error(w, "bad request", http.StatusBadRequest)
			return
		}
		if err := svc.PublishPickedUp(r.Context(), body.BatchID, body.CarrierID, body.PickedUpAt, body.Location); err != nil {
			slog.Error("publish picked_up failed", "error", err, "batch_id", body.BatchID)
			http.Error(w, "internal", http.StatusInternalServerError)
			return
		}
		w.WriteHeader(http.StatusAccepted)
	})

	mux.HandleFunc("POST /trips/{trip_id}/deliver-to-pvp", func(w http.ResponseWriter, r *http.Request) {
		var body struct {
			CarrierID     string    `json:"carrier_id"`
			BatchID       string    `json:"batch_id"`
			PickupPointID string    `json:"pickup_point_id"`
			DeliveredAt   time.Time `json:"delivered_at"`
		}
		if err := json.NewDecoder(r.Body).Decode(&body); err != nil {
			http.Error(w, "bad request", http.StatusBadRequest)
			return
		}
		if err := svc.PublishDeliveredToPvp(r.Context(), body.BatchID, body.CarrierID, body.PickupPointID, body.DeliveredAt); err != nil {
			slog.Error("publish delivered_to_pvp failed", "error", err, "batch_id", body.BatchID)
			http.Error(w, "internal", http.StatusInternalServerError)
			return
		}
		w.WriteHeader(http.StatusAccepted)
	})

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
	}

	go func() {
		slog.Info("starting carrier-app", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh

	slog.Info("shutting down gracefully...")
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	_ = srv.Shutdown(ctx)
	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}
	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}
	res, _ := resource.Merge(resource.Default(), resource.NewWithAttributes(
		semconv.SchemaURL,
		semconv.ServiceName("carrier-app"),
	))
	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)
	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\carrier-app\go.mod
module bel-parcel/services/carrier-app

go 1.24.0

require (
	github.com/google/uuid v1.6.0
	github.com/jackc/pgx/v5 v5.8.0
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.15.9 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\carrier-app\go.sum
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.15.9 h1:wKRjX6JRtDdrE9qwa4b/Cip7ACOshUI4smpCQanqjSY=
github.com/klauspost/compress v1.15.9/go.mod h1:PhcZ0MbTNciWF3rruxRgKxI5NkcHHrHUDtV4Yw2GlzU=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\carrier-app\internal\app\service.go
package app

import (
	"context"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"bel-parcel/services/carrier-app/internal/infra/kafka"
)

type CarrierService struct {
	db       *pgxpool.Pool
	producer *kafka.Producer
	topics   struct {
		PickedUp   string
		Delivered  string
	}
}

func NewCarrierService(db *pgxpool.Pool, producer *kafka.Producer, pickedUpTopic, deliveredTopic string) *CarrierService {
	s := &CarrierService{db: db, producer: producer}
	s.topics.PickedUp = pickedUpTopic
	s.topics.Delivered = deliveredTopic
	return s
}

func (s *CarrierService) PublishPickedUp(ctx context.Context, batchID, carrierID string, pickedUpAt time.Time, location map[string]float64) error {
	if ok, _ := s.markPublished(ctx, "events.batch_picked_up", batchID); !ok {
		return nil
	}
	now := time.Now().UTC()
	envelope := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "events.batch_picked_up",
		"occurred_at":    now,
		"correlation_id": batchID,
		"data": map[string]interface{}{
			"batch_id":     batchID,
			"carrier_id":   carrierID,
			"picked_up_at": pickedUpAt,
			"location":     location,
		},
	}
	return s.producer.Publish(ctx, s.topics.PickedUp, batchID, envelope)
}

func (s *CarrierService) PublishDeliveredToPvp(ctx context.Context, batchID, carrierID, pickupPointID string, deliveredAt time.Time) error {
	if ok, _ := s.markPublished(ctx, "events.batch_delivered_to_pvp", batchID); !ok {
		return nil
	}
	now := time.Now().UTC()
	envelope := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "events.batch_delivered_to_pvp",
		"occurred_at":    now,
		"correlation_id": batchID,
		"data": map[string]interface{}{
			"batch_id":        batchID,
			"pickup_point_id": pickupPointID,
			"carrier_id":      carrierID,
			"delivered_at":    deliveredAt,
		},
	}
	return s.producer.Publish(ctx, s.topics.Delivered, batchID, envelope)
}

func (s *CarrierService) markPublished(ctx context.Context, eventType, correlationID string) (bool, error) {
	var et string
	err := s.db.QueryRow(ctx, `
		INSERT INTO published_events(event_type, correlation_id, occurred_at) 
		VALUES ($1, $2, NOW()) 
		ON CONFLICT (event_type, correlation_id) DO NOTHING 
		RETURNING event_type
	`, eventType, correlationID).Scan(&et)
	if err != nil {
		return false, nil
	}
	return et != "", nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\carrier-app\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		DSN string
	}
	Kafka struct {
		Brokers     []string
		Timeout     time.Duration
		PickedUpTopic string
		DeliveredTopic string
	}
	OTLP struct {
		Endpoint string
	}
}

func Load() (*Config, error) {
	v := viper.New()

	v.SetDefault("server.port", "8084")
	v.SetDefault("db.dsn", "postgres://user:pass@localhost:5432/carrier_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("kafka.pickeduptopic", "events.batch_picked_up")
	v.SetDefault("kafka.deliveredtopic", "events.batch_delivered_to_pvp")
	v.SetDefault("otlp.endpoint", "")

	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}

	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}
	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\carrier-app\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	cfg, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}
	cfg.MaxConns = 10
	cfg.MinConns = 1
	cfg.MaxConnLifetime = time.Hour
	cfg.MaxConnIdleTime = 10 * time.Minute
	return pgxpool.NewWithConfig(context.Background(), cfg)
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\carrier-app\internal\infra\kafka\kafka.go
package kafka

import (
	"context"
	"encoding/json"
	"time"

	"github.com/segmentio/kafka-go"
)

type Producer struct {
	writer *kafka.Writer
}

func NewProducer(brokers []string, timeout time.Duration) (*Producer, error) {
	w := &kafka.Writer{
		Addr:         kafka.TCP(brokers...),
		WriteTimeout: timeout,
		Balancer:     &kafka.LeastBytes{},
		RequiredAcks: kafka.RequireAll,
		Async:        true,
	}
	return &Producer{writer: w}, nil
}

func (p *Producer) Publish(ctx context.Context, topic, key string, msg interface{}) error {
	value, err := json.Marshal(msg)
	if err != nil {
		return err
	}
	return p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topic,
		Key:   []byte(key),
		Value: value,
	})
}

func (p *Producer) Close() error {
	return p.writer.Close()
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\cmd\notification-service\main.go
package main

import (
	"context"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/notification-service/internal/app"
	"bel-parcel/services/notification-service/internal/config"
	"bel-parcel/services/notification-service/internal/infra/db"
	"bel-parcel/services/notification-service/internal/infra/kafka"
	"bel-parcel/services/notification-service/internal/metrics"
	"bel-parcel/services/notification-service/internal/clients"
	"github.com/prometheus/client_golang/prometheus/promhttp"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}

	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()

	batchDB, err := db.NewPgxPool(cfg.DB.BatchDSN)
	if err != nil {
		slog.Error("failed to connect to Batch DB", "error", err)
		os.Exit(1)
	}
	defer batchDB.Close()

	metrics.Register()

	smsClient := clients.NewSMSClient(cfg.Twilio.AccountSID, cfg.Twilio.AuthToken)
	emailClient := clients.NewEmailClient(cfg.SendGrid.APIKey)

	service := app.NewNotificationService(batchDB, smsClient, emailClient)

	consumer := kafka.NewConsumer(cfg.Kafka.Brokers, cfg.Kafka.GroupID, []string{cfg.Kafka.ConsumeTopic}, cfg.Kafka.Timeout)
	cctx, ccancel := context.WithCancel(context.Background())
	defer ccancel()
	consumer.Start(cctx, func(topic string, key, value []byte) error {
		return service.HandleKafkaEvent(cctx, topic, key, value)
	})

	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := batchDB.Ping(r.Context()); err != nil {
			http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.Handle("GET /metrics", promhttp.Handler())

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
	}

	go func() {
		slog.Info("starting notification-service", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh

	slog.Info("shutting down gracefully...")
	ccancel()
	time.Sleep(2 * time.Second)
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	srv.Shutdown(ctx)
	consumer.Close()
	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}

	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}

	res, _ := resource.Merge(
		resource.Default(),
		resource.NewWithAttributes(
			semconv.SchemaURL,
			semconv.ServiceName("notification-service"),
		),
	)

	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)

	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\go.mod
module bel-parcel/services/notification-service

go 1.24.0

require (
	github.com/jackc/pgx/v5 v5.8.0
	github.com/prometheus/client_golang v1.23.2
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/beorn7/perks v1.0.1 // indirect
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/google/uuid v1.6.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.18.0 // indirect
	github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/prometheus/client_model v0.6.2 // indirect
	github.com/prometheus/common v0.66.1 // indirect
	github.com/prometheus/procfs v0.16.1 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v2 v2.4.2 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\go.sum
github.com/beorn7/perks v1.0.1 h1:VlbKKnNfV8bJzeqoa4cOKqO6bYr3WgKZxO8Z16+hsOM=
github.com/beorn7/perks v1.0.1/go.mod h1:G2ZrVWU2WbWT9wwq4/hrbKbnv/1ERSJQ0ibhJ6rlkpw=
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.18.0 h1:c/Cqfb0r+Yi+JtIEq73FWXVkRonBlf0CRNYc8Zttxdo=
github.com/klauspost/compress v1.18.0/go.mod h1:2Pp+KzxcywXVXMr50+X0Q/Lsb43OQHYWRCY2AiWywWQ=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/kylelemons/godebug v1.1.0 h1:RPNrshWIDI6G2gRW9EHilWtl7Z6Sb1BR0xunSBf0SNc=
github.com/kylelemons/godebug v1.1.0/go.mod h1:9/0rRGxNHcop5bhtWyNeEfOS8JIWk580+fNqagV/RAw=
github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822 h1:C3w9PqII01/Oq1c1nUAm88MOHcQC9l5mIlSMApZMrHA=
github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822/go.mod h1:+n7T8mK8HuQTcFwEeznm/DIxMOiR9yIdICNftLE1DvQ=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/prometheus/client_golang v1.23.2 h1:Je96obch5RDVy3FDMndoUsjAhG5Edi49h0RJWRi/o0o=
github.com/prometheus/client_golang v1.23.2/go.mod h1:Tb1a6LWHB3/SPIzCoaDXI4I8UHKeFTEQ1YCr+0Gyqmg=
github.com/prometheus/client_model v0.6.2 h1:oBsgwpGs7iVziMvrGhE53c/GrLUsZdHnqNwqPLxwZyk=
github.com/prometheus/client_model v0.6.2/go.mod h1:y3m2F6Gdpfy6Ut/GBsUqTWZqCUvMVzSfMLjcu6wAwpE=
github.com/prometheus/common v0.66.1 h1:h5E0h5/Y8niHc5DlaLlWLArTQI7tMrsfQjHV+d9ZoGs=
github.com/prometheus/common v0.66.1/go.mod h1:gcaUsgf3KfRSwHY4dIMXLPV0K/Wg1oZ8+SbZk/HH/dA=
github.com/prometheus/procfs v0.16.1 h1:hZ15bTNuirocR6u0JZ6BAHHmwS1p8B4P6MRqxtzMyRg=
github.com/prometheus/procfs v0.16.1/go.mod h1:teAbpZRB1iIAJYREa1LsoWUXykVXA1KlTmWl8x/U+Is=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v2 v2.4.2 h1:DzmwEr2rDGHl7lsFgAHxmNz/1NlQ7xLIrlN2h5d1eGI=
go.yaml.in/yaml/v2 v2.4.2/go.mod h1:081UH+NErpNdqlCXm3TtEran0rJZGxAYx9hb/ELlsPU=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\app\service.go
package app

import (
	"context"
	"encoding/json"
	"log/slog"
	"time"

	"bel-parcel/services/notification-service/internal/clients"
	"bel-parcel/services/notification-service/internal/metrics"
	"github.com/jackc/pgx/v5/pgxpool"
)

type NotificationService struct {
	db          *pgxpool.Pool
	sms         interface{ Send(ctx context.Context, to, body string) error }
	email       interface{ Send(ctx context.Context, to, subject, body string) error }
	listOrders  func(ctx context.Context, batchID string) ([]string, error)
	markProcessed func(ctx context.Context, eventID string) (bool, error)
}

func NewNotificationService(db *pgxpool.Pool, sms *clients.SMSClient, email *clients.EmailClient) *NotificationService {
	s := &NotificationService{
		db:    db,
		sms:   sms,
		email: email,
	}
	s.listOrders = s.defaultListOrders
	s.markProcessed = s.defaultMarkProcessed
	return s
}

func (s *NotificationService) HandleKafkaEvent(ctx context.Context, topic string, key, value []byte) error {
	var envelope struct {
		EventID       string         `json:"event_id"`
		EventType     string         `json:"event_type"`
		OccurredAt    time.Time      `json:"occurred_at"`
		CorrelationID string         `json:"correlation_id"`
		Data          map[string]any `json:"data"`
	}
	if err := json.Unmarshal(value, &envelope); err != nil {
		return nil
	}
	if envelope.EventType != "events.batch_received_by_pvp" {
		return nil
	}
	batchID := envelope.CorrelationID
	ok, err := s.markProcessed(ctx, envelope.EventID)
	if err != nil || !ok {
		return err
	}
	orders, err := s.listOrders(ctx, batchID)
	if err != nil {
		return err
	}
	for _, oid := range orders {
		contactEmail := "test@example.com"
		contactPhone := "+375291234567"
		body := "Р’Р°С€Р° РїРѕСЃС‹Р»РєР° РіРѕС‚РѕРІР° Рє РІС‹РґР°С‡Рµ РІ РџР’Р—"
		if err := s.sms.Send(ctx, contactPhone, body); err != nil {
			metrics.NotificationSentTotal.WithLabelValues("sms", "failure").Inc()
		} else {
			metrics.NotificationSentTotal.WithLabelValues("sms", "success").Inc()
			slog.InfoContext(ctx, "notification sent", "batch_id", batchID, "order_id", oid, "contact", contactPhone)
		}
		if err := s.email.Send(ctx, contactEmail, "РџРѕСЃС‹Р»РєР° РіРѕС‚РѕРІР° Рє РІС‹РґР°С‡Рµ", body); err != nil {
			metrics.NotificationSentTotal.WithLabelValues("email", "failure").Inc()
		} else {
			metrics.NotificationSentTotal.WithLabelValues("email", "success").Inc()
			slog.InfoContext(ctx, "notification sent", "batch_id", batchID, "order_id", oid, "contact", contactEmail)
		}
	}
	return nil
}

func (s *NotificationService) defaultListOrders(ctx context.Context, batchID string) ([]string, error) {
	ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
	defer cancel()
	rows, err := s.db.Query(ctx, "SELECT order_id FROM batch_orders WHERE batch_id=$1", batchID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var res []string
	for rows.Next() {
		var oid string
		_ = rows.Scan(&oid)
		res = append(res, oid)
	}
	return res, rows.Err()
}

func (s *NotificationService) defaultMarkProcessed(ctx context.Context, eventID string) (bool, error) {
	ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
	defer cancel()
	var eid string
	err := s.db.QueryRow(ctx, `
		INSERT INTO processed_events(event_id, occurred_at)
		VALUES ($1, NOW())
		ON CONFLICT (event_id) DO NOTHING
		RETURNING event_id
	`, eventID).Scan(&eid)
	if err != nil {
		return false, err
	}
	return eid != "", nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\app\service_test.go
package app

import (
	"context"
	"testing"
)

type fakeSMS struct{}
func (f *fakeSMS) Send(ctx context.Context, to, body string) error { return nil }
type fakeEmail struct{}
func (f *fakeEmail) Send(ctx context.Context, to, subject, body string) error { return nil }

func TestHandleKafkaEvent_SendsNotifications(t *testing.T) {
	s := &NotificationService{}
	s.sms = &fakeSMS{}
	s.email = &fakeEmail{}
	s.listOrders = func(ctx context.Context, batchID string) ([]string, error) { return []string{"o1","o2"}, nil }
	s.markProcessed = func(ctx context.Context, eventID string) (bool, error) { return true, nil }
	// Minimal envelope
	payload := []byte(`{"event_id":"e1","event_type":"events.batch_received_by_pvp","correlation_id":"b1","data":{}}`)
	if err := s.HandleKafkaEvent(context.Background(), "events.batch_received_by_pvp", []byte("b1"), payload); err != nil {
		t.Fatalf("unexpected error: %v", err)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\clients\email.go
package clients

import (
	"context"
	"log/slog"
)

type EmailClient struct {
	apiKey string
}

func NewEmailClient(apiKey string) *EmailClient {
	return &EmailClient{apiKey: apiKey}
}

func (c *EmailClient) Send(ctx context.Context, to, subject, body string) error {
	slog.InfoContext(ctx, "email send", "to", to, "subject", subject)
	return nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\clients\sms.go
package clients

import (
	"context"
	"log/slog"
)

type SMSClient struct {
	accountSID string
	authToken  string
}

func NewSMSClient(accountSID, authToken string) *SMSClient {
	return &SMSClient{accountSID: accountSID, authToken: authToken}
}

func (c *SMSClient) Send(ctx context.Context, to, body string) error {
	slog.InfoContext(ctx, "sms send", "to", to, "body", body)
	return nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		BatchDSN string
	}
	Kafka struct {
		Brokers     []string
		GroupID     string
		ConsumeTopic string
		Timeout     time.Duration
	}
	OTLP struct {
		Endpoint string
	}
	Twilio struct {
		AccountSID string
		AuthToken  string
	}
	SendGrid struct {
		APIKey string
	}
}

func Load() (*Config, error) {
	v := viper.New()

	v.SetDefault("server.port", "8086")
	v.SetDefault("db.batchdsn", "postgres://user:pass@localhost:5432/batch_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.groupid", "notification-service")
	v.SetDefault("kafka.consumetopic", "events.batch_received_by_pvp")
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("otlp.endpoint", "")
	v.SetDefault("twilio.accountsid", "")
	v.SetDefault("twilio.authtoken", "")
	v.SetDefault("sendgrid.apikey", "")

	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}

	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}
	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	config, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}
	config.MaxConns = 10
	config.MinConns = 2
	config.MaxConnLifetime = 30 * time.Minute
	config.HealthCheckPeriod = 1 * time.Minute

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	pool, err := pgxpool.NewWithConfig(ctx, config)
	if err != nil {
		return nil, err
	}
	if err := pool.Ping(ctx); err != nil {
		pool.Close()
		return nil, err
	}
	return pool, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\infra\kafka\consumer.go
package kafka

import (
	"context"
	"time"

	"github.com/segmentio/kafka-go"
)

type Consumer struct {
	readers []*kafka.Reader
}

func NewConsumer(brokers []string, groupID string, topics []string, timeout time.Duration) *Consumer {
	var readers []*kafka.Reader
	for _, t := range topics {
		r := kafka.NewReader(kafka.ReaderConfig{
			Brokers:        brokers,
			GroupID:        groupID,
			Topic:          t,
			MaxWait:        timeout,
			CommitInterval: time.Second,
		})
		readers = append(readers, r)
	}
	return &Consumer{readers: readers}
}

func (c *Consumer) Start(ctx context.Context, handler func(topic string, key, value []byte) error) {
	for _, r := range c.readers {
		go func(reader *kafka.Reader) {
			for {
				m, err := reader.FetchMessage(ctx)
				if err != nil {
					return
				}
				if handler != nil {
					if e := handler(reader.Config().Topic, m.Key, m.Value); e == nil {
						_ = reader.CommitMessages(ctx, m)
					}
				}
			}
		}(r)
	}
}

func (c *Consumer) Close() error {
	var err error
	for _, r := range c.readers {
		if e := r.Close(); e != nil {
			err = e
		}
	}
	return err
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\notification-service\internal\metrics\metrics.go
package metrics

import (
	"github.com/prometheus/client_golang/prometheus"
)

var (
	NotificationSentTotal = prometheus.NewCounterVec(
		prometheus.CounterOpts{
			Name: "notification_sent_total",
			Help: "Total notifications sent by channel and status",
		},
		[]string{"channel", "status"},
	)
)

func Register() {
	prometheus.MustRegister(NotificationSentTotal)
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\cmd\operator-api\main.go
package main

import (
	"context"
	"encoding/json"
	"log/slog"
	"net/http"
	"strconv"
	"time"
	"os"
	"os/signal"
	"syscall"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/operator-api/internal/app"
	"bel-parcel/services/operator-api/internal/auth"
	"bel-parcel/services/operator-api/internal/config"
	"bel-parcel/services/operator-api/internal/infra/db"
	"bel-parcel/services/operator-api/internal/infra/kafka"
	"github.com/prometheus/client_golang/prometheus"
	"github.com/prometheus/client_golang/prometheus/promhttp"
)

type statusRecorder struct {
	http.ResponseWriter
	status int
}

func (sr *statusRecorder) WriteHeader(code int) {
	sr.status = code
	sr.ResponseWriter.WriteHeader(code)
}

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}
	if cfg.Auth.HS256Secret == "" {
		slog.Error("empty AUTH_HS256SECRET, refusing to start")
		os.Exit(1)
	}
	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()
	tripDB, err := db.NewPgxPool(cfg.DB.TripDSN)
	if err != nil {
		slog.Error("failed to connect trip DB", "error", err)
		os.Exit(1)
	}
	defer tripDB.Close()
	batchDB, err := db.NewPgxPool(cfg.DB.BatchDSN)
	if err != nil {
		slog.Error("failed to connect batch DB", "error", err)
		os.Exit(1)
	}
	defer batchDB.Close()
	refDB, err := db.NewPgxPool(cfg.DB.ReferenceDSN)
	if err != nil {
		slog.Error("failed to connect reference DB", "error", err)
		os.Exit(1)
	}
	defer refDB.Close()
	producer, err := kafka.NewProducer(cfg.Kafka.Brokers, cfg.Kafka.Timeout)
	if err != nil {
		slog.Error("failed to create Kafka producer", "error", err)
		os.Exit(1)
	}
	defer producer.Close()
	svc := app.NewService(tripDB, batchDB, refDB, producer, cfg.Kafka.CommandTopic)
	validator := auth.NewValidator(cfg.Auth.HS256Secret, cfg.Auth.Issuer, cfg.Auth.Audience)

	reqDuration := prometheus.NewHistogramVec(
		prometheus.HistogramOpts{
			Name:    "http_request_duration_seconds",
			Help:    "Duration of HTTP requests.",
			Buckets: []float64{0.05, 0.1, 0.3, 0.5, 1.0, 2.0, 5.0},
		},
		[]string{"method", "route", "code"},
	)
	reqTotal := prometheus.NewCounterVec(
		prometheus.CounterOpts{
			Name: "http_requests_total",
			Help: "Total number of HTTP requests.",
		},
		[]string{"method", "route", "code"},
	)
	prometheus.MustRegister(reqDuration, reqTotal)

	measure := func(route string, h http.HandlerFunc) http.HandlerFunc {
		return func(w http.ResponseWriter, r *http.Request) {
			start := time.Now()
			rec := &statusRecorder{ResponseWriter: w, status: 200}
			h(rec, r)
			el := time.Since(start).Seconds()
			code := strconv.Itoa(rec.status)
			reqDuration.WithLabelValues(r.Method, route, code).Observe(el)
			reqTotal.WithLabelValues(r.Method, route, code).Inc()
		}
	}

	writeJSONError := func(w http.ResponseWriter, status int, message string) {
		w.Header().Set("Content-Type", "application/json")
		w.WriteHeader(status)
		json.NewEncoder(w).Encode(map[string]string{"error": message})
	}

	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := tripDB.Ping(r.Context()); err != nil {
			writeJSONError(w, http.StatusServiceUnavailable, "tripDB unavailable")
			return
		}
		if err := batchDB.Ping(r.Context()); err != nil {
			writeJSONError(w, http.StatusServiceUnavailable, "batchDB unavailable")
			return
		}
		if err := refDB.Ping(r.Context()); err != nil {
			writeJSONError(w, http.StatusServiceUnavailable, "referenceDB unavailable")
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /trips", measure("/trips", auth.RequireRoles(validator, []string{"user", "moderator", "admin"}, func(w http.ResponseWriter, r *http.Request) {
		status := r.URL.Query().Get("status")
		if status != "" {
			allowed := map[string]bool{
				"ASSIGNED":     true,
				"IN_TRANSIT":   true,
				"DELIVERED":    true,
				"FAILED":       true,
				"PENDING":      true,
			}
			if !allowed[status] {
				writeJSONError(w, http.StatusBadRequest, "invalid status")
				return
			}
		}
		pvz := r.URL.Query().Get("pvz")
		carrier := r.URL.Query().Get("carrier")
		var datePtr *time.Time
		if d := r.URL.Query().Get("date"); d != "" {
			if t, e := time.Parse("2006-01-02", d); e == nil {
				datePtr = &t
			}
		}
		trips, err := svc.ListTrips(r.Context(), status, pvz, carrier, datePtr)
		if err != nil {
			slog.Error("list trips failed", "error", err)
			writeJSONError(w, http.StatusInternalServerError, "internal")
			return
		}
		w.Header().Set("Content-Type", "application/json")
		json.NewEncoder(w).Encode(trips)
	})))
	mux.HandleFunc("GET /trips/{trip_id}", measure("/trips/{trip_id}", auth.RequireRoles(validator, []string{"user", "moderator", "admin"}, func(w http.ResponseWriter, r *http.Request) {
		id := r.PathValue("trip_id")
		d, err := svc.TripDetails(r.Context(), id)
		if err != nil {
			slog.Error("trip details failed", "error", err, "trip_id", id)
			writeJSONError(w, http.StatusNotFound, "not found")
			return
		}
		w.Header().Set("Content-Type", "application/json")
		json.NewEncoder(w).Encode(d)
	})))
	mux.HandleFunc("POST /trips/{trip_id}/reassign", measure("/trips/{trip_id}/reassign", auth.RequireRoles(validator, []string{"moderator", "admin"}, func(w http.ResponseWriter, r *http.Request) {
		id := r.PathValue("trip_id")
		var body struct {
			NewCarrierID string `json:"new_carrier_id"`
			Reason string `json:"reason"`
		}
		if err := json.NewDecoder(r.Body).Decode(&body); err != nil {
			writeJSONError(w, http.StatusBadRequest, "bad request")
			return
		}
		if body.NewCarrierID == "" || body.Reason == "" {
			writeJSONError(w, http.StatusBadRequest, "bad request")
			return
		}
		u := auth.FromContext(r)
		if u == nil {
			writeJSONError(w, http.StatusUnauthorized, "unauthorized")
			return
		}
		if err := svc.ReassignTrip(r.Context(), id, body.NewCarrierID, body.Reason, u.ID); err != nil {
			slog.Error("reassign failed", "error", err, "trip_id", id)
			writeJSONError(w, http.StatusInternalServerError, "internal")
			return
		}
		w.WriteHeader(http.StatusAccepted)
	})))
	mux.HandleFunc("GET /delays", measure("/delays", auth.RequireRoles(validator, []string{"user", "moderator", "admin"}, func(w http.ResponseWriter, r *http.Request) {
		h := 1.5
		if v := r.URL.Query().Get("hours"); v != "" {
			if t, e := time.ParseDuration(v + "h"); e == nil {
				h = t.Hours()
			}
		}
		trips, err := svc.MonitorDelays(r.Context(), time.Duration(h*float64(time.Hour)))
		if err != nil {
			slog.Error("monitor delays failed", "error", err)
			writeJSONError(w, http.StatusInternalServerError, "internal")
			return
		}
		w.Header().Set("Content-Type", "application/json")
		json.NewEncoder(w).Encode(trips)
	})))
	mux.HandleFunc("GET /references/{type}", measure("/references/{type}", auth.RequireRoles(validator, []string{"user", "moderator", "admin"}, func(w http.ResponseWriter, r *http.Request) {
		typ := r.PathValue("type")
		allowedTypes := map[string]bool{"warehouses": true, "pvz": true, "carriers": true}
		if !allowedTypes[typ] {
			writeJSONError(w, http.StatusBadRequest, "invalid type")
			return
		}
		q := r.URL.Query().Get("q")
		refs, err := svc.SearchReferences(r.Context(), typ, q)
		if err != nil {
			slog.Error("search references failed", "error", err, "type", typ)
			writeJSONError(w, http.StatusInternalServerError, "internal")
			return
		}
		w.Header().Set("Content-Type", "application/json")
		json.NewEncoder(w).Encode(refs)
	})))
	mux.Handle("GET /metrics", promhttp.Handler())
	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
		ReadTimeout: 5 * time.Second,
		WriteTimeout: 10 * time.Second,
		IdleTimeout: 60 * time.Second,
	}
	go func() {
		slog.Info("starting operator-api", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()
	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh
	slog.Info("shutting down gracefully...")
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	_ = srv.Shutdown(ctx)
	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		return func() {}
	}
	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		return func() {}
	}
	res, _ := resource.Merge(resource.Default(), resource.NewWithAttributes(
		semconv.SchemaURL,
		semconv.ServiceName("operator-api"),
	))
	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)
	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\go.mod
module bel-parcel/services/operator-api

go 1.24.0

require (
	github.com/golang-jwt/jwt/v5 v5.3.0
	github.com/google/uuid v1.6.0
	github.com/jackc/pgx/v5 v5.8.0
	github.com/prometheus/client_golang v1.23.2
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/beorn7/perks v1.0.1 // indirect
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.18.0 // indirect
	github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/prometheus/client_model v0.6.2 // indirect
	github.com/prometheus/common v0.66.1 // indirect
	github.com/prometheus/procfs v0.16.1 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v2 v2.4.2 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\go.sum
github.com/beorn7/perks v1.0.1 h1:VlbKKnNfV8bJzeqoa4cOKqO6bYr3WgKZxO8Z16+hsOM=
github.com/beorn7/perks v1.0.1/go.mod h1:G2ZrVWU2WbWT9wwq4/hrbKbnv/1ERSJQ0ibhJ6rlkpw=
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang-jwt/jwt/v5 v5.3.0 h1:pv4AsKCKKZuqlgs5sUmn4x8UlGa0kEVt/puTpKx9vvo=
github.com/golang-jwt/jwt/v5 v5.3.0/go.mod h1:fxCRLWMO43lRc8nhHWY6LGqRcf+1gQWArsqaEUEa5bE=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.18.0 h1:c/Cqfb0r+Yi+JtIEq73FWXVkRonBlf0CRNYc8Zttxdo=
github.com/klauspost/compress v1.18.0/go.mod h1:2Pp+KzxcywXVXMr50+X0Q/Lsb43OQHYWRCY2AiWywWQ=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/kylelemons/godebug v1.1.0 h1:RPNrshWIDI6G2gRW9EHilWtl7Z6Sb1BR0xunSBf0SNc=
github.com/kylelemons/godebug v1.1.0/go.mod h1:9/0rRGxNHcop5bhtWyNeEfOS8JIWk580+fNqagV/RAw=
github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822 h1:C3w9PqII01/Oq1c1nUAm88MOHcQC9l5mIlSMApZMrHA=
github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822/go.mod h1:+n7T8mK8HuQTcFwEeznm/DIxMOiR9yIdICNftLE1DvQ=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/prometheus/client_golang v1.23.2 h1:Je96obch5RDVy3FDMndoUsjAhG5Edi49h0RJWRi/o0o=
github.com/prometheus/client_golang v1.23.2/go.mod h1:Tb1a6LWHB3/SPIzCoaDXI4I8UHKeFTEQ1YCr+0Gyqmg=
github.com/prometheus/client_model v0.6.2 h1:oBsgwpGs7iVziMvrGhE53c/GrLUsZdHnqNwqPLxwZyk=
github.com/prometheus/client_model v0.6.2/go.mod h1:y3m2F6Gdpfy6Ut/GBsUqTWZqCUvMVzSfMLjcu6wAwpE=
github.com/prometheus/common v0.66.1 h1:h5E0h5/Y8niHc5DlaLlWLArTQI7tMrsfQjHV+d9ZoGs=
github.com/prometheus/common v0.66.1/go.mod h1:gcaUsgf3KfRSwHY4dIMXLPV0K/Wg1oZ8+SbZk/HH/dA=
github.com/prometheus/procfs v0.16.1 h1:hZ15bTNuirocR6u0JZ6BAHHmwS1p8B4P6MRqxtzMyRg=
github.com/prometheus/procfs v0.16.1/go.mod h1:teAbpZRB1iIAJYREa1LsoWUXykVXA1KlTmWl8x/U+Is=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v2 v2.4.2 h1:DzmwEr2rDGHl7lsFgAHxmNz/1NlQ7xLIrlN2h5d1eGI=
go.yaml.in/yaml/v2 v2.4.2/go.mod h1:081UH+NErpNdqlCXm3TtEran0rJZGxAYx9hb/ELlsPU=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\internal\app\service.go
package app

import (
	"context"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"bel-parcel/services/operator-api/internal/infra/kafka"
	"strconv"
)

type Trip struct {
	ID string `json:"id"`
	OriginWarehouseID string `json:"origin_warehouse_id"`
	PickupPointID string `json:"pickup_point_id"`
	CarrierID string `json:"carrier_id"`
	AssignedAt time.Time `json:"assigned_at"`
	Status string `json:"status"`
}

type Reference struct {
	ID string `json:"id"`
	Name string `json:"name"`
	Type string `json:"type"`
}

type Service struct {
	tripDB *pgxpool.Pool
	batchDB *pgxpool.Pool
	refDB *pgxpool.Pool
	producer *kafka.Producer
	commandTopic string
}

func NewService(tripDB, batchDB, refDB *pgxpool.Pool, producer *kafka.Producer, commandTopic string) *Service {
	return &Service{tripDB: tripDB, batchDB: batchDB, refDB: refDB, producer: producer, commandTopic: commandTopic}
}

func (s *Service) ListTrips(ctx context.Context, status, pvz, carrier string, date *time.Time) ([]Trip, error) {
	q := "SELECT id, origin_warehouse_id, pickup_point_id, carrier_id, assigned_at, status FROM trips WHERE 1=1"
	args := []interface{}{}
	i := 1
	if status != "" {
		q += " AND status=$" + itoa(i)
		args = append(args, status)
		i++
	}
	if pvz != "" {
		q += " AND pickup_point_id=$" + itoa(i)
		args = append(args, pvz)
		i++
	}
	if carrier != "" {
		q += " AND carrier_id=$" + itoa(i)
		args = append(args, carrier)
		i++
	}
	if date != nil {
		q += " AND DATE(assigned_at)=$" + itoa(i)
		args = append(args, date.Format("2006-01-02"))
		i++
	}
	rows, err := s.tripDB.Query(ctx, q, args...)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var res []Trip
	for rows.Next() {
		var t Trip
		if err := rows.Scan(&t.ID, &t.OriginWarehouseID, &t.PickupPointID, &t.CarrierID, &t.AssignedAt, &t.Status); err != nil {
			return nil, err
		}
		res = append(res, t)
	}
	return res, rows.Err()
}

func (s *Service) TripDetails(ctx context.Context, tripID string) (map[string]interface{}, error) {
	var trip Trip
	err := s.tripDB.QueryRow(ctx, "SELECT id, origin_warehouse_id, pickup_point_id, carrier_id, assigned_at, status FROM trips WHERE id=$1", tripID).Scan(&trip.ID, &trip.OriginWarehouseID, &trip.PickupPointID, &trip.CarrierID, &trip.AssignedAt, &trip.Status)
	if err != nil {
		return nil, err
	}
	batchesRows, err := s.batchDB.Query(ctx, "SELECT batch_id FROM trip_batches WHERE trip_id=$1", tripID)
	if err != nil {
		return nil, err
	}
	defer batchesRows.Close()
	var batchIDs []string
	for batchesRows.Next() {
		var bid string
		if err := batchesRows.Scan(&bid); err != nil {
			return nil, err
		}
		batchIDs = append(batchIDs, bid)
	}
	var orders []string
	for _, bid := range batchIDs {
		rows, e := s.batchDB.Query(ctx, "SELECT order_id FROM batch_orders WHERE batch_id=$1", bid)
		if e != nil {
			return nil, e
		}
		for rows.Next() {
			var oid string
			if err := rows.Scan(&oid); err != nil {
				rows.Close()
				return nil, err
			}
			orders = append(orders, oid)
		}
		rows.Close()
	}
	return map[string]interface{}{
		"trip": trip,
		"batches": batchIDs,
		"orders": orders,
	}, nil
}

func (s *Service) ReassignTrip(ctx context.Context, tripID, newCarrierID, reason, operatorID string) error {
	ok, err := s.markPublished(ctx, "commands.trip.reassign", tripID)
	if err != nil {
		return err
	}
	if !ok {
		return nil
	}
	now := time.Now().UTC()
	envelope := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "commands.trip.reassign",
		"occurred_at":    now,
		"correlation_id": tripID,
		"data": map[string]interface{}{
			"trip_id":        tripID,
			"new_carrier_id": newCarrierID,
			"reason":         reason,
			"requested_at":   now,
			"operator_id":    operatorID,
		},
	}
	return s.producer.Publish(ctx, s.commandTopic, tripID, envelope)
}

func (s *Service) MonitorDelays(ctx context.Context, threshold time.Duration) ([]Trip, error) {
	rows, err := s.tripDB.Query(ctx, "SELECT id, origin_warehouse_id, pickup_point_id, carrier_id, assigned_at, status FROM trips WHERE status!='in_transit' AND NOW() - assigned_at > $1", threshold)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var res []Trip
	for rows.Next() {
		var t Trip
		if err := rows.Scan(&t.ID, &t.OriginWarehouseID, &t.PickupPointID, &t.CarrierID, &t.AssignedAt, &t.Status); err != nil {
			return nil, err
		}
		res = append(res, t)
	}
	return res, rows.Err()
}

func (s *Service) SearchReferences(ctx context.Context, typ, q string) ([]Reference, error) {
	table := ""
	if typ == "warehouses" {
		table = "warehouses"
	} else if typ == "pvz" {
		table = "pickup_points"
	} else if typ == "carriers" {
		table = "carriers"
	} else {
		return []Reference{}, nil
	}
	rows, err := s.refDB.Query(ctx, "SELECT id, name FROM "+table+" WHERE name ILIKE $1 LIMIT 50", "%"+q+"%")
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var res []Reference
	for rows.Next() {
		var r Reference
		if err := rows.Scan(&r.ID, &r.Name); err != nil {
			return nil, err
		}
		r.Type = typ
		res = append(res, r)
	}
	return res, rows.Err()
}

func (s *Service) markPublished(ctx context.Context, eventType, correlationID string) (bool, error) {
	var et string
	err := s.tripDB.QueryRow(ctx, `
		INSERT INTO published_events(event_type, correlation_id, occurred_at)
		VALUES ($1, $2, NOW())
		ON CONFLICT (event_type, correlation_id) DO NOTHING
		RETURNING event_type
	`, eventType, correlationID).Scan(&et)
	if err != nil {
		return false, err
	}
	return et != "", nil
}

func itoa(i int) string {
	return strconv.Itoa(i)
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\internal\auth\auth.go
package auth

import (
	"context"
	"errors"
	"net/http"
	"strings"
	"time"

	"github.com/golang-jwt/jwt/v5"
)

type Validator struct {
	secret   []byte
	issuer   string
	audience string
}

func NewValidator(secret, issuer, audience string) *Validator {
	return &Validator{
		secret:   []byte(secret),
		issuer:   issuer,
		audience: audience,
	}
}

type Claims struct {
	jwt.RegisteredClaims
	Role string `json:"role"`
}

func (v *Validator) verify(tokenString string) (*Claims, error) {
	claims := &Claims{}
	token, err := jwt.ParseWithClaims(tokenString, claims, func(t *jwt.Token) (interface{}, error) {
		if _, ok := t.Method.(*jwt.SigningMethodHMAC); !ok {
			return nil, errors.New("unexpected signing method")
		}
		return v.secret, nil
	})
	if err != nil || !token.Valid {
		return nil, errors.New("invalid token")
	}
	if claims.ExpiresAt != nil && time.Now().After(claims.ExpiresAt.Time) {
		return nil, errors.New("token expired")
	}
	if v.issuer != "" && claims.Issuer != v.issuer {
		return nil, errors.New("invalid issuer")
	}
	if v.audience != "" {
		ok := false
		for _, a := range claims.Audience {
			if a == v.audience {
				ok = true
				break
			}
		}
		if !ok {
			return nil, errors.New("invalid audience")
		}
	}
	return claims, nil
}

type ctxKey string

const userKey ctxKey = "auth_user"

type User struct {
	ID   string
	Role string
}

func FromContext(r *http.Request) *User {
	if u, ok := r.Context().Value(userKey).(*User); ok {
		return u
	}
	return nil
}

func RequireRoles(v *Validator, roles []string, next http.HandlerFunc) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		header := r.Header.Get("Authorization")
		parts := strings.SplitN(header, " ", 2)
		if len(parts) != 2 || !strings.EqualFold(parts[0], "Bearer") {
			http.Error(w, "unauthorized", http.StatusUnauthorized)
			return
		}
		claims, err := v.verify(parts[1])
		if err != nil {
			http.Error(w, "unauthorized", http.StatusUnauthorized)
			return
		}
		if !roleAllowed(claims.Role, roles) {
			http.Error(w, "forbidden", http.StatusForbidden)
			return
		}
		u := &User{ID: claims.Subject, Role: claims.Role}
		ctx := context.WithValue(r.Context(), userKey, u)
		next(w, r.WithContext(ctx))
	}
}

func roleAllowed(role string, allowed []string) bool {
	for _, a := range allowed {
		if role == a {
			return true
		}
	}
	return false
}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		TripDSN     string
		BatchDSN    string
		ReferenceDSN string
	}
	Kafka struct {
		Brokers []string
		Timeout time.Duration
		CommandTopic string
	}
	OTLP struct {
		Endpoint string
	}
	Auth struct {
		HS256Secret string
		Issuer      string
		Audience    string
	}
}

func Load() (*Config, error) {
	v := viper.New()
	v.SetDefault("server.port", "8090")
	v.SetDefault("db.tripdsn", "postgres://user:pass@localhost:5432/trip_db?sslmode=disable")
	v.SetDefault("db.batchdsn", "postgres://user:pass@localhost:5432/batch_db?sslmode=disable")
	v.SetDefault("db.referencedsn", "postgres://user:pass@localhost:5432/reference_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("kafka.commandtopic", "commands.trip.reassign")
	v.SetDefault("otlp.endpoint", "")
	v.SetDefault("auth.hs256secret", "")
	v.SetDefault("auth.issuer", "")
	v.SetDefault("auth.audience", "")
	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")
	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()
	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}
	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}
	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	cfg, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}
	cfg.MaxConns = 20
	cfg.MinConns = 5
	cfg.MaxConnLifetime = 30 * time.Minute
	cfg.HealthCheckPeriod = 1 * time.Minute
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	p, err := pgxpool.NewWithConfig(ctx, cfg)
	if err != nil {
		return nil, err
	}
	if err := p.Ping(ctx); err != nil {
		p.Close()
		return nil, err
	}
	return p, nil
}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\operator-api\internal\infra\kafka\kafka.go
package kafka

import (
	"context"
	"encoding/json"
	"time"

	"github.com/segmentio/kafka-go"
)

type Producer struct {
	writer *kafka.Writer
}

func NewProducer(brokers []string, timeout time.Duration) (*Producer, error) {
	w := &kafka.Writer{
		Addr:         kafka.TCP(brokers...),
		WriteTimeout: timeout,
		Balancer:     &kafka.LeastBytes{},
		RequiredAcks: kafka.RequireAll,
		Async:        false,
	}
	return &Producer{writer: w}, nil
}

func (p *Producer) Publish(ctx context.Context, topic, key string, msg interface{}) error {
	value, err := json.Marshal(msg)
	if err != nil {
		return err
	}
	return p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topic,
		Key:   []byte(key),
		Value: value,
	})
}

func (p *Producer) Close() error {
	return p.writer.Close()
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\cmd\order-service\main.go
package main

import (
	"context"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"github.com/google/uuid"
	"bel-parcel/services/order-service/internal/app"
	"bel-parcel/services/order-service/internal/config"
	"bel-parcel/services/order-service/internal/delivery/handler"
	"bel-parcel/services/order-service/internal/infra/db"
	"bel-parcel/services/order-service/internal/infra/kafka"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}

	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()

	dbPool, err := db.NewPgxPool(cfg.DB.DSN)
	if err != nil {
		slog.Error("failed to connect to DB", "error", err)
		os.Exit(1)
	}
	defer dbPool.Close()

	kafkaProducer, err := kafka.NewProducer(cfg.Kafka.Brokers, cfg.Kafka.Timeout)
	if err != nil {
		slog.Error("failed to create Kafka producer", "error", err)
		os.Exit(1)
	}
	defer kafkaProducer.Close()

	service := app.NewOrderService(dbPool, kafkaProducer, cfg.Kafka.Topic)

	consumer := kafka.NewConsumer(cfg.Kafka.Brokers, cfg.Kafka.GroupID, cfg.Kafka.ConsumerTopics, cfg.Kafka.Timeout)
	cctx, ccancel := context.WithCancel(context.Background())
	defer ccancel()
	consumer.Start(cctx, func(topic string, key, value []byte) error {
		if err := service.HandleKafkaEvent(cctx, topic, key, value); err != nil {
			envelope := map[string]interface{}{
				"event_id":       uuid.NewString(),
				"event_type":     "dlq",
				"occurred_at":    time.Now().UTC(),
				"correlation_id": string(key),
				"data": map[string]interface{}{
					"original_topic": topic,
					"error":          err.Error(),
					"payload":        string(value),
				},
			}
			_ = kafkaProducer.Publish(cctx, cfg.Kafka.DLQTopic, string(key), envelope)
			return err
		}
		return nil
	})

	handler := handler.NewHandler(service)

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: handler,
	}

	go func() {
		slog.Info("starting HTTP server", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	// Graceful shutdown
	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh

	slog.Info("shutting down gracefully...")
	// Cancel consumer context to stop fetch loops and give them time to exit
	ccancel()
	time.Sleep(2 * time.Second)
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()

	srv.Shutdown(ctx)
	consumer.Close()
	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}

	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(), // РёР»Рё TLS РІ РїСЂРѕРґР°РєС€РµРЅРµ
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}

	res, _ := resource.Merge(
		resource.Default(),
		resource.NewWithAttributes(
			semconv.SchemaURL,
			semconv.ServiceName("order-service"),
		),
	)

	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)

	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\Dockerfile
# syntax=docker/dockerfile:1

# Build stage
FROM golang:1.24-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -o /order-service ./cmd/order-service/main.go

# Final stage
FROM alpine:3.20

WORKDIR /app

COPY --from=builder /order-service /app/order-service

# Expose port
EXPOSE 8080

# Create a non-root user
RUN adduser -D -g '' appuser
USER appuser

ENTRYPOINT ["/app/order-service"]

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\go.mod
module bel-parcel/services/order-service

go 1.24.0

require (
	github.com/google/uuid v1.6.0
	github.com/jackc/pgx/v5 v5.8.0
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.15.9 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\go.sum
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.15.9 h1:wKRjX6JRtDdrE9qwa4b/Cip7ACOshUI4smpCQanqjSY=
github.com/klauspost/compress v1.15.9/go.mod h1:PhcZ0MbTNciWF3rruxRgKxI5NkcHHrHUDtV4Yw2GlzU=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\internal\app\service.go
package app

import (
	"bel-parcel/services/order-service/internal/infra/kafka"
	"context"
	"fmt"
	"log/slog"
	"encoding/json"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
)

type Order struct {
	ID        string    `json:"id"`
	SellerID  string    `json:"seller_id"`
	PVZID     string    `json:"pvz_id"`
	Status    string    `json:"status"`
	CreatedAt time.Time `json:"created_at"`
}

type OrderService struct {
	db       *pgxpool.Pool
	producer *kafka.Producer
	topic    string
}

func NewOrderService(db *pgxpool.Pool, producer *kafka.Producer, topic string) *OrderService {
	return &OrderService{db: db, producer: producer, topic: topic}
}

type CreateOrderParams struct {
	SellerID string
	PVZID    string
}

func (s *OrderService) CreateOrder(ctx context.Context, params CreateOrderParams) (*Order, error) {
	id := uuid.New().String()
	now := time.Now().UTC()

	order := &Order{
		ID:        id,
		SellerID:  params.SellerID,
		PVZID:     params.PVZID,
		Status:    "CREATED",
		CreatedAt: now,
	}

	// 1. Save to DB
	query := `INSERT INTO orders (id, seller_id, pvz_id, status, created_at) VALUES ($1, $2, $3, $4, $5)`
	_, err := s.db.Exec(ctx, query, order.ID, order.SellerID, order.PVZID, order.Status, order.CreatedAt)
	if err != nil {
		slog.ErrorContext(ctx, "failed to insert order", "error", err)
		return nil, fmt.Errorf("db insert failed: %w", err)
	}

	// 1.5. Idempotency for publisher
	if ok, _ := s.markPublished(ctx, "orders.created", order.ID); !ok {
		return order, nil
	}

	// 2. Publish event (envelope)
	envelope := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "orders.created",
		"occurred_at":    now,
		"correlation_id": order.ID,
		"data": map[string]interface{}{
			"order_id":           order.ID,
			"seller_warehouse_id": order.SellerID,
			"pickup_point_id":     order.PVZID,
			"created_at":          order.CreatedAt,
		},
	}

	if err := s.producer.Publish(ctx, s.topic, order.ID, envelope); err != nil {
		slog.ErrorContext(ctx, "failed to publish event", "order_id", order.ID, "error", err)
		return order, fmt.Errorf("kafka publish failed: %w", err)
	}

	slog.InfoContext(ctx, "order created", "order_id", order.ID)
	return order, nil
}

func (s *OrderService) Ping(ctx context.Context) error {
	return s.db.Ping(ctx)
}

func (s *OrderService) HandleKafkaEvent(ctx context.Context, topic string, key, value []byte) error {
	switch topic {
	case "batches.formed":
		var envelope struct {
			EventID       string          `json:"event_id"`
			EventType     string          `json:"event_type"`
			OccurredAt    time.Time       `json:"occurred_at"`
			CorrelationID string          `json:"correlation_id"`
			Data          json.RawMessage `json:"data"`
		}
		if err := json.Unmarshal(value, &envelope); err != nil {
			return err
		}
		if ok, _ := s.markEventProcessed(ctx, envelope.EventID); !ok {
			return nil
		}
		var data struct {
			BatchID string   `json:"batch_id"`
			OrderIDs []string `json:"order_ids"`
			FormedAt time.Time `json:"formed_at"`
		}
		if err := json.Unmarshal(envelope.Data, &data); err != nil {
			return err
		}
		if err := s.storeBatchOrders(ctx, data.BatchID, data.OrderIDs); err != nil {
			return err
		}
		return s.applyOrdersStatusForBatch(ctx, data.BatchID, "BATCHED")
	case "events.batch_picked_up":
		var envelope struct {
			EventID       string          `json:"event_id"`
			EventType     string          `json:"event_type"`
			OccurredAt    time.Time       `json:"occurred_at"`
			CorrelationID string          `json:"correlation_id"`
			Data          json.RawMessage `json:"data"`
		}
		if err := json.Unmarshal(value, &envelope); err != nil {
			return err
		}
		if ok, _ := s.markEventProcessed(ctx, envelope.EventID); !ok {
			return nil
		}
		return nil
	case "events.batch_delivered_to_pvp":
		var envelope struct {
			EventID       string          `json:"event_id"`
			EventType     string          `json:"event_type"`
			OccurredAt    time.Time       `json:"occurred_at"`
			CorrelationID string          `json:"correlation_id"`
			Data          json.RawMessage `json:"data"`
		}
		if err := json.Unmarshal(value, &envelope); err != nil {
			return err
		}
		if ok, _ := s.markEventProcessed(ctx, envelope.EventID); !ok {
			return nil
		}
		var data struct {
			BatchID    string    `json:"batch_id"`
			PickedUpAt time.Time `json:"picked_up_at"`
		}
		if err := json.Unmarshal(envelope.Data, &data); err != nil {
			return err
		}
		return s.applyOrdersStatusForBatch(ctx, data.BatchID, "DELIVERED_TO_PVP")
	case "events.batch_received_by_pvp":
		var envelope struct {
			EventID       string          `json:"event_id"`
			EventType     string          `json:"event_type"`
			OccurredAt    time.Time       `json:"occurred_at"`
			CorrelationID string          `json:"correlation_id"`
			Data          json.RawMessage `json:"data"`
		}
		if err := json.Unmarshal(value, &envelope); err != nil {
			return err
		}
		if ok, _ := s.markEventProcessed(ctx, envelope.EventID); !ok {
			return nil
		}
		var data struct {
			BatchID     string    `json:"batch_id"`
			ReceivedAt  time.Time `json:"received_at"`
			PVPWorkerID string    `json:"pvp_worker_id"`
		}
		if err := json.Unmarshal(envelope.Data, &data); err != nil {
			return err
		}
		return s.applyOrdersStatusForBatch(ctx, data.BatchID, "RECEIVED_BY_PVP")
	default:
		return nil
	}
}

func (s *OrderService) applyOrderStatus(ctx context.Context, orderID, next string) error {
	var current string
	err := s.db.QueryRow(ctx, "SELECT status FROM orders WHERE id=$1", orderID).Scan(&current)
	if err != nil {
		return err
	}
	allowed := map[string]string{
		"CREATED":            "BATCHED",
		"BATCHED":            "DELIVERED_TO_PVP",
		"DELIVERED_TO_PVP":   "RECEIVED_BY_PVP",
	}
	target, ok := allowed[current]
	if !ok || target != next {
		return fmt.Errorf("invalid transition %s -> %s", current, next)
	}
	_, err = s.db.Exec(ctx, "UPDATE orders SET status=$2, updated_at=NOW() WHERE id=$1", orderID, next)
	return err
}

func (s *OrderService) applyOrdersStatusForBatch(ctx context.Context, batchID, next string) error {
	rows, err := s.db.Query(ctx, "SELECT order_id FROM order_batches WHERE batch_id=$1", batchID)
	if err != nil {
		return err
	}
	defer rows.Close()
	for rows.Next() {
		var oid string
		if err := rows.Scan(&oid); err != nil {
			return err
		}
		if err := s.applyOrderStatus(ctx, oid, next); err != nil {
			return err
		}
	}
	return rows.Err()
}

func (s *OrderService) storeBatchOrders(ctx context.Context, batchID string, orderIDs []string) error {
	for _, oid := range orderIDs {
		_, err := s.db.Exec(ctx, "INSERT INTO order_batches (batch_id, order_id) VALUES ($1, $2) ON CONFLICT DO NOTHING", batchID, oid)
		if err != nil {
			return err
		}
	}
	return nil
}
func (s *OrderService) markEventProcessed(ctx context.Context, eventID string) (bool, error) {
	var id string
	err := s.db.QueryRow(ctx, "INSERT INTO processed_events(event_id, occurred_at) VALUES ($1, NOW()) ON CONFLICT (event_id) DO NOTHING RETURNING event_id", eventID).Scan(&id)
	if err != nil {
		return false, nil
	}
	return id != "", nil
}

func (s *OrderService) markPublished(ctx context.Context, eventType, correlationID string) (bool, error) {
	var et string
	err := s.db.QueryRow(ctx, `
		INSERT INTO published_events(event_type, correlation_id, occurred_at)
		VALUES ($1, $2, NOW())
		ON CONFLICT (event_type, correlation_id) DO NOTHING
		RETURNING event_type
	`, eventType, correlationID).Scan(&et)
	if err != nil {
		return false, nil
	}
	return et != "", nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		DSN string
	}
	Kafka struct {
		Brokers []string
		Topic   string
		GroupID string
		ConsumerTopics []string
		Timeout time.Duration
		DLQTopic string
	}
	OTLP struct {
		Endpoint string
	}
}

func Load() (*Config, error) {
	v := viper.New()

	// Defaults
	v.SetDefault("server.port", "8080")
	v.SetDefault("db.dsn", "postgres://user:pass@localhost:5432/order_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.topic", "orders.created")
	v.SetDefault("kafka.groupid", "order-service")
	v.SetDefault("kafka.consumertopics", []string{
		"batches.formed",
		"events.batch_picked_up",
		"events.batch_delivered_to_pvp",
		"events.batch_received_by_pvp",
	})
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("kafka.dlqtopic", "dlq.order")
	v.SetDefault("otlp.endpoint", "")

	// Config file
	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	// Env vars
	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}

	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}

	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\internal\delivery\handler\handler.go
package handler

import (
	"bel-parcel/services/order-service/internal/app"
	"encoding/json"
	"log/slog"
	"net/http"
)

type Handler struct {
	service *app.OrderService
}

func NewHandler(service *app.OrderService) http.Handler {
	mux := http.NewServeMux()
	h := &Handler{service: service}
	mux.HandleFunc("POST /orders", h.CreateOrder)
	mux.HandleFunc("GET /healthz", h.HealthCheck)
	mux.HandleFunc("GET /readyz", h.ReadinessCheck)
	return mux
}

type CreateOrderRequest struct {
	SellerID string `json:"seller_id"`
	PVZID    string `json:"pvz_id"`
}

func (h *Handler) HealthCheck(w http.ResponseWriter, r *http.Request) {
	w.WriteHeader(http.StatusOK)
	w.Write([]byte("OK"))
}

func (h *Handler) ReadinessCheck(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	if err := h.service.Ping(ctx); err != nil {
		slog.ErrorContext(ctx, "readiness check failed", "error", err)
		http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
		return
	}
	w.WriteHeader(http.StatusOK)
	w.Write([]byte("OK"))
}

func (h *Handler) CreateOrder(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()

	var req CreateOrderRequest
	if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
		http.Error(w, "invalid request body", http.StatusBadRequest)
		return
	}

	if req.SellerID == "" || req.PVZID == "" {
		http.Error(w, "seller_id and pvz_id are required", http.StatusBadRequest)
		return
	}

	order, err := h.service.CreateOrder(ctx, app.CreateOrderParams{
		SellerID: req.SellerID,
		PVZID:    req.PVZID,
	})

	if err != nil {
		slog.ErrorContext(ctx, "failed to create order", "error", err)
		http.Error(w, "internal server error", http.StatusInternalServerError)
		return
	}

	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusCreated)
	json.NewEncoder(w).Encode(order)
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

// NewPgxPool СЃРѕР·РґР°С‘С‚ РїСѓР» РїРѕРґРєР»СЋС‡РµРЅРёР№ Рє PostgreSQL С‡РµСЂРµР· pgxpool.
func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	config, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}

	config.MaxConns = 20
	config.MinConns = 5
	config.MaxConnLifetime = 30 * time.Minute
	config.HealthCheckPeriod = 1 * time.Minute

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	pool, err := pgxpool.NewWithConfig(ctx, config)
	if err != nil {
		return nil, err
	}

	if err := pool.Ping(ctx); err != nil {
		pool.Close()
		return nil, err
	}

	return pool, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\internal\infra\kafka\consumer.go
package kafka

import (
	"context"
	"time"

	"github.com/segmentio/kafka-go"
)

type Consumer struct {
	readers []*kafka.Reader
}

func NewConsumer(brokers []string, groupID string, topics []string, timeout time.Duration) *Consumer {
	var readers []*kafka.Reader
	for _, t := range topics {
		r := kafka.NewReader(kafka.ReaderConfig{
			Brokers:        brokers,
			GroupID:        groupID,
			Topic:          t,
			MaxWait:        timeout,
			CommitInterval: time.Second,
		})
		readers = append(readers, r)
	}
	return &Consumer{readers: readers}
}

func (c *Consumer) Start(ctx context.Context, handler func(topic string, key, value []byte) error) {
	for _, r := range c.readers {
		go func(reader *kafka.Reader) {
			for {
				m, err := reader.FetchMessage(ctx)
				if err != nil {
					return
				}
				if handler != nil {
					if e := handler(reader.Config().Topic, m.Key, m.Value); e == nil {
						_ = reader.CommitMessages(ctx, m)
					}
				}
			}
		}(r)
	}
}

func (c *Consumer) Close() error {
	var err error
	for _, r := range c.readers {
		if e := r.Close(); e != nil {
			err = e
		}
	}
	return err
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\order-service\internal\infra\kafka\kafka.go
package kafka

import (
	"context"
	"encoding/json"
	"time"

	"github.com/segmentio/kafka-go"
)

type Producer struct {
	writer *kafka.Writer
}

func NewProducer(brokers []string, timeout time.Duration) (*Producer, error) {
	w := &kafka.Writer{
		Addr:         kafka.TCP(brokers...),
		WriteTimeout: timeout,
		Balancer:     &kafka.LeastBytes{},
		// Idempotency requires setting ID, but simple Async production is robust enough for now
		// For true idempotency producer-side, we rely on Kafka acks.
		RequiredAcks: kafka.RequireAll,
		Async:        true,
	}

	return &Producer{writer: w}, nil
}

func (p *Producer) Publish(ctx context.Context, topic string, key string, msg interface{}) error {
	value, err := json.Marshal(msg)
	if err != nil {
		return err
	}

	return p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topic,
		Key:   []byte(key),
		Value: value,
	})
}

func (p *Producer) Close() error {
	return p.writer.Close()
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\pickup-point-service\cmd\pickup-point-service\main.go
package main

import (
	"context"
	"encoding/json"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/pickup-point-service/internal/app"
	"bel-parcel/services/pickup-point-service/internal/config"
	"bel-parcel/services/pickup-point-service/internal/infra/db"
	"bel-parcel/services/pickup-point-service/internal/infra/kafka"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}

	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()

	dbPool, err := db.NewPgxPool(cfg.DB.DSN)
	if err != nil {
		slog.Error("failed to connect to DB", "error", err)
		os.Exit(1)
	}
	defer dbPool.Close()

	producer, err := kafka.NewProducer(cfg.Kafka.Brokers, cfg.Kafka.Timeout)
	if err != nil {
		slog.Error("failed to create Kafka producer", "error", err)
		os.Exit(1)
	}
	defer producer.Close()

	svc := app.NewPVPService(dbPool, producer, cfg.Kafka.Topic)

	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := dbPool.Ping(r.Context()); err != nil {
			slog.Error("readiness check failed", "error", err)
			http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})

	mux.HandleFunc("POST /batches/{batch_id}/receive", func(w http.ResponseWriter, r *http.Request) {
		var body struct {
			PVPWorkerID string    `json:"pvp_worker_id"`
			BatchID     string    `json:"batch_id"`
			ReceivedAt  time.Time `json:"received_at"`
		}
		if err := json.NewDecoder(r.Body).Decode(&body); err != nil {
			http.Error(w, "bad request", http.StatusBadRequest)
			return
		}
		if err := svc.PublishReceived(r.Context(), body.BatchID, body.PVPWorkerID, body.ReceivedAt); err != nil {
			slog.Error("publish received_by_pvp failed", "error", err, "batch_id", body.BatchID)
			http.Error(w, "internal", http.StatusInternalServerError)
			return
		}
		w.WriteHeader(http.StatusAccepted)
	})

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
	}

	go func() {
		slog.Info("starting pickup-point-service", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh

	slog.Info("shutting down gracefully...")
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	_ = srv.Shutdown(ctx)
	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}
	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}
	res, _ := resource.Merge(resource.Default(), resource.NewWithAttributes(
		semconv.SchemaURL,
		semconv.ServiceName("pickup-point-service"),
	))
	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)
	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\pickup-point-service\go.mod
module bel-parcel/services/pickup-point-service

go 1.24.0

require (
	github.com/google/uuid v1.6.0
	github.com/jackc/pgx/v5 v5.8.0
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.15.9 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\pickup-point-service\go.sum
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.15.9 h1:wKRjX6JRtDdrE9qwa4b/Cip7ACOshUI4smpCQanqjSY=
github.com/klauspost/compress v1.15.9/go.mod h1:PhcZ0MbTNciWF3rruxRgKxI5NkcHHrHUDtV4Yw2GlzU=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\pickup-point-service\internal\app\service.go
package app

import (
	"context"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"bel-parcel/services/pickup-point-service/internal/infra/kafka"
)

type PVPService struct {
	db       *pgxpool.Pool
	producer *kafka.Producer
	topic    string
}

func NewPVPService(db *pgxpool.Pool, producer *kafka.Producer, topic string) *PVPService {
	return &PVPService{db: db, producer: producer, topic: topic}
}

func (s *PVPService) PublishReceived(ctx context.Context, batchID, workerID string, receivedAt time.Time) error {
	if ok, _ := s.markPublished(ctx, "events.batch_received_by_pvp", batchID); !ok {
		return nil
	}
	now := time.Now().UTC()
	envelope := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "events.batch_received_by_pvp",
		"occurred_at":    now,
		"correlation_id": batchID,
		"data": map[string]interface{}{
			"batch_id":     batchID,
			"pvp_worker_id": workerID,
			"received_at":  receivedAt,
		},
	}
	return s.producer.Publish(ctx, s.topic, batchID, envelope)
}

func (s *PVPService) markPublished(ctx context.Context, eventType, correlationID string) (bool, error) {
	var et string
	err := s.db.QueryRow(ctx, `
		INSERT INTO published_events(event_type, correlation_id, occurred_at) 
		VALUES ($1, $2, NOW()) 
		ON CONFLICT (event_type, correlation_id) DO NOTHING 
		RETURNING event_type
	`, eventType, correlationID).Scan(&et)
	if err != nil {
		return false, nil
	}
	return et != "", nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\pickup-point-service\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		DSN string
	}
	Kafka struct {
		Brokers  []string
		Timeout  time.Duration
		Topic    string
	}
	OTLP struct {
		Endpoint string
	}
}

func Load() (*Config, error) {
	v := viper.New()

	v.SetDefault("server.port", "8085")
	v.SetDefault("db.dsn", "postgres://user:pass@localhost:5432/pvp_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("kafka.topic", "events.batch_received_by_pvp")
	v.SetDefault("otlp.endpoint", "")

	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}

	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}
	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\pickup-point-service\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	cfg, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}
	cfg.MaxConns = 10
	cfg.MinConns = 1
	cfg.MaxConnLifetime = time.Hour
	cfg.MaxConnIdleTime = 10 * time.Minute
	return pgxpool.NewWithConfig(context.Background(), cfg)
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\pickup-point-service\internal\infra\kafka\kafka.go
package kafka

import (
	"context"
	"encoding/json"
	"time"

	"github.com/segmentio/kafka-go"
)

type Producer struct {
	writer *kafka.Writer
}

func NewProducer(brokers []string, timeout time.Duration) (*Producer, error) {
	w := &kafka.Writer{
		Addr:         kafka.TCP(brokers...),
		WriteTimeout: timeout,
		Balancer:     &kafka.LeastBytes{},
		RequiredAcks: kafka.RequireAll,
		Async:        true,
	}
	return &Producer{writer: w}, nil
}

func (p *Producer) Publish(ctx context.Context, topic, key string, msg interface{}) error {
	value, err := json.Marshal(msg)
	if err != nil {
		return err
	}
	return p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topic,
		Key:   []byte(key),
		Value: value,
	})
}

func (p *Producer) Close() error {
	return p.writer.Close()
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\cmd\reassignment-service\main.go
package main

import (
	"context"
	"encoding/json"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	skafka "github.com/segmentio/kafka-go"
	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/reassignment-service/internal/config"
	"bel-parcel/services/reassignment-service/internal/infra/db"
	ikafka "bel-parcel/services/reassignment-service/internal/infra/kafka"
	"bel-parcel/services/reassignment-service/internal/worker"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}

	setupLogger()
	shutdownTracer := setupOTLP(cfg)
	defer shutdownTracer()

	tripDB, err := db.NewPgxPool(cfg.DB.TripDSN)
	if err != nil {
		slog.Error("failed to connect to Trip DB", "error", err)
		os.Exit(1)
	}
	defer tripDB.Close()
	refDB, err := db.NewPgxPool(cfg.DB.RefDSN)
	if err != nil {
		slog.Error("failed to connect to Reference DB", "error", err)
		os.Exit(1)
	}
	defer refDB.Close()

	producer := ikafka.NewProducer(cfg.Kafka.Brokers, cfg.Kafka.Timeout)
	defer producer.Close()

	w := worker.NewWorker(tripDB, refDB, producer, cfg.Worker.Interval, cfg.Worker.TripTimeout)

	// Context for the worker and consumers
	ctx, cancel := context.WithCancel(context.Background())
	defer cancel()

	// Start worker in a goroutine
	go w.Start(ctx)

	// Kafka consumer for manual commands
	go func() {
		reader := skafka.NewReader(skafka.ReaderConfig{
			Brokers: cfg.Kafka.Brokers,
			GroupID: "reassignment-service",
			Topic:   cfg.Kafka.CommandTopic,
			MaxWait: cfg.Kafka.Timeout,
		})
		defer reader.Close()
		for {
			m, err := reader.FetchMessage(ctx)
			if err != nil {
				return
			}
			var envelope struct {
				EventID       string         `json:"event_id"`
				EventType     string         `json:"event_type"`
				OccurredAt    time.Time      `json:"occurred_at"`
				CorrelationID string         `json:"correlation_id"`
				Data          map[string]any `json:"data"`
			}
			if err := json.Unmarshal(m.Value, &envelope); err != nil {
				continue
			}
			newCarrier, _ := envelope.Data["new_carrier_id"].(string)
			reason, _ := envelope.Data["reason"].(string)
			operatorID, _ := envelope.Data["operator_id"].(string)
			if newCarrier != "" {
				_ = w.HandleManualReassign(ctx, envelope.CorrelationID, newCarrier, reason, operatorID)
			}
			_ = reader.CommitMessages(ctx, m)
		}
	}()

	// Health check server
	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := tripDB.Ping(r.Context()); err != nil {
			slog.Error("readiness check failed", "error", err)
			http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
	}

	go func() {
		slog.Info("starting health check server", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	// Graceful shutdown
	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh

	slog.Info("shutting down gracefully...")

	// Stop worker
	cancel()
	w.Stop()

	// Stop server
	shutdownCtx, shutdownCancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer shutdownCancel()

	if err := srv.Shutdown(shutdownCtx); err != nil {
		slog.Error("server shutdown failed", "error", err)
	}

	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}

	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}

	res, _ := resource.Merge(
		resource.Default(),
		resource.NewWithAttributes(
			semconv.SchemaURL,
			semconv.ServiceName("reassignment-service"),
		),
	)

	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)

	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\Dockerfile
# syntax=docker/dockerfile:1

# Build stage
FROM golang:1.24-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -o /reassignment-service ./cmd/reassignment-service/main.go

# Final stage
FROM alpine:3.20

WORKDIR /app

COPY --from=builder /reassignment-service /app/reassignment-service

# Expose port
EXPOSE 8082

# Create a non-root user
RUN adduser -D -g '' appuser
USER appuser

ENTRYPOINT ["/app/reassignment-service"]

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\go.mod
module bel-parcel/services/reassignment-service

go 1.24.0

require (
	github.com/google/uuid v1.6.0
	github.com/jackc/pgx/v5 v5.8.0
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.15.9 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\go.sum
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.15.9 h1:wKRjX6JRtDdrE9qwa4b/Cip7ACOshUI4smpCQanqjSY=
github.com/klauspost/compress v1.15.9/go.mod h1:PhcZ0MbTNciWF3rruxRgKxI5NkcHHrHUDtV4Yw2GlzU=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		TripDSN string
		RefDSN  string
	}
	Worker struct {
		Interval      time.Duration
		TripTimeout   time.Duration
	}
	Kafka struct {
		Brokers []string
		Timeout time.Duration
		CommandTopic string
	}
	OTLP struct {
		Endpoint string
	}
}

func Load() (*Config, error) {
	v := viper.New()

	// Defaults
	v.SetDefault("server.port", "8082")
	v.SetDefault("db.tripdsn", "postgres://user:pass@localhost:5432/trip_db?sslmode=disable")
	v.SetDefault("db.refdsn", "postgres://user:pass@localhost:5432/reference_db?sslmode=disable")
	v.SetDefault("worker.interval", 1*time.Minute)
	v.SetDefault("worker.trip_timeout", 2*time.Hour)
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("kafka.commandtopic", "commands.trip.reassign")
	v.SetDefault("otlp.endpoint", "")

	// Config file
	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	// Env vars
	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}

	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}

	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

// NewPgxPool СЃРѕР·РґР°С‘С‚ РїСѓР» РїРѕРґРєР»СЋС‡РµРЅРёР№ Рє PostgreSQL С‡РµСЂРµР· pgxpool.
func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	config, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}

	config.MaxConns = 10
	config.MinConns = 2
	config.MaxConnLifetime = 30 * time.Minute
	config.HealthCheckPeriod = 1 * time.Minute

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()

	pool, err := pgxpool.NewWithConfig(ctx, config)
	if err != nil {
		return nil, err
	}

	if err := pool.Ping(ctx); err != nil {
		pool.Close()
		return nil, err
	}

	return pool, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\internal\infra\kafka\producer.go
package kafka

import (
	"context"
	"encoding/json"
	"time"

	"github.com/segmentio/kafka-go"
)

type Producer struct {
	writer *kafka.Writer
}

func NewProducer(brokers []string, timeout time.Duration) *Producer {
	return &Producer{
		writer: &kafka.Writer{
			Addr:         kafka.TCP(brokers...),
			WriteTimeout: timeout,
			Balancer:     &kafka.LeastBytes{},
			RequiredAcks: kafka.RequireAll,
			Async:        false,
		},
	}
}

func (p *Producer) Publish(ctx context.Context, topic string, key string, msg interface{}) error {
	value, err := json.Marshal(msg)
	if err != nil {
		return err
	}
	return p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topic,
		Key:   []byte(key),
		Value: value,
	})
}

func (p *Producer) Close() error {
	return p.writer.Close()
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\reassignment-service\internal\worker\worker.go
package worker

import (
	"context"
	"log/slog"
	"math/rand"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"bel-parcel/services/reassignment-service/internal/infra/kafka"
)

type Worker struct {
	tripDB      *pgxpool.Pool
	refDB       *pgxpool.Pool
	producer    *kafka.Producer
	interval    time.Duration
	tripTimeout time.Duration
	stopCh      chan struct{}
}

func NewWorker(tripDB, refDB *pgxpool.Pool, producer *kafka.Producer, interval, tripTimeout time.Duration) *Worker {
	return &Worker{
		tripDB:      tripDB,
		refDB:       refDB,
		producer:    producer,
		interval:    interval,
		tripTimeout: tripTimeout,
		stopCh:      make(chan struct{}),
	}
}

func (w *Worker) Start(ctx context.Context) {
	ticker := time.NewTicker(w.interval)
	defer ticker.Stop()

	slog.InfoContext(ctx, "reassignment worker started", "interval", w.interval)

	for {
		select {
		case <-ctx.Done():
			slog.InfoContext(ctx, "worker context cancelled")
			return
		case <-w.stopCh:
			slog.InfoContext(ctx, "worker stopped")
			return
		case <-ticker.C:
			w.checkTimeouts(ctx)
		}
	}
}

func (w *Worker) Stop() {
	close(w.stopCh)
}

func (w *Worker) checkTimeouts(ctx context.Context) {
	// Assume 'trips' table exists with: id, status, assigned_at
	// Statuses: 'ASSIGNED', 'PICKED_UP', 'DELIVERED', 'PENDING_ASSIGNMENT'
	// Logic: Find trips ASSIGNED more than timeout ago and revert to PENDING_ASSIGNMENT

	cutoffTime := time.Now().UTC().Add(-w.tripTimeout)

	// Find timed out trips
	queryFind := `
		SELECT t.id, tb.batch_id, t.carrier_id
		FROM trips t
		JOIN trip_batches tb ON tb.trip_id = t.id
		WHERE t.status = 'ASSIGNED' AND t.assigned_at < $1
	`
	rows, err := w.tripDB.Query(ctx, queryFind, cutoffTime)
	if err != nil {
		slog.ErrorContext(ctx, "failed to query timed out trips", "error", err)
		return
	}
	defer rows.Close()

	count := 0
	for rows.Next() {
		var tripID, batchID, oldCarrierID string
		if err := rows.Scan(&tripID, &batchID, &oldCarrierID); err != nil {
			continue
		}
		_ = w.processReassignment(ctx, tripID, batchID, oldCarrierID)
		count++
	}

	if count > 0 {
		slog.InfoContext(ctx, "processed timed out trips", "count", count)
	}
}

func (w *Worker) processReassignment(ctx context.Context, tripID, batchID, oldCarrierID string) error {
	// Mark old trip as FAILED
	_, _ = w.tripDB.Exec(ctx, "UPDATE trips SET status='FAILED', updated_at=NOW() WHERE id=$1", tripID)

	// Choose new carrier
	var candidates []string
	crows, err := w.refDB.Query(ctx, `
		SELECT id FROM carriers 
		WHERE is_active = true AND last_seen > NOW() - INTERVAL '1 hour' AND id <> $1
	`, oldCarrierID)
	if err != nil {
		return err
	}
	for crows.Next() {
		var cid string
		_ = crows.Scan(&cid)
		candidates = append(candidates, cid)
	}
	crows.Close()
	if len(candidates) == 0 {
		_, _ = w.tripDB.Exec(ctx, "UPDATE trips SET status='REASSIGNMENT_FAILED', updated_at=NOW() WHERE id=$1", tripID)
		return nil
	}
	newCarrier := candidates[rand.Intn(len(candidates))]

	// Create new trip
	var newTripID string
	err = w.tripDB.QueryRow(ctx, `
		INSERT INTO trips (id, carrier_id, status, assigned_at) 
		VALUES (gen_random_uuid(), $1, 'ASSIGNED', NOW()) RETURNING id
	`, newCarrier).Scan(&newTripID)
	if err != nil {
		return err
	}
	_, err = w.tripDB.Exec(ctx, "INSERT INTO trip_batches (trip_id, batch_id) VALUES ($1, $2)", newTripID, batchID)
	if err != nil {
		return err
	}

	// Publish event trip.reassigned
	now := time.Now().UTC()
	evt := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "trip.reassigned",
		"occurred_at":    now,
		"correlation_id": batchID,
		"data": map[string]interface{}{
			"trip_id":     newTripID,
			"old_trip_id": tripID,
			"batch_id":    batchID,
			"carrier_id":  newCarrier,
			"assigned_at": now,
		},
	}
	_ = w.producer.Publish(ctx, "trip.reassigned", batchID, evt)
	return nil
}

func (w *Worker) HandleManualReassign(ctx context.Context, tripID, newCarrierID, reason, operatorID string) error {
	var batchID, oldCarrierID string
	err := w.tripDB.QueryRow(ctx, `
		SELECT tb.batch_id, t.carrier_id
		FROM trips t
		JOIN trip_batches tb ON tb.trip_id = t.id
		WHERE t.id = $1
	`, tripID).Scan(&batchID, &oldCarrierID)
	if err != nil {
		return err
	}
	_, _ = w.tripDB.Exec(ctx, "UPDATE trips SET status='FAILED', updated_at=NOW() WHERE id=$1", tripID)
	var newTripID string
	err = w.tripDB.QueryRow(ctx, `
		INSERT INTO trips (id, carrier_id, status, assigned_at) 
		VALUES (gen_random_uuid(), $1, 'ASSIGNED', NOW()) RETURNING id
	`, newCarrierID).Scan(&newTripID)
	if err != nil {
		return err
	}
	_, err = w.tripDB.Exec(ctx, "INSERT INTO trip_batches (trip_id, batch_id) VALUES ($1, $2)", newTripID, batchID)
	if err != nil {
		return err
	}
	now := time.Now().UTC()
	evt := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "trip.reassigned",
		"occurred_at":    now,
		"correlation_id": batchID,
		"data": map[string]interface{}{
			"trip_id":       newTripID,
			"old_trip_id":   tripID,
			"batch_id":      batchID,
			"carrier_id":    newCarrierID,
			"assigned_at":   now,
			"reason":        reason,
			"operator_id":   operatorID,
			"manual_action": true,
		},
	}
	return w.producer.Publish(ctx, "trip.reassigned", batchID, evt)
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\cmd\routing-service\main.go
package main

import (
	"context"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/routing-service/internal/config"
	"bel-parcel/services/routing-service/internal/infra/db"
	"bel-parcel/services/routing-service/internal/infra/kafka"
	"bel-parcel/services/routing-service/internal/routing"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}

	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()

	tripDB, err := db.NewPgxPool(cfg.DB.TripDSN)
	if err != nil {
		slog.Error("failed to connect to Trip DB", "error", err)
		os.Exit(1)
	}
	defer tripDB.Close()
	refDB, err := db.NewPgxPool(cfg.DB.RefDSN)
	if err != nil {
		slog.Error("failed to connect to Reference DB", "error", err)
		os.Exit(1)
	}
	defer refDB.Close()

	producer := kafka.NewProducer(cfg.Kafka.Brokers, cfg.Kafka.Timeout)
	defer producer.Close()
	consumer := kafka.NewConsumer(cfg.Kafka.Brokers, cfg.Kafka.GroupID, cfg.Kafka.ConsumeTopics, cfg.Kafka.Timeout)
	defer consumer.Close()

	svc := routing.NewService(tripDB, refDB, producer, cfg.Kafka.ProduceTopic)

	cctx, ccancel := context.WithCancel(context.Background())
	defer ccancel()
	consumer.Start(cctx, func(topic string, key, value []byte) error {
		return svc.HandleEvent(cctx, topic, key, value)
	})

	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := tripDB.Ping(r.Context()); err != nil {
			slog.Error("readiness check failed", "error", err)
			http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
	}

	go func() {
		slog.Info("starting routing-service", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh

	slog.Info("shutting down gracefully...")
	ccancel()

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	_ = srv.Shutdown(ctx)
	slog.Info("server stopped")
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}
	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}
	res, _ := resource.Merge(resource.Default(), resource.NewWithAttributes(
		semconv.SchemaURL,
		semconv.ServiceName("routing-service"),
	))
	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)
	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\Dockerfile
# syntax=docker/dockerfile:1

FROM golang:1.24-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o /routing-service ./cmd/routing-service/main.go

FROM alpine:3.20
WORKDIR /app
COPY --from=builder /routing-service /app/routing-service
EXPOSE 8081
RUN adduser -D -g '' appuser
USER appuser
ENTRYPOINT ["/app/routing-service"]


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\go.mod
module bel-parcel/services/routing-service

go 1.24.0

require (
	github.com/google/uuid v1.6.0
	github.com/jackc/pgx/v5 v5.8.0
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.15.9 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\go.sum
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.15.9 h1:wKRjX6JRtDdrE9qwa4b/Cip7ACOshUI4smpCQanqjSY=
github.com/klauspost/compress v1.15.9/go.mod h1:PhcZ0MbTNciWF3rruxRgKxI5NkcHHrHUDtV4Yw2GlzU=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		TripDSN string
		RefDSN  string
	}
	Kafka struct {
		Brokers        []string
		Timeout        time.Duration
		GroupID        string
		ConsumeTopics  []string
		ProduceTopic   string
	}
	OTLP struct {
		Endpoint string
	}
}

func Load() (*Config, error) {
	v := viper.New()

	v.SetDefault("server.port", "8081")
	v.SetDefault("db.tripdsn", "postgres://user:pass@localhost:5432/trip_db?sslmode=disable")
	v.SetDefault("db.refdsn", "postgres://user:pass@localhost:5432/reference_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("kafka.groupid", "routing-service")
	v.SetDefault("kafka.consumetopics", []string{"batches.formed"})
	v.SetDefault("kafka.producetopic", "trips.assigned")
	v.SetDefault("otlp.endpoint", "")

	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}

	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}
	return &cfg, nil
}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	cfg, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}
	cfg.MaxConns = 20
	cfg.MinConns = 5
	cfg.MaxConnLifetime = 30 * time.Minute
	cfg.HealthCheckPeriod = time.Minute

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	pool, err := pgxpool.NewWithConfig(ctx, cfg)
	if err != nil {
		return nil, err
	}
	if err := pool.Ping(ctx); err != nil {
		pool.Close()
		return nil, err
	}
	return pool, nil
}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\internal\infra\kafka\consumer.go
package kafka

import (
	"context"
	"time"

	"github.com/segmentio/kafka-go"
)

type Consumer struct{ readers []*kafka.Reader }

func NewConsumer(brokers []string, groupID string, topics []string, timeout time.Duration) *Consumer {
	var readers []*kafka.Reader
	for _, t := range topics {
		readers = append(readers, kafka.NewReader(kafka.ReaderConfig{
			Brokers:        brokers,
			GroupID:        groupID,
			Topic:          t,
			MaxWait:        timeout,
			CommitInterval: time.Second,
		}))
	}
	return &Consumer{readers: readers}
}

func (c *Consumer) Start(ctx context.Context, handler func(topic string, key, value []byte) error) {
	for _, r := range c.readers {
		go func(reader *kafka.Reader) {
			for {
				m, err := reader.FetchMessage(ctx)
				if err != nil {
					return
				}
				if handler != nil {
					_ = handler(reader.Config().Topic, m.Key, m.Value)
				}
				_ = reader.CommitMessages(ctx, m)
			}
		}(r)
	}
}

func (c *Consumer) Close() error {
	var err error
	for _, r := range c.readers {
		if e := r.Close(); e != nil {
			err = e
		}
	}
	return err
}


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\internal\infra\kafka\producer.go
package kafka

import (
	"context"
	"encoding/json"
	"time"

	"github.com/segmentio/kafka-go"
)

type Producer struct{ writer *kafka.Writer }

func NewProducer(brokers []string, timeout time.Duration) *Producer {
	return &Producer{
		writer: &kafka.Writer{
			Addr:         kafka.TCP(brokers...),
			WriteTimeout: timeout,
			Balancer:     &kafka.LeastBytes{},
			RequiredAcks: kafka.RequireAll,
			Async:        true,
		},
	}
}

func (p *Producer) Publish(ctx context.Context, topic string, key string, msg interface{}) error {
	value, err := json.Marshal(msg)
	if err != nil {
		return err
	}
	return p.writer.WriteMessages(ctx, kafka.Message{
		Topic: topic,
		Key:   []byte(key),
		Value: value,
	})
}

func (p *Producer) Close() error { return p.writer.Close() }


<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\routing-service\internal\routing\service.go
package routing

import (
	"context"
	"encoding/json"
	"log/slog"
	"math/rand"
	"time"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgxpool"
	"bel-parcel/services/routing-service/internal/infra/kafka"
)

type Service struct {
	tripDB    *pgxpool.Pool
	refDB     *pgxpool.Pool
	producer  *kafka.Producer
	outTopic  string
}

func NewService(tripDB, refDB *pgxpool.Pool, producer *kafka.Producer, outTopic string) *Service {
	return &Service{tripDB: tripDB, refDB: refDB, producer: producer, outTopic: outTopic}
}

func (s *Service) HandleEvent(ctx context.Context, topic string, key, value []byte) error {
	if topic != "batches.formed" {
		return nil
	}
	var envelope struct {
		EventID       string          `json:"event_id"`
		EventType     string          `json:"event_type"`
		OccurredAt    time.Time       `json:"occurred_at"`
		CorrelationID string          `json:"correlation_id"`
		Data          json.RawMessage `json:"data"`
	}
	if err := json.Unmarshal(value, &envelope); err != nil {
		return err
	}
	if ok, _ := s.markEventProcessed(ctx, envelope.EventID); !ok {
		return nil
	}
	var data struct {
		BatchID          string    `json:"batch_id"`
		SellerWarehouseID string    `json:"seller_warehouse_id"`
		PickupPointID     string    `json:"pickup_point_id"`
		OrderIDs         []string  `json:"order_ids"`
		FormedAt         time.Time `json:"formed_at"`
	}
	if err := json.Unmarshal(envelope.Data, &data); err != nil {
		return err
	}
	carrierID, err := s.selectCarrier(ctx, data.SellerWarehouseID, data.PickupPointID)
	if err != nil {
		return err
	}
	tripID, err := s.createTrip(ctx, carrierID, data.BatchID)
	if err != nil {
		return err
	}
	now := time.Now().UTC()
	evt := map[string]interface{}{
		"event_id":       uuid.NewString(),
		"event_type":     "trips.assigned",
		"occurred_at":    now,
		"correlation_id": data.BatchID,
		"data": map[string]interface{}{
			"trip_id":     tripID,
			"carrier_id":  carrierID,
			"batch_id":    data.BatchID,
			"assigned_at": now,
		},
	}
	return s.producer.Publish(ctx, s.outTopic, data.BatchID, evt)
}

func (s *Service) selectCarrier(ctx context.Context, warehouseID, pvpID string) (string, error) {
	rows, err := s.refDB.Query(ctx, `
		SELECT id FROM carriers 
		WHERE is_active = true AND last_seen > NOW() - INTERVAL '1 hour'
	`)
	if err != nil {
		return "", err
	}
	defer rows.Close()
	cands := make([]string, 0, 16)
	for rows.Next() {
		var id string
		if err := rows.Scan(&id); err == nil {
			cands = append(cands, id)
		}
	}
	if len(cands) == 0 {
		slog.ErrorContext(ctx, "no active carriers found")
		return "", nil
	}
	return cands[rand.Intn(len(cands))], nil
}

func (s *Service) createTrip(ctx context.Context, carrierID, batchID string) (string, error) {
	var tripID string
	if err := s.tripDB.QueryRow(ctx, `
		INSERT INTO trips (id, carrier_id, status, assigned_at) 
		VALUES (gen_random_uuid(), $1, 'ASSIGNED', NOW()) RETURNING id
	`, carrierID).Scan(&tripID); err != nil {
		return "", err
	}
	if _, err := s.tripDB.Exec(ctx, `
		INSERT INTO trip_batches (trip_id, batch_id) VALUES ($1, $2)
	`, tripID, batchID); err != nil {
		return "", err
	}
	return tripID, nil
}

func (s *Service) markEventProcessed(ctx context.Context, eventID string) (bool, error) {
	var id string
	err := s.tripDB.QueryRow(ctx, "INSERT INTO processed_events(event_id, occurred_at) VALUES ($1, NOW()) ON CONFLICT (event_id) DO NOTHING RETURNING event_id", eventID).Scan(&id)
	if err != nil {
		return false, nil
	}
	return id != "", nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\tracking-service\cmd\tracking-service\main.go
package main

import (
	"context"
	"encoding/json"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.26.0"

	"bel-parcel/services/tracking-service/internal/config"
	"bel-parcel/services/tracking-service/internal/infra/db"
	"bel-parcel/services/tracking-service/internal/infra/kafka"
	"bel-parcel/services/tracking-service/internal/metrics"
	"github.com/jackc/pgx/v5/pgxpool"
	"github.com/prometheus/client_golang/prometheus/promhttp"
	"github.com/gorilla/websocket"
)

func main() {
	cfg, err := config.Load()
	if err != nil {
		slog.Error("failed to load config", "error", err)
		os.Exit(1)
	}
	setupLogger()
	shutdown := setupOTLP(cfg)
	defer shutdown()

	tripDB, err := db.NewPgxPool(cfg.DB.DSN)
	if err != nil {
		slog.Error("failed to connect to DB", "error", err)
		os.Exit(1)
	}
	defer tripDB.Close()
	metrics.Register()

	consumer := kafka.NewConsumer(cfg.Kafka.Brokers, cfg.Kafka.GroupID, []string{cfg.Kafka.Topic}, cfg.Kafka.Timeout)
	cctx, ccancel := context.WithCancel(context.Background())
	defer ccancel()
	broadcast := make(chan []byte, 100)
	clients := make(map[*websocket.Conn]struct{})
	var upgrader websocket.Upgrader
	consumer.Start(cctx, func(topic string, key, value []byte) error {
		var payload struct {
			TripID    string    `json:"trip_id"`
			Lat       float64   `json:"lat"`
			Lng       float64   `json:"lng"`
			Timestamp time.Time `json:"timestamp"`
		}
		if err := json.Unmarshal(value, &payload); err != nil {
			return nil
		}
		if err := upsertLocation(cctx, tripDB, payload.TripID, payload.Lat, payload.Lng, payload.Timestamp); err != nil {
			return err
		}
		msg, _ := json.Marshal(payload)
		select {
		case broadcast <- msg:
		default:
		}
		return nil
	})

	mux := http.NewServeMux()
	mux.HandleFunc("GET /healthz", func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.HandleFunc("GET /readyz", func(w http.ResponseWriter, r *http.Request) {
		if err := tripDB.Ping(r.Context()); err != nil {
			http.Error(w, "Service Unavailable", http.StatusServiceUnavailable)
			return
		}
		w.WriteHeader(http.StatusOK)
		w.Write([]byte("OK"))
	})
	mux.Handle("GET /metrics", promhttp.Handler())
	mux.HandleFunc("GET /ws/locations", func(w http.ResponseWriter, r *http.Request) {
		conn, err := upgrader.Upgrade(w, r, nil)
		if err != nil {
			return
		}
		clients[conn] = struct{}{}
		go func(c *websocket.Conn) {
			defer func() {
				c.Close()
				delete(clients, c)
			}()
			for {
				select {
				case <-cctx.Done():
					return
				case msg := <-broadcast:
					_ = c.WriteMessage(websocket.TextMessage, msg)
				}
			}
		}(conn)
	})
	mux.HandleFunc("GET /locations", func(w http.ResponseWriter, r *http.Request) {
		if !allow(r.RemoteAddr) {
			http.Error(w, "Too Many Requests", http.StatusTooManyRequests)
			return
		}
		ctx, cancel := context.WithTimeout(r.Context(), 5*time.Second)
		defer cancel()
		rows, err := tripDB.Query(ctx, `
			SELECT cl.trip_id, cl.lat, cl.lng, cl.updated_at
			FROM carrier_locations cl
			JOIN trips t ON t.id = cl.trip_id
			WHERE t.status = 'IN_TRANSIT'
		`)
		if err != nil {
			http.Error(w, "DB error", http.StatusInternalServerError)
			return
		}
		defer rows.Close()
		type item struct {
			TripID string  `json:"trip_id"`
			Lat    float64 `json:"lat"`
			Lng    float64 `json:"lng"`
			UpdatedAt time.Time `json:"updated_at"`
		}
		var res []item
		for rows.Next() {
			var it item
			_ = rows.Scan(&it.TripID, &it.Lat, &it.Lng, &it.UpdatedAt)
			res = append(res, it)
		}
		w.Header().Set("Content-Type", "application/json")
		enc := json.NewEncoder(w)
		_ = enc.Encode(res)
	})

	srv := &http.Server{
		Addr:    ":" + cfg.Server.Port,
		Handler: mux,
	}
	go func() {
		slog.Info("starting tracking-service", "port", cfg.Server.Port)
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			slog.Error("HTTP server failed", "error", err)
		}
	}()

	sigCh := make(chan os.Signal, 1)
	signal.Notify(sigCh, syscall.SIGTERM, syscall.SIGINT)
	<-sigCh
	slog.Info("shutting down gracefully...")
	ccancel()
	time.Sleep(2 * time.Second)
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	srv.Shutdown(ctx)
	consumer.Close()
	slog.Info("server stopped")
}

func upsertLocation(ctx context.Context, db *pgxpool.Pool, tripID string, lat, lng float64, ts time.Time) error {
	metrics.GPSUpdatesTotal.Inc()
	ctx, cancel := context.WithTimeout(ctx, 5*time.Second)
	defer cancel()
	// Only for active trips
	var st string
	_ = db.QueryRow(ctx, "SELECT status FROM trips WHERE id=$1", tripID).Scan(&st)
	if st != "IN_TRANSIT" {
		return nil
	}
	var cur time.Time
	_ = db.QueryRow(ctx, "SELECT updated_at FROM carrier_locations WHERE trip_id=$1", tripID).Scan(&cur)
	if !cur.IsZero() && !ts.After(cur) {
		return nil
	}
	_, err := db.Exec(ctx, `
		INSERT INTO carrier_locations(trip_id, lat, lng, updated_at)
		VALUES ($1, $2, $3, $4)
		ON CONFLICT (trip_id) DO UPDATE SET lat=$2, lng=$3, updated_at=$4
	`, tripID, lat, lng, ts)
	return err
}

func setupLogger() {
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{
		Level: slog.LevelInfo,
	})))
}

var lastReq = map[string]time.Time{}

func allow(remote string) bool {
	now := time.Now()
	if t, ok := lastReq[remote]; ok {
		if now.Sub(t) < 200*time.Millisecond {
			return false
		}
	}
	lastReq[remote] = now
	return true
}

func setupOTLP(cfg *config.Config) func() {
	if cfg.OTLP.Endpoint == "" {
		slog.Warn("OTLP endpoint not set, tracing disabled")
		return func() {}
	}
	exporter, err := otlptracehttp.New(context.Background(),
		otlptracehttp.WithEndpoint(cfg.OTLP.Endpoint),
		otlptracehttp.WithInsecure(),
	)
	if err != nil {
		slog.Error("failed to create OTLP exporter", "error", err)
		return func() {}
	}
	res, _ := resource.Merge(
		resource.Default(),
		resource.NewWithAttributes(
			semconv.SchemaURL,
			semconv.ServiceName("tracking-service"),
		),
	)
	provider := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter),
		sdktrace.WithResource(res),
	)
	otel.SetTracerProvider(provider)
	return func() {
		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
		defer cancel()
		_ = provider.Shutdown(ctx)
	}
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\tracking-service\go.mod
module bel-parcel/services/tracking-service

go 1.24.0

require (
	github.com/gorilla/websocket v1.5.1
	github.com/jackc/pgx/v5 v5.8.0
	github.com/prometheus/client_golang v1.23.2
	github.com/segmentio/kafka-go v0.4.49
	github.com/spf13/viper v1.21.0
	go.opentelemetry.io/otel v1.39.0
	go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0
	go.opentelemetry.io/otel/sdk v1.39.0
)

require (
	github.com/beorn7/perks v1.0.1 // indirect
	github.com/cenkalti/backoff/v5 v5.0.3 // indirect
	github.com/cespare/xxhash/v2 v2.3.0 // indirect
	github.com/fsnotify/fsnotify v1.9.0 // indirect
	github.com/go-logr/logr v1.4.3 // indirect
	github.com/go-logr/stdr v1.2.2 // indirect
	github.com/go-viper/mapstructure/v2 v2.4.0 // indirect
	github.com/google/uuid v1.6.0 // indirect
	github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.18.0 // indirect
	github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822 // indirect
	github.com/pelletier/go-toml/v2 v2.2.4 // indirect
	github.com/pierrec/lz4/v4 v4.1.15 // indirect
	github.com/prometheus/client_model v0.6.2 // indirect
	github.com/prometheus/common v0.66.1 // indirect
	github.com/prometheus/procfs v0.16.1 // indirect
	github.com/sagikazarmark/locafero v0.11.0 // indirect
	github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 // indirect
	github.com/spf13/afero v1.15.0 // indirect
	github.com/spf13/cast v1.10.0 // indirect
	github.com/spf13/pflag v1.0.10 // indirect
	github.com/subosito/gotenv v1.6.0 // indirect
	go.opentelemetry.io/auto/sdk v1.2.1 // indirect
	go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 // indirect
	go.opentelemetry.io/otel/metric v1.39.0 // indirect
	go.opentelemetry.io/otel/trace v1.39.0 // indirect
	go.opentelemetry.io/proto/otlp v1.9.0 // indirect
	go.yaml.in/yaml/v2 v2.4.2 // indirect
	go.yaml.in/yaml/v3 v3.0.4 // indirect
	golang.org/x/net v0.47.0 // indirect
	golang.org/x/sync v0.18.0 // indirect
	golang.org/x/sys v0.39.0 // indirect
	golang.org/x/text v0.31.0 // indirect
	google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 // indirect
	google.golang.org/grpc v1.77.0 // indirect
	google.golang.org/protobuf v1.36.10 // indirect
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\tracking-service\go.sum
github.com/beorn7/perks v1.0.1 h1:VlbKKnNfV8bJzeqoa4cOKqO6bYr3WgKZxO8Z16+hsOM=
github.com/beorn7/perks v1.0.1/go.mod h1:G2ZrVWU2WbWT9wwq4/hrbKbnv/1ERSJQ0ibhJ6rlkpw=
github.com/cenkalti/backoff/v5 v5.0.3 h1:ZN+IMa753KfX5hd8vVaMixjnqRZ3y8CuJKRKj1xcsSM=
github.com/cenkalti/backoff/v5 v5.0.3/go.mod h1:rkhZdG3JZukswDf7f0cwqPNk4K0sa+F97BxZthm/crw=
github.com/cespare/xxhash/v2 v2.3.0 h1:UL815xU9SqsFlibzuggzjXhog7bL6oX9BbNZnL2UFvs=
github.com/cespare/xxhash/v2 v2.3.0/go.mod h1:VGX0DQ3Q6kWi7AoAeZDth3/j3BFtOZR5XLFGgcrjCOs=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/frankban/quicktest v1.14.6 h1:7Xjx+VpznH+oBnejlPUj8oUpdxnVs4f8XU8WnHkI4W8=
github.com/frankban/quicktest v1.14.6/go.mod h1:4ptaffx2x8+WTWXmUCuVU6aPUX1/Mz7zb5vbUoiM6w0=
github.com/fsnotify/fsnotify v1.9.0 h1:2Ml+OJNzbYCTzsxtv8vKSFD9PbJjmhYF14k/jKC7S9k=
github.com/fsnotify/fsnotify v1.9.0/go.mod h1:8jBTzvmWwFyi3Pb8djgCCO5IBqzKJ/Jwo8TRcHyHii0=
github.com/go-logr/logr v1.2.2/go.mod h1:jdQByPbusPIv2/zmleS9BjJVeZ6kBagPoEUsqbVz/1A=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/go-viper/mapstructure/v2 v2.4.0 h1:EBsztssimR/CONLSZZ04E8qAkxNYq4Qp9LvH92wZUgs=
github.com/go-viper/mapstructure/v2 v2.4.0/go.mod h1:oJDH3BJKyqBA2TXFhDsKDGDTlndYOZ6rGS0BRZIxGhM=
github.com/golang/protobuf v1.5.4 h1:i7eJL8qZTpSEXOPTxNKhASYpMn+8e5Q6AdndVa1dWek=
github.com/golang/protobuf v1.5.4/go.mod h1:lnTiLA8Wa4RWRcIUkrtSVa5nRhsEGBg48fD6rSs7xps=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/gorilla/websocket v1.5.1 h1:gmztn0JnHVt9JZquRuzLw3g4wouNVzKL15iLr/zn/QY=
github.com/gorilla/websocket v1.5.1/go.mod h1:x3kM2JMyaluk02fnUJpQuwD2dCS5NDG2ZHL0uE0tcaY=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3 h1:NmZ1PKzSTQbuGHw9DGPFomqkkLWMC+vZCkfs+FHv1Vg=
github.com/grpc-ecosystem/grpc-gateway/v2 v2.27.3/go.mod h1:zQrxl1YP88HQlA6i9c63DSVPFklWpGX4OWAc9bFuaH4=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.8.0 h1:TYPDoleBBme0xGSAX3/+NujXXtpZn9HBONkQC7IEZSo=
github.com/jackc/pgx/v5 v5.8.0/go.mod h1:QVeDInX2m9VyzvNeiCJVjCkNFqzsNb43204HshNSZKw=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.18.0 h1:c/Cqfb0r+Yi+JtIEq73FWXVkRonBlf0CRNYc8Zttxdo=
github.com/klauspost/compress v1.18.0/go.mod h1:2Pp+KzxcywXVXMr50+X0Q/Lsb43OQHYWRCY2AiWywWQ=
github.com/kr/pretty v0.3.1 h1:flRD4NNwYAUpkphVc1HcthR4KEIFJ65n8Mw5qdRn3LE=
github.com/kr/pretty v0.3.1/go.mod h1:hoEshYVHaxMs3cyo3Yncou5ZscifuDolrwPKZanG3xk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/kylelemons/godebug v1.1.0 h1:RPNrshWIDI6G2gRW9EHilWtl7Z6Sb1BR0xunSBf0SNc=
github.com/kylelemons/godebug v1.1.0/go.mod h1:9/0rRGxNHcop5bhtWyNeEfOS8JIWk580+fNqagV/RAw=
github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822 h1:C3w9PqII01/Oq1c1nUAm88MOHcQC9l5mIlSMApZMrHA=
github.com/munnerz/goautoneg v0.0.0-20191010083416-a7dc8b61c822/go.mod h1:+n7T8mK8HuQTcFwEeznm/DIxMOiR9yIdICNftLE1DvQ=
github.com/pelletier/go-toml/v2 v2.2.4 h1:mye9XuhQ6gvn5h28+VilKrrPoQVanw5PMw/TB0t5Ec4=
github.com/pelletier/go-toml/v2 v2.2.4/go.mod h1:2gIqNv+qfxSVS7cM2xJQKtLSTLUE9V8t9Stt+h56mCY=
github.com/pierrec/lz4/v4 v4.1.15 h1:MO0/ucJhngq7299dKLwIMtgTfbkoSPF6AoMYDd8Q4q0=
github.com/pierrec/lz4/v4 v4.1.15/go.mod h1:gZWDp/Ze/IJXGXf23ltt2EXimqmTUXEy0GFuRQyBid4=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/prometheus/client_golang v1.23.2 h1:Je96obch5RDVy3FDMndoUsjAhG5Edi49h0RJWRi/o0o=
github.com/prometheus/client_golang v1.23.2/go.mod h1:Tb1a6LWHB3/SPIzCoaDXI4I8UHKeFTEQ1YCr+0Gyqmg=
github.com/prometheus/client_model v0.6.2 h1:oBsgwpGs7iVziMvrGhE53c/GrLUsZdHnqNwqPLxwZyk=
github.com/prometheus/client_model v0.6.2/go.mod h1:y3m2F6Gdpfy6Ut/GBsUqTWZqCUvMVzSfMLjcu6wAwpE=
github.com/prometheus/common v0.66.1 h1:h5E0h5/Y8niHc5DlaLlWLArTQI7tMrsfQjHV+d9ZoGs=
github.com/prometheus/common v0.66.1/go.mod h1:gcaUsgf3KfRSwHY4dIMXLPV0K/Wg1oZ8+SbZk/HH/dA=
github.com/prometheus/procfs v0.16.1 h1:hZ15bTNuirocR6u0JZ6BAHHmwS1p8B4P6MRqxtzMyRg=
github.com/prometheus/procfs v0.16.1/go.mod h1:teAbpZRB1iIAJYREa1LsoWUXykVXA1KlTmWl8x/U+Is=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/sagikazarmark/locafero v0.11.0 h1:1iurJgmM9G3PA/I+wWYIOw/5SyBtxapeHDcg+AAIFXc=
github.com/sagikazarmark/locafero v0.11.0/go.mod h1:nVIGvgyzw595SUSUE6tvCp3YYTeHs15MvlmU87WwIik=
github.com/segmentio/kafka-go v0.4.49 h1:GJiNX1d/g+kG6ljyJEoi9++PUMdXGAxb7JGPiDCuNmk=
github.com/segmentio/kafka-go v0.4.49/go.mod h1:Y1gn60kzLEEaW28YshXyk2+VCUKbJ3Qr6DrnT3i4+9E=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8 h1:+jumHNA0Wrelhe64i8F6HNlS8pkoyMv5sreGx2Ry5Rw=
github.com/sourcegraph/conc v0.3.1-0.20240121214520-5f936abd7ae8/go.mod h1:3n1Cwaq1E1/1lhQhtRK2ts/ZwZEhjcQeJQ1RuC6Q/8U=
github.com/spf13/afero v1.15.0 h1:b/YBCLWAJdFWJTN9cLhiXXcD7mzKn9Dm86dNnfyQw1I=
github.com/spf13/afero v1.15.0/go.mod h1:NC2ByUVxtQs4b3sIUphxK0NioZnmxgyCrfzeuq8lxMg=
github.com/spf13/cast v1.10.0 h1:h2x0u2shc1QuLHfxi+cTJvs30+ZAHOGRic8uyGTDWxY=
github.com/spf13/cast v1.10.0/go.mod h1:jNfB8QC9IA6ZuY2ZjDp0KtFO2LZZlg4S/7bzP6qqeHo=
github.com/spf13/pflag v1.0.10 h1:4EBh2KAYBwaONj6b2Ye1GiHfwjqyROoF4RwYO+vPwFk=
github.com/spf13/pflag v1.0.10/go.mod h1:McXfInJRrz4CZXVZOBLb0bTZqETkiAhM9Iw0y3An2Bg=
github.com/spf13/viper v1.21.0 h1:x5S+0EU27Lbphp4UKm1C+1oQO+rKx36vfCoaVebLFSU=
github.com/spf13/viper v1.21.0/go.mod h1:P0lhsswPGWD/1lZJ9ny3fYnVqxiegrlNrEmgLjbTCAY=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
github.com/subosito/gotenv v1.6.0 h1:9NlTDc1FTs4qu0DDq7AEtTPNw6SVm7uBMsUCUjABIf8=
github.com/subosito/gotenv v1.6.0/go.mod h1:Dk4QP5c2W3ibzajGcXpNraDfq2IrhjMIvMSWPKKo0FU=
github.com/xdg-go/pbkdf2 v1.0.0 h1:Su7DPu48wXMwC3bs7MCNG+z4FhcyEuz5dlvchbq0B0c=
github.com/xdg-go/pbkdf2 v1.0.0/go.mod h1:jrpuAogTd400dnrH08LKmI/xc1MbPOebTwRqcT5RDeI=
github.com/xdg-go/scram v1.1.2 h1:FHX5I5B4i4hKRVRBCFRxq1iQRej7WO3hhBuJf+UUySY=
github.com/xdg-go/scram v1.1.2/go.mod h1:RT/sEzTbU5y00aCK8UOx6R7YryM0iF1N2MOmC3kKLN4=
github.com/xdg-go/stringprep v1.0.4 h1:XLI/Ng3O1Atzq0oBs3TWm+5ZVgkq2aqdlvP9JtoZ6c8=
github.com/xdg-go/stringprep v1.0.4/go.mod h1:mPGuuIYwz7CmR2bT9j4GbQqutWS1zV24gijq1dTyGkM=
go.opentelemetry.io/auto/sdk v1.2.1 h1:jXsnJ4Lmnqd11kwkBV2LgLoFMZKizbCi5fNZ/ipaZ64=
go.opentelemetry.io/auto/sdk v1.2.1/go.mod h1:KRTj+aOaElaLi+wW1kO/DZRXwkF4C5xPbEe3ZiIhN7Y=
go.opentelemetry.io/otel v1.39.0 h1:8yPrr/S0ND9QEfTfdP9V+SiwT4E0G7Y5MO7p85nis48=
go.opentelemetry.io/otel v1.39.0/go.mod h1:kLlFTywNWrFyEdH0oj2xK0bFYZtHRYUdv1NklR/tgc8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0 h1:f0cb2XPmrqn4XMy9PNliTgRKJgS5WcL/u0/WRYGz4t0=
go.opentelemetry.io/otel/exporters/otlp/otlptrace v1.39.0/go.mod h1:vnakAaFckOMiMtOIhFI2MNH4FYrZzXCYxmb1LlhoGz8=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0 h1:Ckwye2FpXkYgiHX7fyVrN1uA/UYd9ounqqTuSNAv0k4=
go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp v1.39.0/go.mod h1:teIFJh5pW2y+AN7riv6IBPX2DuesS3HgP39mwOspKwU=
go.opentelemetry.io/otel/metric v1.39.0 h1:d1UzonvEZriVfpNKEVmHXbdf909uGTOQjA0HF0Ls5Q0=
go.opentelemetry.io/otel/metric v1.39.0/go.mod h1:jrZSWL33sD7bBxg1xjrqyDjnuzTUB0x1nBERXd7Ftcs=
go.opentelemetry.io/otel/sdk v1.39.0 h1:nMLYcjVsvdui1B/4FRkwjzoRVsMK8uL/cj0OyhKzt18=
go.opentelemetry.io/otel/sdk v1.39.0/go.mod h1:vDojkC4/jsTJsE+kh+LXYQlbL8CgrEcwmt1ENZszdJE=
go.opentelemetry.io/otel/sdk/metric v1.39.0 h1:cXMVVFVgsIf2YL6QkRF4Urbr/aMInf+2WKg+sEJTtB8=
go.opentelemetry.io/otel/sdk/metric v1.39.0/go.mod h1:xq9HEVH7qeX69/JnwEfp6fVq5wosJsY1mt4lLfYdVew=
go.opentelemetry.io/otel/trace v1.39.0 h1:2d2vfpEDmCJ5zVYz7ijaJdOF59xLomrvj7bjt6/qCJI=
go.opentelemetry.io/otel/trace v1.39.0/go.mod h1:88w4/PnZSazkGzz/w84VHpQafiU4EtqqlVdxWy+rNOA=
go.opentelemetry.io/proto/otlp v1.9.0 h1:l706jCMITVouPOqEnii2fIAuO3IVGBRPV5ICjceRb/A=
go.opentelemetry.io/proto/otlp v1.9.0/go.mod h1:xE+Cx5E/eEHw+ISFkwPLwCZefwVjY+pqKg1qcK03+/4=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.yaml.in/yaml/v2 v2.4.2 h1:DzmwEr2rDGHl7lsFgAHxmNz/1NlQ7xLIrlN2h5d1eGI=
go.yaml.in/yaml/v2 v2.4.2/go.mod h1:081UH+NErpNdqlCXm3TtEran0rJZGxAYx9hb/ELlsPU=
go.yaml.in/yaml/v3 v3.0.4 h1:tfq32ie2Jv2UxXFdLJdh3jXuOzWiL1fo0bu/FbuKpbc=
go.yaml.in/yaml/v3 v3.0.4/go.mod h1:DhzuOOF2ATzADvBadXxruRBLzYTpT36CKvDb3+aBEFg=
golang.org/x/net v0.47.0 h1:Mx+4dIFzqraBXUugkia1OOvlD6LemFo1ALMHjrXDOhY=
golang.org/x/net v0.47.0/go.mod h1:/jNxtkgq5yWUGYkaZGqo27cfGZ1c5Nen03aYrrKpVRU=
golang.org/x/sync v0.18.0 h1:kr88TuHDroi+UVf+0hZnirlk8o8T+4MrK6mr60WkH/I=
golang.org/x/sync v0.18.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.39.0 h1:CvCKL8MeisomCi6qNZ+wbb0DN9E5AATixKsvNtMoMFk=
golang.org/x/sys v0.39.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.31.0 h1:aC8ghyu4JhP8VojJ2lEHBnochRno1sgL6nEi9WGFGMM=
golang.org/x/text v0.31.0/go.mod h1:tKRAlv61yKIjGGHX/4tP1LTbc13YSec1pxVEWXzfoeM=
gonum.org/v1/gonum v0.16.0 h1:5+ul4Swaf3ESvrOnidPp4GZbzf0mxVQpDCYUQE7OJfk=
gonum.org/v1/gonum v0.16.0/go.mod h1:fef3am4MQ93R2HHpKnLk4/Tbh/s0+wqD5nfa6Pnwy4E=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217 h1:fCvbg86sFXwdrl5LgVcTEvNC+2txB5mgROGmRL5mrls=
google.golang.org/genproto/googleapis/api v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:+rXWjjaukWZun3mLfjmVnQi18E1AsFbDN9QdJ5YXLto=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217 h1:gRkg/vSppuSQoDjxyiGfN4Upv/h/DQmIR10ZU8dh4Ww=
google.golang.org/genproto/googleapis/rpc v0.0.0-20251202230838-ff82c1b0f217/go.mod h1:7i2o+ce6H/6BluujYR+kqX3GKH+dChPTQU19wjRPiGk=
google.golang.org/grpc v1.77.0 h1:wVVY6/8cGA6vvffn+wWK5ToddbgdU3d8MNENr4evgXM=
google.golang.org/grpc v1.77.0/go.mod h1:z0BY1iVj0q8E1uSQCjL9cppRj+gnZjzDnzV0dHhrNig=
google.golang.org/protobuf v1.36.10 h1:AYd7cD/uASjIL6Q9LiTjz8JLcrh/88q5UObnmY3aOOE=
google.golang.org/protobuf v1.36.10/go.mod h1:HTf+CrKn2C3g5S8VImy6tdcUvCska2kB7j23XfzDpco=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\tracking-service\internal\config\config.go
package config

import (
	"strings"
	"time"

	"github.com/spf13/viper"
)

type Config struct {
	Server struct {
		Port string
	}
	DB struct {
		DSN string
	}
	Kafka struct {
		Brokers []string
		GroupID string
		Topic   string
		Timeout time.Duration
	}
	OTLP struct {
		Endpoint string
	}
}

func Load() (*Config, error) {
	v := viper.New()
	v.SetDefault("server.port", "8087")
	v.SetDefault("db.dsn", "postgres://user:pass@localhost:5432/trip_db?sslmode=disable")
	v.SetDefault("kafka.brokers", []string{"localhost:9092"})
	v.SetDefault("kafka.groupid", "tracking-service")
	v.SetDefault("kafka.topic", "events.carrier_location")
	v.SetDefault("kafka.timeout", 5*time.Second)
	v.SetDefault("otlp.endpoint", "")

	v.SetConfigName("config")
	v.SetConfigType("yaml")
	v.AddConfigPath(".")
	v.AddConfigPath("./config")

	v.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
	v.AutomaticEnv()

	if err := v.ReadInConfig(); err != nil {
		if _, ok := err.(viper.ConfigFileNotFoundError); !ok {
			return nil, err
		}
	}
	var cfg Config
	if err := v.Unmarshal(&cfg); err != nil {
		return nil, err
	}
	return &cfg, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\tracking-service\internal\infra\db\db.go
package db

import (
	"context"
	"time"

	"github.com/jackc/pgx/v5/pgxpool"
)

func NewPgxPool(dsn string) (*pgxpool.Pool, error) {
	config, err := pgxpool.ParseConfig(dsn)
	if err != nil {
		return nil, err
	}
	config.MaxConns = 10
	config.MinConns = 2
	config.MaxConnLifetime = 30 * time.Minute
	config.HealthCheckPeriod = 1 * time.Minute

	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	pool, err := pgxpool.NewWithConfig(ctx, config)
	if err != nil {
		return nil, err
	}
	if err := pool.Ping(ctx); err != nil {
		pool.Close()
		return nil, err
	}
	return pool, nil
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\tracking-service\internal\infra\kafka\consumer.go
package kafka

import (
	"context"
	"time"

	"github.com/segmentio/kafka-go"
)

type Consumer struct {
	readers []*kafka.Reader
}

func NewConsumer(brokers []string, groupID string, topics []string, timeout time.Duration) *Consumer {
	var readers []*kafka.Reader
	for _, t := range topics {
		r := kafka.NewReader(kafka.ReaderConfig{
			Brokers:        brokers,
			GroupID:        groupID,
			Topic:          t,
			MaxWait:        timeout,
			CommitInterval: time.Second,
		})
		readers = append(readers, r)
	}
	return &Consumer{readers: readers}
}

func (c *Consumer) Start(ctx context.Context, handler func(topic string, key, value []byte) error) {
	for _, r := range c.readers {
		go func(reader *kafka.Reader) {
			for {
				m, err := reader.FetchMessage(ctx)
				if err != nil {
					return
				}
				if handler != nil {
					if e := handler(reader.Config().Topic, m.Key, m.Value); e == nil {
						_ = reader.CommitMessages(ctx, m)
					}
				}
			}
		}(r)
	}
}

func (c *Consumer) Close() error {
	var err error
	for _, r := range c.readers {
		if e := r.Close(); e != nil {
			err = e
		}
	}
	return err
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\services\tracking-service\internal\metrics\metrics.go
package metrics

import "github.com/prometheus/client_golang/prometheus"

var (
	GPSUpdatesTotal = prometheus.NewCounter(
		prometheus.CounterOpts{
			Name: "gps_updates_total",
			Help: "Total GPS updates processed",
		},
	)
)

func Register() {
	prometheus.MustRegister(GPSUpdatesTotal)
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\package.json
{
  "name": "operator-panel",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@emotion/react": "^11.11.4",
    "@emotion/styled": "^11.11.5",
    "@mui/material": "^5.15.14",
    "@mui/x-data-grid": "^5.17.24",
    "leaflet": "^1.9.4",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-leaflet": "^4.2.1",
    "react-router-dom": "^6.23.0"
  },
  "devDependencies": {
    "@types/leaflet": "^1.9.5",
    "@vitejs/plugin-react": "^4.2.0",
    "typescript": "^5.6.3",
    "vite": "^5.0.12"
  }
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\package-lock.json
{
  "name": "operator-panel",
  "version": "0.1.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "operator-panel",
      "version": "0.1.0",
      "dependencies": {
        "@emotion/react": "^11.11.4",
        "@emotion/styled": "^11.11.5",
        "@mui/material": "^5.15.14",
        "@mui/x-data-grid": "^5.17.24",
        "leaflet": "^1.9.4",
        "react": "^18.2.0",
        "react-dom": "^18.2.0",
        "react-leaflet": "^4.2.1",
        "react-router-dom": "^6.23.0"
      },
      "devDependencies": {
        "@types/leaflet": "^1.9.5",
        "@vitejs/plugin-react": "^4.2.0",
        "typescript": "^5.6.3",
        "vite": "^5.0.12"
      }
    },
    "node_modules/@babel/code-frame": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.28.6.tgz",
      "integrity": "sha512-JYgintcMjRiCvS8mMECzaEn+m3PfoQiyqukOMCCVQtoJGYJw8j/8LBJEiqkHLkfwCcs74E3pbAUFNg7d9VNJ+Q==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-validator-identifier": "^7.28.5",
        "js-tokens": "^4.0.0",
        "picocolors": "^1.1.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/compat-data": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.6.tgz",
      "integrity": "sha512-2lfu57JtzctfIrcGMz992hyLlByuzgIk58+hhGCxjKZ3rWI82NnVLjXcaTqkI2NvlcvOskZaiZ5kjUALo3Lpxg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/core": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.6.tgz",
      "integrity": "sha512-H3mcG6ZDLTlYfaSNi0iOKkigqMFvkTKlGUYlD8GW7nNOYRrevuA46iTypPyv+06V3fEmvvazfntkBU34L0azAw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.28.6",
        "@babel/generator": "^7.28.6",
        "@babel/helper-compilation-targets": "^7.28.6",
        "@babel/helper-module-transforms": "^7.28.6",
        "@babel/helpers": "^7.28.6",
        "@babel/parser": "^7.28.6",
        "@babel/template": "^7.28.6",
        "@babel/traverse": "^7.28.6",
        "@babel/types": "^7.28.6",
        "@jridgewell/remapping": "^2.3.5",
        "convert-source-map": "^2.0.0",
        "debug": "^4.1.0",
        "gensync": "^1.0.0-beta.2",
        "json5": "^2.2.3",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/babel"
      }
    },
    "node_modules/@babel/core/node_modules/convert-source-map": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
      "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@babel/generator": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.6.tgz",
      "integrity": "sha512-lOoVRwADj8hjf7al89tvQ2a1lf53Z+7tiXMgpZJL3maQPDxh0DgLMN62B2MKUOFcoodBHLMbDM6WAbKgNy5Suw==",
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.28.6",
        "@babel/types": "^7.28.6",
        "@jridgewell/gen-mapping": "^0.3.12",
        "@jridgewell/trace-mapping": "^0.3.28",
        "jsesc": "^3.0.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.28.6.tgz",
      "integrity": "sha512-JYtls3hqi15fcx5GaSNL7SCTJ2MNmjrkHXg4FSpOA/grxK8KwyZ5bubHsCq8FXCkua6xhuaaBit+3b7+VZRfcA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/compat-data": "^7.28.6",
        "@babel/helper-validator-option": "^7.27.1",
        "browserslist": "^4.24.0",
        "lru-cache": "^5.1.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-globals": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
      "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-imports": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.28.6.tgz",
      "integrity": "sha512-l5XkZK7r7wa9LucGw9LwZyyCUscb4x37JWTPz7swwFE/0FMQAGpiWUZn8u9DzkSBWEcK25jmvubfpw2dnAMdbw==",
      "license": "MIT",
      "dependencies": {
        "@babel/traverse": "^7.28.6",
        "@babel/types": "^7.28.6"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-transforms": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.6.tgz",
      "integrity": "sha512-67oXFAYr2cDLDVGLXTEABjdBJZ6drElUSI7WKp70NrpyISso3plG9SAGEF6y7zbha/wOzUByWWTJvEDVNIUGcA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-module-imports": "^7.28.6",
        "@babel/helper-validator-identifier": "^7.28.5",
        "@babel/traverse": "^7.28.6"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-plugin-utils": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.28.6.tgz",
      "integrity": "sha512-S9gzZ/bz83GRysI7gAD4wPT/AI3uCnY+9xn+Mx/KPs2JwHJIz1W8PZkg2cqyt3RNOBM8ejcXhV6y8Og7ly/Dug==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-option": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
      "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helpers": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.6.tgz",
      "integrity": "sha512-xOBvwq86HHdB7WUDTfKfT/Vuxh7gElQ+Sfti2Cy6yIWNW05P8iUslOVcZ4/sKbE+/jQaukQAdz/gf3724kYdqw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/template": "^7.28.6",
        "@babel/types": "^7.28.6"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.6.tgz",
      "integrity": "sha512-TeR9zWR18BvbfPmGbLampPMW+uW1NZnJlRuuHso8i87QZNq2JRF9i6RgxRqtEq+wQGsS19NNTWr2duhnE49mfQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.6"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-self": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.27.1.tgz",
      "integrity": "sha512-6UzkCs+ejGdZ5mFFC/OCUrv028ab2fp1znZmCZjAOBKiBK2jXD1O+BPSfX8X2qjJ75fZBMSnQn3Rq2mrBJK2mw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-source": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.27.1.tgz",
      "integrity": "sha512-zbwoTsBruTeKB9hSq73ha66iFeJHuaFkUbwvqElnygoNbj/jHRsSeokowZFN3CZ64IvEqcmmkVe89OPXc7ldAw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/runtime": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/runtime/-/runtime-7.28.6.tgz",
      "integrity": "sha512-05WQkdpL9COIMz4LjTxGpPNCdlpyimKppYNoJ5Di5EUObifl8t4tuLuUBBZEpoLYOmfvIWrsp9fCl0HoPRVTdA==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/template": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.28.6.tgz",
      "integrity": "sha512-YA6Ma2KsCdGb+WC6UpBVFJGXL58MDA6oyONbjyF/+5sBgxY/dwkhLogbMT2GXXyU84/IhRw/2D1Os1B/giz+BQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.28.6",
        "@babel/parser": "^7.28.6",
        "@babel/types": "^7.28.6"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/traverse": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.28.6.tgz",
      "integrity": "sha512-fgWX62k02qtjqdSNTAGxmKYY/7FSL9WAS1o2Hu5+I5m9T0yxZzr4cnrfXQ/MX0rIifthCSs6FKTlzYbJcPtMNg==",
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.28.6",
        "@babel/generator": "^7.28.6",
        "@babel/helper-globals": "^7.28.0",
        "@babel/parser": "^7.28.6",
        "@babel/template": "^7.28.6",
        "@babel/types": "^7.28.6",
        "debug": "^4.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/types": {
      "version": "7.28.6",
      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.6.tgz",
      "integrity": "sha512-0ZrskXVEHSWIqZM/sQZ4EV3jZJXRkio/WCxaqKZP1g//CEWEPSfeZFcms4XeKBCHU0ZKnIkdJeU/kF+eRp5lBg==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-string-parser": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@emotion/babel-plugin": {
      "version": "11.13.5",
      "resolved": "https://registry.npmjs.org/@emotion/babel-plugin/-/babel-plugin-11.13.5.tgz",
      "integrity": "sha512-pxHCpT2ex+0q+HH91/zsdHkw/lXd468DIN2zvfvLtPKLLMo6gQj7oLObq8PhkrxOZb/gGCq03S3Z7PDhS8pduQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-module-imports": "^7.16.7",
        "@babel/runtime": "^7.18.3",
        "@emotion/hash": "^0.9.2",
        "@emotion/memoize": "^0.9.0",
        "@emotion/serialize": "^1.3.3",
        "babel-plugin-macros": "^3.1.0",
        "convert-source-map": "^1.5.0",
        "escape-string-regexp": "^4.0.0",
        "find-root": "^1.1.0",
        "source-map": "^0.5.7",
        "stylis": "4.2.0"
      }
    },
    "node_modules/@emotion/cache": {
      "version": "11.14.0",
      "resolved": "https://registry.npmjs.org/@emotion/cache/-/cache-11.14.0.tgz",
      "integrity": "sha512-L/B1lc/TViYk4DcpGxtAVbx0ZyiKM5ktoIyafGkH6zg/tj+mA+NE//aPYKG0k8kCHSHVJrpLpcAlOBEXQ3SavA==",
      "license": "MIT",
      "dependencies": {
        "@emotion/memoize": "^0.9.0",
        "@emotion/sheet": "^1.4.0",
        "@emotion/utils": "^1.4.2",
        "@emotion/weak-memoize": "^0.4.0",
        "stylis": "4.2.0"
      }
    },
    "node_modules/@emotion/hash": {
      "version": "0.9.2",
      "resolved": "https://registry.npmjs.org/@emotion/hash/-/hash-0.9.2.tgz",
      "integrity": "sha512-MyqliTZGuOm3+5ZRSaaBGP3USLw6+EGykkwZns2EPC5g8jJ4z9OrdZY9apkl3+UP9+sdz76YYkwCKP5gh8iY3g==",
      "license": "MIT"
    },
    "node_modules/@emotion/is-prop-valid": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/@emotion/is-prop-valid/-/is-prop-valid-1.4.0.tgz",
      "integrity": "sha512-QgD4fyscGcbbKwJmqNvUMSE02OsHUa+lAWKdEUIJKgqe5IwRSKd7+KhibEWdaKwgjLj0DRSHA9biAIqGBk05lw==",
      "license": "MIT",
      "dependencies": {
        "@emotion/memoize": "^0.9.0"
      }
    },
    "node_modules/@emotion/memoize": {
      "version": "0.9.0",
      "resolved": "https://registry.npmjs.org/@emotion/memoize/-/memoize-0.9.0.tgz",
      "integrity": "sha512-30FAj7/EoJ5mwVPOWhAyCX+FPfMDrVecJAM+Iw9NRoSl4BBAQeqj4cApHHUXOVvIPgLVDsCFoz/hGD+5QQD1GQ==",
      "license": "MIT"
    },
    "node_modules/@emotion/react": {
      "version": "11.14.0",
      "resolved": "https://registry.npmjs.org/@emotion/react/-/react-11.14.0.tgz",
      "integrity": "sha512-O000MLDBDdk/EohJPFUqvnp4qnHeYkVP5B0xEG0D/L7cOKP9kefu2DXn8dj74cQfsEzUqh+sr1RzFqiL1o+PpA==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.18.3",
        "@emotion/babel-plugin": "^11.13.5",
        "@emotion/cache": "^11.14.0",
        "@emotion/serialize": "^1.3.3",
        "@emotion/use-insertion-effect-with-fallbacks": "^1.2.0",
        "@emotion/utils": "^1.4.2",
        "@emotion/weak-memoize": "^0.4.0",
        "hoist-non-react-statics": "^3.3.1"
      },
      "peerDependencies": {
        "react": ">=16.8.0"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@emotion/serialize": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/@emotion/serialize/-/serialize-1.3.3.tgz",
      "integrity": "sha512-EISGqt7sSNWHGI76hC7x1CksiXPahbxEOrC5RjmFRJTqLyEK9/9hZvBbiYn70dw4wuwMKiEMCUlR6ZXTSWQqxA==",
      "license": "MIT",
      "dependencies": {
        "@emotion/hash": "^0.9.2",
        "@emotion/memoize": "^0.9.0",
        "@emotion/unitless": "^0.10.0",
        "@emotion/utils": "^1.4.2",
        "csstype": "^3.0.2"
      }
    },
    "node_modules/@emotion/sheet": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/@emotion/sheet/-/sheet-1.4.0.tgz",
      "integrity": "sha512-fTBW9/8r2w3dXWYM4HCB1Rdp8NLibOw2+XELH5m5+AkWiL/KqYX6dc0kKYlaYyKjrQ6ds33MCdMPEwgs2z1rqg==",
      "license": "MIT"
    },
    "node_modules/@emotion/styled": {
      "version": "11.14.1",
      "resolved": "https://registry.npmjs.org/@emotion/styled/-/styled-11.14.1.tgz",
      "integrity": "sha512-qEEJt42DuToa3gurlH4Qqc1kVpNq8wO8cJtDzU46TjlzWjDlsVyevtYCRijVq3SrHsROS+gVQ8Fnea108GnKzw==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.18.3",
        "@emotion/babel-plugin": "^11.13.5",
        "@emotion/is-prop-valid": "^1.3.0",
        "@emotion/serialize": "^1.3.3",
        "@emotion/use-insertion-effect-with-fallbacks": "^1.2.0",
        "@emotion/utils": "^1.4.2"
      },
      "peerDependencies": {
        "@emotion/react": "^11.0.0-rc.0",
        "react": ">=16.8.0"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@emotion/unitless": {
      "version": "0.10.0",
      "resolved": "https://registry.npmjs.org/@emotion/unitless/-/unitless-0.10.0.tgz",
      "integrity": "sha512-dFoMUuQA20zvtVTuxZww6OHoJYgrzfKM1t52mVySDJnMSEa08ruEvdYQbhvyu6soU+NeLVd3yKfTfT0NeV6qGg==",
      "license": "MIT"
    },
    "node_modules/@emotion/use-insertion-effect-with-fallbacks": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/@emotion/use-insertion-effect-with-fallbacks/-/use-insertion-effect-with-fallbacks-1.2.0.tgz",
      "integrity": "sha512-yJMtVdH59sxi/aVJBpk9FQq+OR8ll5GT8oWd57UpeaKEVGab41JWaCFA7FRLoMLloOZF/c/wsPoe+bfGmRKgDg==",
      "license": "MIT",
      "peerDependencies": {
        "react": ">=16.8.0"
      }
    },
    "node_modules/@emotion/utils": {
      "version": "1.4.2",
      "resolved": "https://registry.npmjs.org/@emotion/utils/-/utils-1.4.2.tgz",
      "integrity": "sha512-3vLclRofFziIa3J2wDh9jjbkUz9qk5Vi3IZ/FSTKViB0k+ef0fPV7dYrUIugbgupYDx7v9ud/SjrtEP8Y4xLoA==",
      "license": "MIT"
    },
    "node_modules/@emotion/weak-memoize": {
      "version": "0.4.0",
      "resolved": "https://registry.npmjs.org/@emotion/weak-memoize/-/weak-memoize-0.4.0.tgz",
      "integrity": "sha512-snKqtPW01tN0ui7yu9rGv69aJXr/a/Ywvl11sUjNtEcRc+ng/mQriFL0wLXMef74iHa/EkftbDzU9F8iFbH+zg==",
      "license": "MIT"
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@jridgewell/gen-mapping": {
      "version": "0.3.13",
      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.0",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/remapping": {
      "version": "2.3.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/remapping/-/remapping-2.3.5.tgz",
      "integrity": "sha512-LI9u/+laYG4Ds1TDKSJW2YPrIlcVYOwi2fUC6xB43lueCjgxV4lffOCZCtYFiH6TNOX+tQKXx97T4IKHbhyHEQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.5",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/resolve-uri": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
      "license": "MIT",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "license": "MIT"
    },
    "node_modules/@jridgewell/trace-mapping": {
      "version": "0.3.31",
      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
      "license": "MIT",
      "dependencies": {
        "@jridgewell/resolve-uri": "^3.1.0",
        "@jridgewell/sourcemap-codec": "^1.4.14"
      }
    },
    "node_modules/@mui/core-downloads-tracker": {
      "version": "5.18.0",
      "resolved": "https://registry.npmjs.org/@mui/core-downloads-tracker/-/core-downloads-tracker-5.18.0.tgz",
      "integrity": "sha512-jbhwoQ1AY200PSSOrNXmrFCaSDSJWP7qk6urkTmIirvRXDROkqe+QwcLlUiw/PrREwsIF/vm3/dAXvjlMHF0RA==",
      "license": "MIT",
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mui-org"
      }
    },
    "node_modules/@mui/material": {
      "version": "5.18.0",
      "resolved": "https://registry.npmjs.org/@mui/material/-/material-5.18.0.tgz",
      "integrity": "sha512-bbH/HaJZpFtXGvWg3TsBWG4eyt3gah3E7nCNU8GLyRjVoWcA91Vm/T+sjHfUcwgJSw9iLtucfHBoq+qW/T30aA==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.23.9",
        "@mui/core-downloads-tracker": "^5.18.0",
        "@mui/system": "^5.18.0",
        "@mui/types": "~7.2.15",
        "@mui/utils": "^5.17.1",
        "@popperjs/core": "^2.11.8",
        "@types/react-transition-group": "^4.4.10",
        "clsx": "^2.1.0",
        "csstype": "^3.1.3",
        "prop-types": "^15.8.1",
        "react-is": "^19.0.0",
        "react-transition-group": "^4.4.5"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mui-org"
      },
      "peerDependencies": {
        "@emotion/react": "^11.5.0",
        "@emotion/styled": "^11.3.0",
        "@types/react": "^17.0.0 || ^18.0.0 || ^19.0.0",
        "react": "^17.0.0 || ^18.0.0 || ^19.0.0",
        "react-dom": "^17.0.0 || ^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@emotion/react": {
          "optional": true
        },
        "@emotion/styled": {
          "optional": true
        },
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@mui/private-theming": {
      "version": "5.17.1",
      "resolved": "https://registry.npmjs.org/@mui/private-theming/-/private-theming-5.17.1.tgz",
      "integrity": "sha512-XMxU0NTYcKqdsG8LRmSoxERPXwMbp16sIXPcLVgLGII/bVNagX0xaheWAwFv8+zDK7tI3ajllkuD3GZZE++ICQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.23.9",
        "@mui/utils": "^5.17.1",
        "prop-types": "^15.8.1"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mui-org"
      },
      "peerDependencies": {
        "@types/react": "^17.0.0 || ^18.0.0 || ^19.0.0",
        "react": "^17.0.0 || ^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@mui/styled-engine": {
      "version": "5.18.0",
      "resolved": "https://registry.npmjs.org/@mui/styled-engine/-/styled-engine-5.18.0.tgz",
      "integrity": "sha512-BN/vKV/O6uaQh2z5rXV+MBlVrEkwoS/TK75rFQ2mjxA7+NBo8qtTAOA4UaM0XeJfn7kh2wZ+xQw2HAx0u+TiBg==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.23.9",
        "@emotion/cache": "^11.13.5",
        "@emotion/serialize": "^1.3.3",
        "csstype": "^3.1.3",
        "prop-types": "^15.8.1"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mui-org"
      },
      "peerDependencies": {
        "@emotion/react": "^11.4.1",
        "@emotion/styled": "^11.3.0",
        "react": "^17.0.0 || ^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@emotion/react": {
          "optional": true
        },
        "@emotion/styled": {
          "optional": true
        }
      }
    },
    "node_modules/@mui/system": {
      "version": "5.18.0",
      "resolved": "https://registry.npmjs.org/@mui/system/-/system-5.18.0.tgz",
      "integrity": "sha512-ojZGVcRWqWhu557cdO3pWHloIGJdzVtxs3rk0F9L+x55LsUjcMUVkEhiF7E4TMxZoF9MmIHGGs0ZX3FDLAf0Xw==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.23.9",
        "@mui/private-theming": "^5.17.1",
        "@mui/styled-engine": "^5.18.0",
        "@mui/types": "~7.2.15",
        "@mui/utils": "^5.17.1",
        "clsx": "^2.1.0",
        "csstype": "^3.1.3",
        "prop-types": "^15.8.1"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mui-org"
      },
      "peerDependencies": {
        "@emotion/react": "^11.5.0",
        "@emotion/styled": "^11.3.0",
        "@types/react": "^17.0.0 || ^18.0.0 || ^19.0.0",
        "react": "^17.0.0 || ^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@emotion/react": {
          "optional": true
        },
        "@emotion/styled": {
          "optional": true
        },
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@mui/types": {
      "version": "7.2.24",
      "resolved": "https://registry.npmjs.org/@mui/types/-/types-7.2.24.tgz",
      "integrity": "sha512-3c8tRt/CbWZ+pEg7QpSwbdxOk36EfmhbKf6AGZsD1EcLDLTSZoxxJ86FVtcjxvjuhdyBiWKSTGZFaXCnidO2kw==",
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "^17.0.0 || ^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@mui/utils": {
      "version": "5.17.1",
      "resolved": "https://registry.npmjs.org/@mui/utils/-/utils-5.17.1.tgz",
      "integrity": "sha512-jEZ8FTqInt2WzxDV8bhImWBqeQRD99c/id/fq83H0ER9tFl+sfZlaAoCdznGvbSQQ9ividMxqSV2c7cC1vBcQg==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.23.9",
        "@mui/types": "~7.2.15",
        "@types/prop-types": "^15.7.12",
        "clsx": "^2.1.1",
        "prop-types": "^15.8.1",
        "react-is": "^19.0.0"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mui-org"
      },
      "peerDependencies": {
        "@types/react": "^17.0.0 || ^18.0.0 || ^19.0.0",
        "react": "^17.0.0 || ^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@mui/x-data-grid": {
      "version": "5.17.26",
      "resolved": "https://registry.npmjs.org/@mui/x-data-grid/-/x-data-grid-5.17.26.tgz",
      "integrity": "sha512-eGJq9J0g9cDGLFfMmugOadZx0mJeOd/yQpHwEa5gUXyONS6qF0OhXSWyDOhDdA3l2TOoQzotMN5dY/T4Wl1KYA==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.18.9",
        "@mui/utils": "^5.10.3",
        "clsx": "^1.2.1",
        "prop-types": "^15.8.1",
        "reselect": "^4.1.6"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mui"
      },
      "peerDependencies": {
        "@mui/material": "^5.4.1",
        "@mui/system": "^5.4.1",
        "react": "^17.0.2 || ^18.0.0",
        "react-dom": "^17.0.2 || ^18.0.0"
      }
    },
    "node_modules/@mui/x-data-grid/node_modules/clsx": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/clsx/-/clsx-1.2.1.tgz",
      "integrity": "sha512-EcR6r5a8bj6pu3ycsa/E/cKVGuTgZJZdsyUYHOksG/UHIiKfjxzRxYJpyVBwYaQeOvghal9fcc4PidlgzugAQg==",
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/@popperjs/core": {
      "version": "2.11.8",
      "resolved": "https://registry.npmjs.org/@popperjs/core/-/core-2.11.8.tgz",
      "integrity": "sha512-P1st0aksCrn9sGZhp8GMYwBnQsbvAWsZAX44oXNNvLHGqAOcoVxmjZiohstwQ7SqKnbR47akdNi+uleWD8+g6A==",
      "license": "MIT",
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/popperjs"
      }
    },
    "node_modules/@react-leaflet/core": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/@react-leaflet/core/-/core-2.1.0.tgz",
      "integrity": "sha512-Qk7Pfu8BSarKGqILj4x7bCSZ1pjuAPZ+qmRwH5S7mDS91VSbVVsJSrW4qA+GPrro8t69gFYVMWb1Zc4yFmPiVg==",
      "license": "Hippocratic-2.1",
      "peerDependencies": {
        "leaflet": "^1.9.0",
        "react": "^18.0.0",
        "react-dom": "^18.0.0"
      }
    },
    "node_modules/@remix-run/router": {
      "version": "1.23.2",
      "resolved": "https://registry.npmjs.org/@remix-run/router/-/router-1.23.2.tgz",
      "integrity": "sha512-Ic6m2U/rMjTkhERIa/0ZtXJP17QUi2CbWE7cqx4J58M8aA3QTfW+2UlQ4psvTX9IO1RfNVhK3pcpdjej7L+t2w==",
      "license": "MIT",
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/@rolldown/pluginutils": {
      "version": "1.0.0-beta.27",
      "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.27.tgz",
      "integrity": "sha512-+d0F4MKMCbeVUJwG96uQ4SgAznZNSq93I3V+9NHA4OpvqG8mRCpGdKmK8l/dl02h2CCDHwW2FqilnTyDcAnqjA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.55.1.tgz",
      "integrity": "sha512-9R0DM/ykwfGIlNu6+2U09ga0WXeZ9MRC2Ter8jnz8415VbuIykVuc6bhdrbORFZANDmTDvq26mJrEVTl8TdnDg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.55.1.tgz",
      "integrity": "sha512-eFZCb1YUqhTysgW3sj/55du5cG57S7UTNtdMjCW7LwVcj3dTTcowCsC8p7uBdzKsZYa8J7IDE8lhMI+HX1vQvg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.55.1.tgz",
      "integrity": "sha512-p3grE2PHcQm2e8PSGZdzIhCKbMCw/xi9XvMPErPhwO17vxtvCN5FEA2mSLgmKlCjHGMQTP6phuQTYWUnKewwGg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.55.1.tgz",
      "integrity": "sha512-rDUjG25C9qoTm+e02Esi+aqTKSBYwVTaoS1wxcN47/Luqef57Vgp96xNANwt5npq9GDxsH7kXxNkJVEsWEOEaQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.55.1.tgz",
      "integrity": "sha512-+JiU7Jbp5cdxekIgdte0jfcu5oqw4GCKr6i3PJTlXTCU5H5Fvtkpbs4XJHRmWNXF+hKmn4v7ogI5OQPaupJgOg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.55.1.tgz",
      "integrity": "sha512-V5xC1tOVWtLLmr3YUk2f6EJK4qksksOYiz/TCsFHu/R+woubcLWdC9nZQmwjOAbmExBIVKsm1/wKmEy4z4u4Bw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.55.1.tgz",
      "integrity": "sha512-Rn3n+FUk2J5VWx+ywrG/HGPTD9jXNbicRtTM11e/uorplArnXZYsVifnPPqNNP5BsO3roI4n8332ukpY/zN7rQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.55.1.tgz",
      "integrity": "sha512-grPNWydeKtc1aEdrJDWk4opD7nFtQbMmV7769hiAaYyUKCT1faPRm2av8CX1YJsZ4TLAZcg9gTR1KvEzoLjXkg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.55.1.tgz",
      "integrity": "sha512-a59mwd1k6x8tXKcUxSyISiquLwB5pX+fJW9TkWU46lCqD/GRDe9uDN31jrMmVP3feI3mhAdvcCClhV8V5MhJFQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.55.1.tgz",
      "integrity": "sha512-puS1MEgWX5GsHSoiAsF0TYrpomdvkaXm0CofIMG5uVkP6IBV+ZO9xhC5YEN49nsgYo1DuuMquF9+7EDBVYu4uA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.55.1.tgz",
      "integrity": "sha512-r3Wv40in+lTsULSb6nnoudVbARdOwb2u5fpeoOAZjFLznp6tDU8kd+GTHmJoqZ9lt6/Sys33KdIHUaQihFcu7g==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-musl/-/rollup-linux-loong64-musl-4.55.1.tgz",
      "integrity": "sha512-MR8c0+UxAlB22Fq4R+aQSPBayvYa3+9DrwG/i1TKQXFYEaoW3B5b/rkSRIypcZDdWjWnpcvxbNaAJDcSbJU3Lw==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.55.1.tgz",
      "integrity": "sha512-3KhoECe1BRlSYpMTeVrD4sh2Pw2xgt4jzNSZIIPLFEsnQn9gAnZagW9+VqDqAHgm1Xc77LzJOo2LdigS5qZ+gw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-musl/-/rollup-linux-ppc64-musl-4.55.1.tgz",
      "integrity": "sha512-ziR1OuZx0vdYZZ30vueNZTg73alF59DicYrPViG0NEgDVN8/Jl87zkAPu4u6VjZST2llgEUjaiNl9JM6HH1Vdw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.55.1.tgz",
      "integrity": "sha512-uW0Y12ih2XJRERZ4jAfKamTyIHVMPQnTZcQjme2HMVDAHY4amf5u414OqNYC+x+LzRdRcnIG1YodLrrtA8xsxw==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.55.1.tgz",
      "integrity": "sha512-u9yZ0jUkOED1BFrqu3BwMQoixvGHGZ+JhJNkNKY/hyoEgOwlqKb62qu+7UjbPSHYjiVy8kKJHvXKv5coH4wDeg==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.55.1.tgz",
      "integrity": "sha512-/0PenBCmqM4ZUd0190j7J0UsQ/1nsi735iPRakO8iPciE7BQ495Y6msPzaOmvx0/pn+eJVVlZrNrSh4WSYLxNg==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-a8G4wiQxQG2BAvo+gU6XrReRRqj+pLS2NGXKm8io19goR+K8lw269eTrPkSdDTALwMmJp4th2Uh0D8J9bEV1vg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.55.1.tgz",
      "integrity": "sha512-bD+zjpFrMpP/hqkfEcnjXWHMw5BIghGisOKPj+2NaNDuVT+8Ds4mPf3XcPHuat1tz89WRL+1wbcxKY3WSbiT7w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openbsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openbsd-x64/-/rollup-openbsd-x64-4.55.1.tgz",
      "integrity": "sha512-eLXw0dOiqE4QmvikfQ6yjgkg/xDM+MdU9YJuP4ySTibXU0oAvnEWXt7UDJmD4UkYialMfOGFPJnIHSe/kdzPxg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.55.1.tgz",
      "integrity": "sha512-xzm44KgEP11te3S2HCSyYf5zIzWmx3n8HDCc7EE59+lTcswEWNpvMLfd9uJvVX8LCg9QWG67Xt75AuHn4vgsXw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.55.1.tgz",
      "integrity": "sha512-yR6Bl3tMC/gBok5cz/Qi0xYnVbIxGx5Fcf/ca0eB6/6JwOY+SRUcJfI0OpeTpPls7f194as62thCt/2BjxYN8g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.55.1.tgz",
      "integrity": "sha512-3fZBidchE0eY0oFZBnekYCfg+5wAB0mbpCBuofh5mZuzIU/4jIVkbESmd2dOsFNS78b53CYv3OAtwqkZZmU5nA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-gnu/-/rollup-win32-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-xGGY5pXj69IxKb4yv/POoocPy/qmEGhimy/FoTpTSVju3FYXUQQMFCaZZXJVidsmGxRioZAwpThl/4zX41gRKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.55.1.tgz",
      "integrity": "sha512-SPEpaL6DX4rmcXtnhdrQYgzQ5W2uW3SCJch88lB2zImhJRhIIK44fkUrgIV/Q8yUNfw5oyZ5vkeQsZLhCb06lw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@types/babel__core": {
      "version": "7.20.5",
      "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
      "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.20.7",
        "@babel/types": "^7.20.7",
        "@types/babel__generator": "*",
        "@types/babel__template": "*",
        "@types/babel__traverse": "*"
      }
    },
    "node_modules/@types/babel__generator": {
      "version": "7.27.0",
      "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.27.0.tgz",
      "integrity": "sha512-ufFd2Xi92OAVPYsy+P4n7/U7e68fex0+Ee8gSG9KX7eo084CWiQ4sdxktvdl0bOPupXtVJPY19zk6EwWqUQ8lg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__template": {
      "version": "7.4.4",
      "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
      "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.1.0",
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__traverse": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.28.0.tgz",
      "integrity": "sha512-8PvcXf70gTDZBgt9ptxJ8elBeBjcLOAcOtoO/mPJjtji1+CdGbHgm77om1GrsPxsiE+uXIpNSK64UYaIwQXd4Q==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.2"
      }
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/geojson": {
      "version": "7946.0.16",
      "resolved": "https://registry.npmjs.org/@types/geojson/-/geojson-7946.0.16.tgz",
      "integrity": "sha512-6C8nqWur3j98U6+lXDfTUWIfgvZU+EumvpHKcYjujKH7woYyLj2sUmff0tRhrqM7BohUw7Pz3ZB1jj2gW9Fvmg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/leaflet": {
      "version": "1.9.21",
      "resolved": "https://registry.npmjs.org/@types/leaflet/-/leaflet-1.9.21.tgz",
      "integrity": "sha512-TbAd9DaPGSnzp6QvtYngntMZgcRk+igFELwR2N99XZn7RXUdKgsXMR+28bUO0rPsWp8MIu/f47luLIQuSLYv/w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/geojson": "*"
      }
    },
    "node_modules/@types/parse-json": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/@types/parse-json/-/parse-json-4.0.2.tgz",
      "integrity": "sha512-dISoDXWWQwUquiKsyZ4Ng+HX2KsPL7LyHKHQwgGFEA3IaKac4Obd+h2a/a6waisAoepJlBcx9paWqjA8/HVjCw==",
      "license": "MIT"
    },
    "node_modules/@types/prop-types": {
      "version": "15.7.15",
      "resolved": "https://registry.npmjs.org/@types/prop-types/-/prop-types-15.7.15.tgz",
      "integrity": "sha512-F6bEyamV9jKGAFBEmlQnesRPGOQqS2+Uwi0Em15xenOxHaf2hv6L8YCVn3rPdPJOiJfPiCnLIRyvwVaqMY3MIw==",
      "license": "MIT"
    },
    "node_modules/@types/react": {
      "version": "19.2.8",
      "resolved": "https://registry.npmjs.org/@types/react/-/react-19.2.8.tgz",
      "integrity": "sha512-3MbSL37jEchWZz2p2mjntRZtPt837ij10ApxKfgmXCTuHWagYg7iA5bqPw6C8BMPfwidlvfPI/fxOc42HLhcyg==",
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "csstype": "^3.2.2"
      }
    },
    "node_modules/@types/react-transition-group": {
      "version": "4.4.12",
      "resolved": "https://registry.npmjs.org/@types/react-transition-group/-/react-transition-group-4.4.12.tgz",
      "integrity": "sha512-8TV6R3h2j7a91c+1DXdJi3Syo69zzIZbz7Lg5tORM5LEJG7X/E6a1V3drRyBRZq7/utz7A+c4OgYLiLcYGHG6w==",
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "*"
      }
    },
    "node_modules/@vitejs/plugin-react": {
      "version": "4.7.0",
      "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-4.7.0.tgz",
      "integrity": "sha512-gUu9hwfWvvEDBBmgtAowQCojwZmJ5mcLn3aufeCsitijs3+f2NsrPtlAWIR6OPiqljl96GVCUbLe0HyqIpVaoA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/core": "^7.28.0",
        "@babel/plugin-transform-react-jsx-self": "^7.27.1",
        "@babel/plugin-transform-react-jsx-source": "^7.27.1",
        "@rolldown/pluginutils": "1.0.0-beta.27",
        "@types/babel__core": "^7.20.5",
        "react-refresh": "^0.17.0"
      },
      "engines": {
        "node": "^14.18.0 || >=16.0.0"
      },
      "peerDependencies": {
        "vite": "^4.2.0 || ^5.0.0 || ^6.0.0 || ^7.0.0"
      }
    },
    "node_modules/babel-plugin-macros": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/babel-plugin-macros/-/babel-plugin-macros-3.1.0.tgz",
      "integrity": "sha512-Cg7TFGpIr01vOQNODXOOaGz2NpCU5gl8x1qJFbb6hbZxR7XrcE2vtbAsTAbJ7/xwJtUuJEw8K8Zr/AE0LHlesg==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.12.5",
        "cosmiconfig": "^7.0.0",
        "resolve": "^1.19.0"
      },
      "engines": {
        "node": ">=10",
        "npm": ">=6"
      }
    },
    "node_modules/baseline-browser-mapping": {
      "version": "2.9.14",
      "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.9.14.tgz",
      "integrity": "sha512-B0xUquLkiGLgHhpPBqvl7GWegWBUNuujQ6kXd/r1U38ElPT6Ok8KZ8e+FpUGEc2ZoRQUzq/aUnaKFc/svWUGSg==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "baseline-browser-mapping": "dist/cli.js"
      }
    },
    "node_modules/browserslist": {
      "version": "4.28.1",
      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.28.1.tgz",
      "integrity": "sha512-ZC5Bd0LgJXgwGqUknZY/vkUQ04r8NXnJZ3yYi4vDmSiZmC/pdSN0NbNRPxZpbtO4uAfDUAFffO8IZoM3Gj8IkA==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "baseline-browser-mapping": "^2.9.0",
        "caniuse-lite": "^1.0.30001759",
        "electron-to-chromium": "^1.5.263",
        "node-releases": "^2.0.27",
        "update-browserslist-db": "^1.2.0"
      },
      "bin": {
        "browserslist": "cli.js"
      },
      "engines": {
        "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
      }
    },
    "node_modules/callsites": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/callsites/-/callsites-3.1.0.tgz",
      "integrity": "sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==",
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/caniuse-lite": {
      "version": "1.0.30001764",
      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001764.tgz",
      "integrity": "sha512-9JGuzl2M+vPL+pz70gtMF9sHdMFbY9FJaQBi186cHKH3pSzDvzoUJUPV6fqiKIMyXbud9ZLg4F3Yza1vJ1+93g==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "CC-BY-4.0"
    },
    "node_modules/clsx": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/clsx/-/clsx-2.1.1.tgz",
      "integrity": "sha512-eYm0QWBtUrBWZWG0d386OGAw16Z995PiOVo2B7bjWSbHedGl5e0ZWaq65kOGgUSNesEIDkB9ISbTg/JK9dhCZA==",
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/convert-source-map": {
      "version": "1.9.0",
      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-1.9.0.tgz",
      "integrity": "sha512-ASFBup0Mz1uyiIjANan1jzLQami9z1PoYSZCiiYW2FczPbenXc45FZdBZLzOT+r6+iciuEModtmCti+hjaAk0A==",
      "license": "MIT"
    },
    "node_modules/cosmiconfig": {
      "version": "7.1.0",
      "resolved": "https://registry.npmjs.org/cosmiconfig/-/cosmiconfig-7.1.0.tgz",
      "integrity": "sha512-AdmX6xUzdNASswsFtmwSt7Vj8po9IuqXm0UXz7QKPuEUmPB4XyjGfaAr2PSuELMwkRMVH1EpIkX5bTZGRB3eCA==",
      "license": "MIT",
      "dependencies": {
        "@types/parse-json": "^4.0.0",
        "import-fresh": "^3.2.1",
        "parse-json": "^5.0.0",
        "path-type": "^4.0.0",
        "yaml": "^1.10.0"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/csstype": {
      "version": "3.2.3",
      "resolved": "https://registry.npmjs.org/csstype/-/csstype-3.2.3.tgz",
      "integrity": "sha512-z1HGKcYy2xA8AGQfwrn0PAy+PB7X/GSj3UVJW9qKyn43xWa+gl5nXmU4qqLMRzWVLFC8KusUX8T/0kCiOYpAIQ==",
      "license": "MIT"
    },
    "node_modules/debug": {
      "version": "4.4.3",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
      "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
      "license": "MIT",
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/dom-helpers": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/dom-helpers/-/dom-helpers-5.2.1.tgz",
      "integrity": "sha512-nRCa7CK3VTrM2NmGkIy4cbK7IZlgBE/PYMn55rrXefr5xXDP0LdtfPnblFDoVdcAfslJ7or6iqAUnx0CCGIWQA==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.8.7",
        "csstype": "^3.0.2"
      }
    },
    "node_modules/electron-to-chromium": {
      "version": "1.5.267",
      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.267.tgz",
      "integrity": "sha512-0Drusm6MVRXSOJpGbaSVgcQsuB4hEkMpHXaVstcPmhu5LIedxs1xNK/nIxmQIU/RPC0+1/o0AVZfBTkTNJOdUw==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/error-ex": {
      "version": "1.3.4",
      "resolved": "https://registry.npmjs.org/error-ex/-/error-ex-1.3.4.tgz",
      "integrity": "sha512-sqQamAnR14VgCr1A618A3sGrygcpK+HEbenA/HiEAkkUwcZIIB/tgWqHFxWgOyDh4nB4JCRimh79dR5Ywc9MDQ==",
      "license": "MIT",
      "dependencies": {
        "is-arrayish": "^0.2.1"
      }
    },
    "node_modules/esbuild": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=12"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.21.5",
        "@esbuild/android-arm": "0.21.5",
        "@esbuild/android-arm64": "0.21.5",
        "@esbuild/android-x64": "0.21.5",
        "@esbuild/darwin-arm64": "0.21.5",
        "@esbuild/darwin-x64": "0.21.5",
        "@esbuild/freebsd-arm64": "0.21.5",
        "@esbuild/freebsd-x64": "0.21.5",
        "@esbuild/linux-arm": "0.21.5",
        "@esbuild/linux-arm64": "0.21.5",
        "@esbuild/linux-ia32": "0.21.5",
        "@esbuild/linux-loong64": "0.21.5",
        "@esbuild/linux-mips64el": "0.21.5",
        "@esbuild/linux-ppc64": "0.21.5",
        "@esbuild/linux-riscv64": "0.21.5",
        "@esbuild/linux-s390x": "0.21.5",
        "@esbuild/linux-x64": "0.21.5",
        "@esbuild/netbsd-x64": "0.21.5",
        "@esbuild/openbsd-x64": "0.21.5",
        "@esbuild/sunos-x64": "0.21.5",
        "@esbuild/win32-arm64": "0.21.5",
        "@esbuild/win32-ia32": "0.21.5",
        "@esbuild/win32-x64": "0.21.5"
      }
    },
    "node_modules/escalade": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/escape-string-regexp": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/escape-string-regexp/-/escape-string-regexp-4.0.0.tgz",
      "integrity": "sha512-TtpcNJ3XAzx3Gq8sWRzJaVajRs0uVxA2YAkdb1jm2YkPz4G6egUFAyA3n5vtEIZefPk5Wa4UXbKuS5fKkJWdgA==",
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/find-root": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/find-root/-/find-root-1.1.0.tgz",
      "integrity": "sha512-NKfW6bec6GfKc0SGx1e07QZY9PE99u0Bft/0rzSD5k3sO/vwkVUpDUKVm5Gpp5Ue3YfShPFTX2070tDs5kB9Ng==",
      "license": "MIT"
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/gensync": {
      "version": "1.0.0-beta.2",
      "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
      "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "license": "MIT",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/hoist-non-react-statics": {
      "version": "3.3.2",
      "resolved": "https://registry.npmjs.org/hoist-non-react-statics/-/hoist-non-react-statics-3.3.2.tgz",
      "integrity": "sha512-/gGivxi8JPKWNm/W0jSmzcMPpfpPLc3dY/6GxhX2hQ9iGj3aDfklV4ET7NjKpSinLpJ5vafa9iiGIEZg10SfBw==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "react-is": "^16.7.0"
      }
    },
    "node_modules/hoist-non-react-statics/node_modules/react-is": {
      "version": "16.13.1",
      "resolved": "https://registry.npmjs.org/react-is/-/react-is-16.13.1.tgz",
      "integrity": "sha512-24e6ynE2H+OKt4kqsOvNd8kBpV65zoxbA4BVsEOB3ARVWQki/DHzaUoC5KuON/BiccDaCCTZBuOcfZs70kR8bQ==",
      "license": "MIT"
    },
    "node_modules/import-fresh": {
      "version": "3.3.1",
      "resolved": "https://registry.npmjs.org/import-fresh/-/import-fresh-3.3.1.tgz",
      "integrity": "sha512-TR3KfrTZTYLPB6jUjfx6MF9WcWrHL9su5TObK4ZkYgBdWKPOFoSoQIdEuTuR82pmtxH2spWG9h6etwfr1pLBqQ==",
      "license": "MIT",
      "dependencies": {
        "parent-module": "^1.0.0",
        "resolve-from": "^4.0.0"
      },
      "engines": {
        "node": ">=6"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/is-arrayish": {
      "version": "0.2.1",
      "resolved": "https://registry.npmjs.org/is-arrayish/-/is-arrayish-0.2.1.tgz",
      "integrity": "sha512-zz06S8t0ozoDXMG+ube26zeCTNXcKIPJZJi8hBrF4idCLms4CG9QtK7qBl1boi5ODzFpjswb5JPmHCbMpjaYzg==",
      "license": "MIT"
    },
    "node_modules/is-core-module": {
      "version": "2.16.1",
      "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.16.1.tgz",
      "integrity": "sha512-UfoeMA6fIJ8wTYFEUjelnaGI67v6+N7qXJEvQuIGa99l4xsCruSYOVSQ0uPANn4dAzm8lkYPaKLrrijLq7x23w==",
      "license": "MIT",
      "dependencies": {
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/js-tokens": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
      "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==",
      "license": "MIT"
    },
    "node_modules/jsesc": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.1.0.tgz",
      "integrity": "sha512-/sM3dO2FOzXjKQhJuo0Q173wf2KOo8t4I8vHy6lF9poUp7bKT0/NHE8fPX23PwfhnykfqnC2xRxOnVw5XuGIaA==",
      "license": "MIT",
      "bin": {
        "jsesc": "bin/jsesc"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/json-parse-even-better-errors": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/json-parse-even-better-errors/-/json-parse-even-better-errors-2.3.1.tgz",
      "integrity": "sha512-xyFwyhro/JEof6Ghe2iz2NcXoj2sloNsWr/XsERDK/oiPCfaNhl5ONfp+jQdAZRQQ0IJWNzH9zIZF7li91kh2w==",
      "license": "MIT"
    },
    "node_modules/json5": {
      "version": "2.2.3",
      "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
      "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "json5": "lib/cli.js"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/leaflet": {
      "version": "1.9.4",
      "resolved": "https://registry.npmjs.org/leaflet/-/leaflet-1.9.4.tgz",
      "integrity": "sha512-nxS1ynzJOmOlHp+iL3FyWqK89GtNL8U8rvlMOsQdTTssxZwCXh8N2NB3GDQOL+YR3XnWyZAxwQixURb+FA74PA==",
      "license": "BSD-2-Clause"
    },
    "node_modules/lines-and-columns": {
      "version": "1.2.4",
      "resolved": "https://registry.npmjs.org/lines-and-columns/-/lines-and-columns-1.2.4.tgz",
      "integrity": "sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==",
      "license": "MIT"
    },
    "node_modules/loose-envify": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/loose-envify/-/loose-envify-1.4.0.tgz",
      "integrity": "sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==",
      "license": "MIT",
      "dependencies": {
        "js-tokens": "^3.0.0 || ^4.0.0"
      },
      "bin": {
        "loose-envify": "cli.js"
      }
    },
    "node_modules/lru-cache": {
      "version": "5.1.1",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
      "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "yallist": "^3.0.2"
      }
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/node-releases": {
      "version": "2.0.27",
      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.27.tgz",
      "integrity": "sha512-nmh3lCkYZ3grZvqcCH+fjmQ7X+H0OeZgP40OierEaAptX4XofMh5kwNbWh7lBduUzCcV/8kZ+NDLCwm2iorIlA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/object-assign": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/object-assign/-/object-assign-4.1.1.tgz",
      "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/parent-module": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
      "integrity": "sha512-GQ2EWRpQV8/o+Aw8YqtfZZPfNRWZYkbidE9k5rpl/hC3vtHHBfGm2Ifi6qWV+coDGkrUKZAxE3Lot5kcsRlh+g==",
      "license": "MIT",
      "dependencies": {
        "callsites": "^3.0.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/parse-json": {
      "version": "5.2.0",
      "resolved": "https://registry.npmjs.org/parse-json/-/parse-json-5.2.0.tgz",
      "integrity": "sha512-ayCKvm/phCGxOkYRSCM82iDwct8/EonSEgCSxWxD7ve6jHggsFl4fZVQBPRNgQoKiuV/odhFrGzQXZwbifC8Rg==",
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.0.0",
        "error-ex": "^1.3.1",
        "json-parse-even-better-errors": "^2.3.0",
        "lines-and-columns": "^1.1.6"
      },
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/path-parse": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/path-parse/-/path-parse-1.0.7.tgz",
      "integrity": "sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==",
      "license": "MIT"
    },
    "node_modules/path-type": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/path-type/-/path-type-4.0.0.tgz",
      "integrity": "sha512-gDKb8aZMDeD/tZWs9P6+q0J9Mwkdl6xMV8TjnGP3qJVJ06bdMgkbBlLU8IdfOsIsFz2BW1rNVT3XuNEl8zPAvw==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "license": "ISC"
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/prop-types": {
      "version": "15.8.1",
      "resolved": "https://registry.npmjs.org/prop-types/-/prop-types-15.8.1.tgz",
      "integrity": "sha512-oj87CgZICdulUohogVAR7AjlC0327U4el4L6eAvOqCeudMDVU0NThNaV+b9Df4dXgSP1gXMTnPdhfe/2qDH5cg==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.4.0",
        "object-assign": "^4.1.1",
        "react-is": "^16.13.1"
      }
    },
    "node_modules/prop-types/node_modules/react-is": {
      "version": "16.13.1",
      "resolved": "https://registry.npmjs.org/react-is/-/react-is-16.13.1.tgz",
      "integrity": "sha512-24e6ynE2H+OKt4kqsOvNd8kBpV65zoxbA4BVsEOB3ARVWQki/DHzaUoC5KuON/BiccDaCCTZBuOcfZs70kR8bQ==",
      "license": "MIT"
    },
    "node_modules/react": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react/-/react-18.3.1.tgz",
      "integrity": "sha512-wS+hAgJShR0KhEvPJArfuPVN1+Hz1t0Y6n5jLrGQbkb4urgPE/0Rve+1kMB1v/oWgHgm4WIcV+i7F2pTVj+2iQ==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.1.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-dom": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-18.3.1.tgz",
      "integrity": "sha512-5m4nQKp+rZRb09LNH59GM4BxTh9251/ylbKIbpe7TpGxfJ+9kv6BLkLBXIjjspbgbnIBNqlI23tRnTWT0snUIw==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.1.0",
        "scheduler": "^0.23.2"
      },
      "peerDependencies": {
        "react": "^18.3.1"
      }
    },
    "node_modules/react-is": {
      "version": "19.2.3",
      "resolved": "https://registry.npmjs.org/react-is/-/react-is-19.2.3.tgz",
      "integrity": "sha512-qJNJfu81ByyabuG7hPFEbXqNcWSU3+eVus+KJs+0ncpGfMyYdvSmxiJxbWR65lYi1I+/0HBcliO029gc4F+PnA==",
      "license": "MIT"
    },
    "node_modules/react-leaflet": {
      "version": "4.2.1",
      "resolved": "https://registry.npmjs.org/react-leaflet/-/react-leaflet-4.2.1.tgz",
      "integrity": "sha512-p9chkvhcKrWn/H/1FFeVSqLdReGwn2qmiobOQGO3BifX+/vV/39qhY8dGqbdcPh1e6jxh/QHriLXr7a4eLFK4Q==",
      "license": "Hippocratic-2.1",
      "dependencies": {
        "@react-leaflet/core": "^2.1.0"
      },
      "peerDependencies": {
        "leaflet": "^1.9.0",
        "react": "^18.0.0",
        "react-dom": "^18.0.0"
      }
    },
    "node_modules/react-refresh": {
      "version": "0.17.0",
      "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.17.0.tgz",
      "integrity": "sha512-z6F7K9bV85EfseRCp2bzrpyQ0Gkw1uLoCel9XBVWPg/TjRj94SkJzUTGfOa4bs7iJvBWtQG0Wq7wnI0syw3EBQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-router": {
      "version": "6.30.3",
      "resolved": "https://registry.npmjs.org/react-router/-/react-router-6.30.3.tgz",
      "integrity": "sha512-XRnlbKMTmktBkjCLE8/XcZFlnHvr2Ltdr1eJX4idL55/9BbORzyZEaIkBFDhFGCEWBBItsVrDxwx3gnisMitdw==",
      "license": "MIT",
      "dependencies": {
        "@remix-run/router": "1.23.2"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8"
      }
    },
    "node_modules/react-router-dom": {
      "version": "6.30.3",
      "resolved": "https://registry.npmjs.org/react-router-dom/-/react-router-dom-6.30.3.tgz",
      "integrity": "sha512-pxPcv1AczD4vso7G4Z3TKcvlxK7g7TNt3/FNGMhfqyntocvYKj+GCatfigGDjbLozC4baguJ0ReCigoDJXb0ag==",
      "license": "MIT",
      "dependencies": {
        "@remix-run/router": "1.23.2",
        "react-router": "6.30.3"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8",
        "react-dom": ">=16.8"
      }
    },
    "node_modules/react-transition-group": {
      "version": "4.4.5",
      "resolved": "https://registry.npmjs.org/react-transition-group/-/react-transition-group-4.4.5.tgz",
      "integrity": "sha512-pZcd1MCJoiKiBR2NRxeCRg13uCXbydPnmB4EOeRrY7480qNWO8IIgQG6zlDkm6uRMsURXPuKq0GWtiM59a5Q6g==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "@babel/runtime": "^7.5.5",
        "dom-helpers": "^5.0.1",
        "loose-envify": "^1.4.0",
        "prop-types": "^15.6.2"
      },
      "peerDependencies": {
        "react": ">=16.6.0",
        "react-dom": ">=16.6.0"
      }
    },
    "node_modules/reselect": {
      "version": "4.1.8",
      "resolved": "https://registry.npmjs.org/reselect/-/reselect-4.1.8.tgz",
      "integrity": "sha512-ab9EmR80F/zQTMNeneUr4cv+jSwPJgIlvEmVwLerwrWVbpLlBuls9XHzIeTFy4cegU2NHBp3va0LKOzU5qFEYQ==",
      "license": "MIT"
    },
    "node_modules/resolve": {
      "version": "1.22.11",
      "resolved": "https://registry.npmjs.org/resolve/-/resolve-1.22.11.tgz",
      "integrity": "sha512-RfqAvLnMl313r7c9oclB1HhUEAezcpLjz95wFH4LVuhk9JF/r22qmVP9AMmOU4vMX7Q8pN8jwNg/CSpdFnMjTQ==",
      "license": "MIT",
      "dependencies": {
        "is-core-module": "^2.16.1",
        "path-parse": "^1.0.7",
        "supports-preserve-symlinks-flag": "^1.0.0"
      },
      "bin": {
        "resolve": "bin/resolve"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/resolve-from": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/resolve-from/-/resolve-from-4.0.0.tgz",
      "integrity": "sha512-pb/MYmXstAkysRFx8piNI1tGFNQIFA3vkE3Gq4EuA1dF6gHp/+vgZqsCGJapvy8N3Q+4o7FwvquPJcnZ7RYy4g==",
      "license": "MIT",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/rollup": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.55.1.tgz",
      "integrity": "sha512-wDv/Ht1BNHB4upNbK74s9usvl7hObDnvVzknxqY/E/O3X6rW1U1rV1aENEfJ54eFZDTNo7zv1f5N4edCluH7+A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.55.1",
        "@rollup/rollup-android-arm64": "4.55.1",
        "@rollup/rollup-darwin-arm64": "4.55.1",
        "@rollup/rollup-darwin-x64": "4.55.1",
        "@rollup/rollup-freebsd-arm64": "4.55.1",
        "@rollup/rollup-freebsd-x64": "4.55.1",
        "@rollup/rollup-linux-arm-gnueabihf": "4.55.1",
        "@rollup/rollup-linux-arm-musleabihf": "4.55.1",
        "@rollup/rollup-linux-arm64-gnu": "4.55.1",
        "@rollup/rollup-linux-arm64-musl": "4.55.1",
        "@rollup/rollup-linux-loong64-gnu": "4.55.1",
        "@rollup/rollup-linux-loong64-musl": "4.55.1",
        "@rollup/rollup-linux-ppc64-gnu": "4.55.1",
        "@rollup/rollup-linux-ppc64-musl": "4.55.1",
        "@rollup/rollup-linux-riscv64-gnu": "4.55.1",
        "@rollup/rollup-linux-riscv64-musl": "4.55.1",
        "@rollup/rollup-linux-s390x-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-musl": "4.55.1",
        "@rollup/rollup-openbsd-x64": "4.55.1",
        "@rollup/rollup-openharmony-arm64": "4.55.1",
        "@rollup/rollup-win32-arm64-msvc": "4.55.1",
        "@rollup/rollup-win32-ia32-msvc": "4.55.1",
        "@rollup/rollup-win32-x64-gnu": "4.55.1",
        "@rollup/rollup-win32-x64-msvc": "4.55.1",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/scheduler": {
      "version": "0.23.2",
      "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.23.2.tgz",
      "integrity": "sha512-UOShsPwz7NrMUqhR6t0hWjFduvOzbtv7toDH1/hIrfRNIDBnnBWd0CwJTGvTpngVlmwGCdP9/Zl/tVrDqcuYzQ==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.1.0"
      }
    },
    "node_modules/semver": {
      "version": "6.3.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
      "dev": true,
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      }
    },
    "node_modules/source-map": {
      "version": "0.5.7",
      "resolved": "https://registry.npmjs.org/source-map/-/source-map-0.5.7.tgz",
      "integrity": "sha512-LbrmJOMUSdEVxIKvdcJzQC+nQhe8FUZQTXQy6+I75skNgn3OoQ0DZA8YnFa7gp8tqtL3KPf1kmo0R5DoApeSGQ==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "dev": true,
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/stylis": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/stylis/-/stylis-4.2.0.tgz",
      "integrity": "sha512-Orov6g6BB1sDfYgzWfTHDOxamtX1bE/zo104Dh9e6fqJ3PooipYyfJ0pUmrZO2wAvO8YbEyeFrkV91XTsGMSrw==",
      "license": "MIT"
    },
    "node_modules/supports-preserve-symlinks-flag": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz",
      "integrity": "sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/typescript": {
      "version": "5.9.3",
      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.9.3.tgz",
      "integrity": "sha512-jl1vZzPDinLr9eUt3J/t7V6FgNEw9QjvBPdysz9KfQDD41fQrC2Y4vKQdiaUpFT4bXlb1RHhLpp8wtm6M5TgSw==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "tsc": "bin/tsc",
        "tsserver": "bin/tsserver"
      },
      "engines": {
        "node": ">=14.17"
      }
    },
    "node_modules/update-browserslist-db": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.2.3.tgz",
      "integrity": "sha512-Js0m9cx+qOgDxo0eMiFGEueWztz+d4+M3rGlmKPT+T4IS/jP4ylw3Nwpu6cpTTP8R1MAC1kF4VbdLt3ARf209w==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "escalade": "^3.2.0",
        "picocolors": "^1.1.1"
      },
      "bin": {
        "update-browserslist-db": "cli.js"
      },
      "peerDependencies": {
        "browserslist": ">= 4.21.0"
      }
    },
    "node_modules/vite": {
      "version": "5.4.21",
      "resolved": "https://registry.npmjs.org/vite/-/vite-5.4.21.tgz",
      "integrity": "sha512-o5a9xKjbtuhY6Bi5S3+HvbRERmouabWbyUcpXXUA1u+GNUKoROi9byOJ8M0nHbHYHkYICiMlqxkg1KkYmm25Sw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "esbuild": "^0.21.3",
        "postcss": "^8.4.43",
        "rollup": "^4.20.0"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^18.0.0 || >=20.0.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^18.0.0 || >=20.0.0",
        "less": "*",
        "lightningcss": "^1.21.0",
        "sass": "*",
        "sass-embedded": "*",
        "stylus": "*",
        "sugarss": "*",
        "terser": "^5.4.0"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        }
      }
    },
    "node_modules/yallist": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
      "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/yaml": {
      "version": "1.10.2",
      "resolved": "https://registry.npmjs.org/yaml/-/yaml-1.10.2.tgz",
      "integrity": "sha512-r3vXyErRCYJ7wg28yvBY5VSoAF8ZvlcW9/BwUzEtUsjvX/DKs24dIkuwjtuprwJJHsbyUbLApepYTR1BN4uHrg==",
      "license": "ISC",
      "engines": {
        "node": ">= 6"
      }
    }
  }
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\src\api.ts
const base = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8090'
const trackingBase = import.meta.env.VITE_TRACKING_BASE_URL || 'http://localhost:8087'

function authHeaders() {
  const t = localStorage.getItem('access_token') || ''
  return t ? { Authorization: `Bearer ${t}` } : {}
}

export async function getTrips(params: Record<string, string>) {
  const qp = new URLSearchParams(params)
  const r = await fetch(`${base}/trips?${qp.toString()}`, { headers: { ...authHeaders() } })
  return r.json()
}

export async function getTripDetails(id: string) {
  const r = await fetch(`${base}/trips/${id}`, { headers: { ...authHeaders() } })
  return r.json()
}

export async function getDelays(hours: number) {
  const r = await fetch(`${base}/delays?hours=${hours}`, { headers: { ...authHeaders() } })
  return r.json()
}

export async function searchRefs(type: string, q: string) {
  const r = await fetch(`${base}/references/${type}?q=${encodeURIComponent(q)}`, { headers: { ...authHeaders() } })
  return r.json()
}

export async function reassignTrip(id: string, newCarrierId: string, reason: string, operatorId: string) {
  const r = await fetch(`${base}/trips/${id}/reassign`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ new_carrier_id: newCarrierId, reason, operator_id: operatorId })
  })
  return r.ok
}

export async function getCarrierLocations() {
  const r = await fetch(`${trackingBase}/locations`)
  return r.json()
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\src\App.tsx
import { Container, AppBar, Toolbar, Typography } from '@mui/material'
import { Outlet, Link } from 'react-router-dom'

export default function App() {
  return (
    <>
      <AppBar position="static">
        <Toolbar>
          <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
            BelParcel Operator Panel
          </Typography>
          <Link to="/" style={{ color: '#fff', textDecoration: 'none', marginRight: 16 }}>Р РµР№СЃС‹</Link>
          <Link to="/map" style={{ color: '#fff', textDecoration: 'none' }}>РљР°СЂС‚Р°</Link>
        </Toolbar>
      </AppBar>
      <Container sx={{ mt: 2 }}>
        <Outlet />
      </Container>
    </>
  )
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\src\main.tsx
import React from 'react'
import { createRoot } from 'react-dom/client'
import { BrowserRouter, Routes, Route } from 'react-router-dom'
import App from './App'
import Trips from './pages/Trips'
import TripDetails from './pages/TripDetails'
import MapPage from './pages/Map'

const root = createRoot(document.getElementById('root')!)
root.render(
  <BrowserRouter>
    <Routes>
      <Route path="/" element={<App />}>
        <Route index element={<Trips />} />
        <Route path="/trips/:tripId" element={<TripDetails />} />
        <Route path="/map" element={<MapPage />} />
      </Route>
    </Routes>
  </BrowserRouter>
)

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\src\pages\Map.tsx
import { useEffect, useState, useRef } from 'react'
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet'
import 'leaflet/dist/leaflet.css'
import { getCarrierLocations } from '../api'

type Location = {
  trip_id: string
  lat: number
  lng: number
  updated_at: string
}

export default function MapPage() {
  const [locations, setLocations] = useState<Location[]>([])
  const wsRef = useRef<WebSocket | null>(null)

  async function load() {
    const data = await getCarrierLocations()
    setLocations(Array.isArray(data) ? data : [])
  }

  useEffect(() => {
    load()
    const base = import.meta.env.VITE_TRACKING_WS_URL || (import.meta.env.VITE_TRACKING_BASE_URL || 'http://localhost:8087').replace('http', 'ws') + '/ws/locations'
    const ws = new WebSocket(base)
    wsRef.current = ws
    ws.onmessage = (ev) => {
      try {
        const msg = JSON.parse(ev.data)
        setLocations(prev => {
          const idx = prev.findIndex(p => p.trip_id === msg.trip_id)
          const item = { trip_id: msg.trip_id, lat: msg.lat, lng: msg.lng, updated_at: msg.timestamp }
          if (idx >= 0) {
            const next = prev.slice()
            next[idx] = item
            return next
          }
          return [...prev, item]
        })
      } catch {}
    }
    ws.onerror = () => {}
    return () => {
      ws.close()
    }
  }, [])

  return (
    <div style={{ height: '80vh', width: '100%' }}>
      <MapContainer center={[53.9, 27.5667]} zoom={11} style={{ height: '100%', width: '100%' }}>
        <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
        {locations.map(loc => (
          <Marker key={loc.trip_id} position={[loc.lat, loc.lng]}>
            <Popup>
              Р РµР№СЃ: {loc.trip_id}
              <br />
              РћР±РЅРѕРІР»РµРЅРѕ: {new Date(loc.updated_at).toLocaleString('ru-RU')}
            </Popup>
          </Marker>
        ))}
      </MapContainer>
    </div>
  )
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\src\pages\TripDetails.tsx
import { useEffect, useState } from 'react'
import { useParams, useNavigate } from 'react-router-dom'
import { Box, Typography, TextField, Button } from '@mui/material'
import { getTripDetails, searchRefs, reassignTrip } from '../api'

export default function TripDetails() {
  const { tripId } = useParams()
  const [details, setDetails] = useState<any>(null)
  const [carrierQ, setCarrierQ] = useState('')
  const [carriers, setCarriers] = useState<any[]>([])
  const [newCarrier, setNewCarrier] = useState('')
  const [reason, setReason] = useState('')
  const navigate = useNavigate()

  async function load() {
    if (!tripId) return
    const d = await getTripDetails(tripId)
    setDetails(d)
  }

  useEffect(() => { load() }, [tripId])

  async function findCarriers() {
    const res = await searchRefs('carriers', carrierQ)
    setCarriers(res)
  }

  async function submit() {
    if (!tripId || !newCarrier || !reason) return
    const ok = await reassignTrip(tripId, newCarrier, reason, 'operator_1')
    if (ok) navigate('/')
  }

  if (!details) return null

  return (
    <Box>
      <Typography variant="h6" sx={{ mb: 2 }}>Р РµР№СЃ {tripId}</Typography>
      <Typography>РЎС‚Р°С‚СѓСЃ: {details.trip.status}</Typography>
      <Typography>РЎРєР»Р°Рґ: {details.trip.origin_warehouse_id}</Typography>
      <Typography>РџР’Р—: {details.trip.pickup_point_id}</Typography>
      <Typography sx={{ mt: 2 }}>РџР°СЂС‚РёРё: {(details.batches || []).join(', ')}</Typography>
      <Typography>Р—Р°РєР°Р·С‹: {(details.orders || []).join(', ')}</Typography>
      <Box sx={{ mt: 3, display: 'flex', gap: 2 }}>
        <TextField label="РџРѕРёСЃРє РїРµСЂРµРІРѕР·С‡РёРєР°" value={carrierQ} onChange={e => setCarrierQ(e.target.value)} />
        <Button variant="outlined" onClick={findCarriers}>РќР°Р№С‚Рё</Button>
      </Box>
      <Box sx={{ mt: 2 }}>
        <TextField label="РќРѕРІС‹Р№ РїРµСЂРµРІРѕР·С‡РёРє ID" value={newCarrier} onChange={e => setNewCarrier(e.target.value)} sx={{ mr: 2 }} />
        {carriers.length > 0 && <Box sx={{ mb: 1 }}>
          <Typography>РќР°Р№РґРµРЅРѕ:</Typography>
          {carriers.map(c => (
            <Button key={c.id} size="small" sx={{ mr: 1, mb: 1 }} onClick={() => setNewCarrier(c.id)}>{c.name}</Button>
          ))}
        </Box>}
        <TextField label="РџСЂРёС‡РёРЅР°" value={reason} onChange={e => setReason(e.target.value)} sx={{ mr: 2 }} />
        <Button variant="contained" onClick={submit}>РџРµСЂРµРЅР°Р·РЅР°С‡РёС‚СЊ</Button>
      </Box>
    </Box>
  )
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\src\pages\Trips.tsx
import { useEffect, useState } from 'react'
import { DataGrid, GridColDef } from '@mui/x-data-grid'
import { Box, TextField, MenuItem, Button, Typography } from '@mui/material'
import { getTrips, getDelays } from '../api'
import { useNavigate } from 'react-router-dom'

type TripRow = {
  id: string
  origin_warehouse_id: string
  pickup_point_id: string
  carrier_id: string
  assigned_at: string
  status: string
}

export default function Trips() {
  const [rows, setRows] = useState<TripRow[]>([])
  const [status, setStatus] = useState('')
  const [pvz, setPvz] = useState('')
  const [carrier, setCarrier] = useState('')
  const [date, setDate] = useState('')
  const [delaysCount, setDelaysCount] = useState(0)
  const navigate = useNavigate()

  const cols: GridColDef[] = [
    { field: 'id', headerName: 'ID СЂРµР№СЃР°', width: 180 },
    { field: 'origin_warehouse_id', headerName: 'РЎРєР»Р°Рґ', width: 160 },
    { field: 'pickup_point_id', headerName: 'РџР’Р—', width: 160 },
    { field: 'carrier_id', headerName: 'РџРµСЂРµРІРѕР·С‡РёРє', width: 160 },
    { field: 'assigned_at', headerName: 'РќР°Р·РЅР°С‡РµРЅ', width: 180 },
    { field: 'status', headerName: 'РЎС‚Р°С‚СѓСЃ', width: 140 },
    {
      field: 'actions',
      headerName: 'Р”РµР№СЃС‚РІРёСЏ',
      sortable: false,
      width: 180,
      renderCell: p => (
        <Button variant="outlined" size="small" onClick={() => navigate(`/trips/${p.row.id}`)}>
          РџРµСЂРµРЅР°Р·РЅР°С‡РёС‚СЊ
        </Button>
      )
    }
  ]

  async function load() {
    const data = await getTrips({ status, pvz, carrier, date })
    setRows(data)
    const d = await getDelays(1.5)
    setDelaysCount(d.length || 0)
  }

  useEffect(() => { load() }, [])

  return (
    <Box>
      <Box sx={{ display: 'flex', gap: 2, mb: 2 }}>
        <TextField select label="РЎС‚Р°С‚СѓСЃ" value={status} onChange={e => setStatus(e.target.value)} sx={{ minWidth: 160 }}>
          <MenuItem value="">Р’СЃРµ</MenuItem>
          <MenuItem value="assigned">assigned</MenuItem>
          <MenuItem value="in_transit">in_transit</MenuItem>
          <MenuItem value="failed">failed</MenuItem>
        </TextField>
        <TextField label="РџР’Р—" value={pvz} onChange={e => setPvz(e.target.value)} />
        <TextField label="РџРµСЂРµРІРѕР·С‡РёРє" value={carrier} onChange={e => setCarrier(e.target.value)} />
        <TextField type="date" label="Р”Р°С‚Р°" InputLabelProps={{ shrink: true }} value={date} onChange={e => setDate(e.target.value)} />
        <Button variant="contained" onClick={load}>РџСЂРёРјРµРЅРёС‚СЊ</Button>
      </Box>
      <Typography color="error" sx={{ mb: 1 }}>
        Р’РЅРёРјР°РЅРёРµ: {delaysCount} СЂРµР№СЃР° РІ СЃС‚Р°С‚СѓСЃРµ "assigned" Р±РѕР»РµРµ 1.5 С‡Р°СЃРѕРІ.
      </Typography>
      <div style={{ height: 520, width: '100%' }}>
        <DataGrid rows={rows} columns={cols} getRowId={(r) => r.id} />
      </div>
    </Box>
  )
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "skipLibCheck": true
  }
}

<<< END FILE
>>> FILE C:\Users\loban_h3g0vgo\GolandProjects\Bel-parcel\web\operator-panel\vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173
  }
})

<<< END FILE
